sharepoint_vacc[,vx_text_product_name:=trimws(vx_text_product_name,"both")]
sharepoint_vacc[,Vaccine_description:=trimws(Vaccine_description,"both")]
sharepoint_vacc[!is.na(vx_text_product_name),product_name:=paste(Vaccine_description, vx_text_product_name, sep=" ")]
sharepoint_vacc[is.na(vx_text_product_name),product_name:=Vaccine_description]
sharepoint_vacc[,vx_text_product_name:=NULL][,Vaccine_description:=NULL]
####Check for dp proxies with wrong names(number of underscores) in sharepoint####
sharepoint_medicines[,number:=unlist(lapply(sharepoint_medicines[,Drug_abbreviation], function(x) str_count(x,"_")))]
sharepoint_vacc[,number:=unlist(lapply(sharepoint_vacc[,Vaccine_abbreviation], function(x) str_count(x,"_")))]
no_underscore_m<-data.table(sharepoint_medicines[number==0 | number>1, "Drug_abbreviation"], comment="This drug proxy has no underscore in the name or has more than one underscore. Fix the excel file sheet:CDM_Medicines.")
no_underscore_v<-data.table(sharepoint_vacc[number==0 | number>1, "Vaccine_abbreviation"], comment="This vaccine proxy has no underscore in the name or has more than one underscore. Fix the excel file sheet:CDM_Vaccines.")
setnames(no_underscore_v,"Vaccine_abbreviation","Drug_abbreviation")
no_underscore<-rbind(no_underscore_m,no_underscore_v)
no_underscore<-no_underscore[!is.na(Drug_abbreviation)]
if(no_underscore[,.N]>0){fwrite(no_underscore,paste0(projectFolder,"/g_output/Error_files/",format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"), "_", study_name, "_wrong_name_drug_proxy_excel.csv"), row.names = F)}
sharepoint_medicines<-sharepoint_medicines[number==1]
sharepoint_medicines[,number:=NULL]
sharepoint_vacc<-sharepoint_vacc[number==1]
sharepoint_vacc[,number:=NULL]
####Empty drug event subconcept####
empty_subconcept<-sharepoint_medicines[is.na(drug_event_subconcept)]
if(empty_subconcept[,.N]>0){
empty_subconcept<-data.table(empty_subconcept, comment="The event subconcept for this drug proxy is empty. Fix the excel file.")
fwrite(empty_subconcept,paste0(projectFolder,"/g_output/Error_files/", format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"), "_", study_name,"_empty_subconcept_drug_proxy_excel.csv"), row.names = F)
}
rm(empty_subconcept)
sharepoint_medicines<-sharepoint_medicines[!is.na(drug_event_subconcept)]
####Check for folders with wrong names(number of underscores)####
#Get names of folders present
folder_list<-list.files(dp_codelist_folder_link)
#Remove Algorithms from the folder list
folder_list<-folder_list[!folder_list %in% c("Algorithms","Document.docx") ]
#Count number of underscores and keep only those folders with 3 underscores
folder_list<-data.table(folder_list, number=unlist(lapply(folder_list, function(x) str_count(x,"_"))))
#export wrongly named folders
if(folder_list[number!=2,.N]>0){
folder_list_wrong<-folder_list[number!=2]
folder_list_wrong[,fault:="The number of underscores should be 2."]
if(!is.null(study_name)){
fwrite(folder_list_wrong, paste0(error_dir, format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"), "_", study_name, "_wrong_dp_proxy_folder_name.csv"), row.names = F)
} else {
fwrite(folder_list_wrong, paste0(error_dir, format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"), "_", "_wrong_dp_proxy_folder_name.csv"), row.names = F)
}
folder_list_wrong[,fault:=NULL]
} else {
folder_list_wrong<-NULL
}
####Remove folder with wrong name####
#Keep only folders with 3 underscores
folder_list<-folder_list[number==2, folder_list]
#Create variable name
drug_abbreviation<-unlist(lapply(folder_list, function(x) paste(unlist(str_split(x,"_"))[1:2], collapse="_")))
drug_event_subconcept<-unlist(lapply(folder_list, function(x) paste(unlist(str_split(x,"_"))[3], collapse="_")))
folder_list<-data.table(folder_list,
drug_abbreviation= drug_abbreviation,
drug_event_subconcept=drug_event_subconcept)
rm(folder_list_wrong)
####Check event folders that are mentioned as not mapped in sharepoint but are actually present in folders_list####
folder_list[,present_in_folders:=1]
setnames(sharepoint_medicines,"Drug_abbreviation",'drug_abbreviation')
not_mapped_folders_incons<-merge.data.table(sharepoint_medicines, folder_list[,.(drug_abbreviation, present_in_folders)], by="drug_abbreviation", all.x=T)
not_mapped_folders_incons<-not_mapped_folders_incons[is.na(present_in_folders)]
if(not_mapped_folders_incons[,.N]>0){
not_mapped_folders_incons[,present_in_folders:=NULL]
not_mapped_folders_incons[,comment:="This folder is mentioned in medicines sharepoint but has not been mapped."]
if(!is.null(study_name)){
fwrite(not_mapped_folders_incons, paste0(error_dir, format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"), "_", study_name, "_mapped_dp_folders_inconsistencies.csv"), row.names = F)
} else {
fwrite(not_mapped_folders_incons, paste0(error_dir, format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"), "_", "_mapped_dp_folders_inconsistencies.csv"), row.names = F)
}
}
#remove all not mapped folders from sharepoint
sharepoint_medicines<-sharepoint_medicines[!drug_abbreviation %in% not_mapped_folders_incons[,drug_abbreviation]]
rm(not_mapped_folders_incons)
folder_list[,present_in_folders:=NULL]
####Check if event folders are correct, export non correct ones####
#find wrong event folders
wrong_event_indicator<-list()
w<-1
for (wrong_index in 1:folder_list[,.N]){
#Check number of excel files inside folder
if(length(list.files(paste0(dp_codelist_folder_link,folder_list[wrong_index,folder_list],"/"), ".xls"))==1){
#Chcek if name of folder matches name of excel file
if (folder_list[wrong_index,drug_abbreviation] == unlist(strsplit(list.files(paste0(dp_codelist_folder_link,folder_list[wrong_index,folder_list],"/"), ".xls"),"[.]"))[1]){
#Check if name of excel sheet matches name of event folder
if (folder_list[wrong_index,drug_abbreviation] %in% excel_sheets(paste0(dp_codelist_folder_link,folder_list[wrong_index,folder_list],"/",list.files(paste0(dp_codelist_folder_link,folder_list[wrong_index,folder_list],"/"), ".xls")))){
#Check if all necessary columns are present
if (sum(!c("product_identifier", "code", "product_name", "tags") %in% tolower(colnames(as.data.table(read_excel(paste0(dp_codelist_folder_link,folder_list[wrong_index,folder_list],"/",list.files(paste0(dp_codelist_folder_link,folder_list[wrong_index,folder_list],"/"), ".xls")),
sheet= folder_list[wrong_index,drug_abbreviation], guess_max = 10000000, col_types = "text")))))==0){
wrong_event_indicator[[w]]<-cbind(folder_list[wrong_index,], fault=NA)
w<-w+1
} else{
wrong_event_indicator[[w]]<-cbind(folder_list[wrong_index,], fault="One or more neccessary columns are missing/misspelled in the excel file. The needed columns are: Coding system, Code, Code name, Concept, Concept name, Tags.")
w<-w+1
}
} else {
wrong_event_indicator[[w]]<-cbind(folder_list[wrong_index,], fault="Name of the excel sheet doesn't match with the name of the algorithm folder.")
w<-w+1
}
} else {
wrong_event_indicator[[w]]<-cbind(folder_list[wrong_index,], fault="Name of the excel file inside folder doesn't match with name of algorithm folder.")
w<-w+1
}
} else {
wrong_event_indicator[[w]]<-cbind(folder_list[wrong_index,], fault="More than one excel file or no excel file present in the algorithm folder.")
w<-w+1
}
}
#Combine information about event folder
wrong_event_indicator<-do.call(rbind,wrong_event_indicator)
wrong_event_indicator<-wrong_event_indicator[!is.na(fault)]
wrong_event_indicator
if(wrong_event_indicator[,.N]>0){
if(!is.null(study_name)){
fwrite(wrong_event_indicator, paste0(error_dir, format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"), "_", study_name, "_faulty_dp_folders.csv"), row.names = F)
} else {
fwrite(wrong_event_indicator, paste0(error_dir, format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"), "_", "_faulty_dp_folders.csv"), row.names = F)
}
}
#remove wrong folders
folder_list<-folder_list[!folder_list %in% wrong_event_indicator[,folder_list]]
folder_list
drug_proxy_codelist<-list()
for(i in 1:folder_list[,.N]){
#create path link
path<-paste0(dp_codelist_folder_link, folder_list[i,folder_list],"/")
file<-list.files(path,".xlsx")
a<-as.data.table(read_excel(paste0(path,file), sheet= folder_list[i,drug_abbreviation], guess_max = 10000000, col_types = "text"))
cols<-c("product_identifier","code","product_name","tags")
a<-a[,..cols]
a[,drug_abbreviation:=folder_list[i,drug_abbreviation]]
setcolorder(a,c("drug_abbreviation","product_identifier"))
#Check if the is a drug proxy or a vaccine proxy
a[,label:=paste(unlist(str_split(drug_abbreviation,"_"))[1],"proxy",sep="_")]
drug_proxy_codelist[[i]]<-a
rm(a)
}
drug_proxy_codelist<-rbindlist(drug_proxy_codelist,fill = T)
drug_proxy_codelist
sharepoint_medicines_clean<-sharepoint_medicines[,-c("drug_event_subconcept")]
sharepoint_vacc[,product_name:=NULL]
setnames(sharepoint_vacc,"Vaccine_abbreviation","drug_abbreviation")
sharepoint<-rbind(sharepoint_medicines,sharepoint_vacc,fill=T)
complete<-merge.data.table(drug_proxy_codelist,sharepoint_medicines, all.x=T, allow.cartesian = T, by="drug_abbreviation")
complete<-complete[ALL %in% c("Yes","yes","YES")]
complete<-complete[!tags %in% c("remove","removed","exclude","excluded")]
fwrite(complete[,c("drug_abbreviation","product_identifier","code","product_name","tags","label","drug_event_subconcept")],paste0(projectFolder,"/g_output/Codelists/",format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"), "_", study_name, "_drug_proxies_codelist.csv"), row.names = F)
fwrite(complete,paste0(projectFolder,"/g_output/Individual_data/",format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"), "_", study_name, "_drug_proxies_codelist.csv"), row.names = F)
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source(paste0(projectFolder, "/scripts/packages_codelist.R"))
source(paste0(projectFolder, "/scripts/create_output_folders.R"))
study_names <- 'ALL' #c("ROC12","CONSIGN")#c("Pfizer", "AZ","Moderna","J&J","ROC20","ROC12","CONSIGN")
########################################################################
for (study_name in study_names){
source(paste0(projectFolder, "/scripts/main_script.R"))
#source(paste0(projectFolder, "/scripts/additional_codelist_events_CPRD.R"))
#source(paste0(projectFolder, "/scripts/additional_codelist_drugs_CPRD.R")) not needed
}
source(paste0(projectFolder, "/scripts/crosscheck_script.R"))
list_of_studies<-c("Pfizer",
"Pfizer_Myo",
"AZ",
"Moderna",
"Moderna_Myo",
"J&J",
"ROC20",
"CONSIGN",
"EMA_ROC11_CONSIGN",
"EMA_ROC12_effectiveness",
"Conception",
"ConcePTIONAlgorithmPregnancies")
source(paste0(projectFolder, "/scripts/individual_data.R"))
source(paste0(projectFolder, "/scripts/create_drug_proxy_codelist.R"))
#Author: Vjola hoxhaj
#Date 28 november 2021
#Script: creation of codelist from different folders
#R script to combine codelists
#Grab folder names from the folder
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source(paste0(projectFolder, "/scripts/packages_codelist.R"))
source(paste0(projectFolder, "/scripts/create_output_folders.R"))
#########################################################################
#Add the name of your study as specified in the sharepoint excel file
#If you need to concatenate all codelist set study name to ALL
########################################################################
#example
#study_name<-"Pfizer"
#study_name<-"ALL"
# Pfizer AZ	Moderna	J&J	ROC20
study_names <- 'ALL' #c("ROC12","CONSIGN")#c("Pfizer", "AZ","Moderna","J&J","ROC20","ROC12","CONSIGN")
########################################################################
for (study_name in study_names){
source(paste0(projectFolder, "/scripts/main_script.R"))
#source(paste0(projectFolder, "/scripts/additional_codelist_events_CPRD.R"))
#source(paste0(projectFolder, "/scripts/additional_codelist_drugs_CPRD.R")) not needed
}
source(paste0(projectFolder, "/scripts/crosscheck_script.R"))
list_of_studies<-c("Pfizer",
"Pfizer_Myo",
"AZ",
"Moderna",
"Moderna_Myo",
"J&J",
"ROC20",
"CONSIGN",
"EMA_ROC11_CONSIGN",
"EMA_ROC12_effectiveness",
"Conception",
"ConcePTIONAlgorithmPregnancies")
source(paste0(projectFolder, "/scripts/individual_data.R"))
source(paste0(projectFolder, "/scripts/create_drug_proxy_codelist.R"))
#Author: Vjola hoxhaj
#Date 28 november 2021
#Script: creation of codelist from different folders
#R script to combine codelists
#Grab folder names from the folder
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source(paste0(projectFolder, "/scripts/packages_codelist.R"))
source(paste0(projectFolder, "/scripts/create_output_folders.R"))
#########################################################################
#Add the name of your study as specified in the sharepoint excel file
#If you need to concatenate all codelist set study name to ALL
########################################################################
#example
#study_name<-"Pfizer"
#study_name<-"ALL"
# Pfizer AZ	Moderna	J&J	ROC20
study_names <- 'ALL' #c("ROC12","CONSIGN")#c("Pfizer", "AZ","Moderna","J&J","ROC20","ROC12","CONSIGN")
########################################################################
for (study_name in study_names){
source(paste0(projectFolder, "/scripts/main_script.R"))
#source(paste0(projectFolder, "/scripts/additional_codelist_events_CPRD.R"))
#source(paste0(projectFolder, "/scripts/additional_codelist_drugs_CPRD.R")) not needed
}
#Author: Vjola hoxhaj
#Date 28 november 2021
#Script: creation of codelist from different folders
#R script to combine codelists
#Grab folder names from the folder
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source(paste0(projectFolder, "/scripts/packages_codelist.R"))
source(paste0(projectFolder, "/scripts/create_output_folders.R"))
#########################################################################
#Add the name of your study as specified in the sharepoint excel file
#If you need to concatenate all codelist set study name to ALL
########################################################################
#example
#study_name<-"Pfizer"
#study_name<-"ALL"
# Pfizer AZ	Moderna	J&J	ROC20
study_names <- 'ALL' #c("ROC12","CONSIGN")#c("Pfizer", "AZ","Moderna","J&J","ROC20","ROC12","CONSIGN")
########################################################################
for (study_name in study_names){
source(paste0(projectFolder, "/scripts/main_script.R"))
#source(paste0(projectFolder, "/scripts/additional_codelist_events_CPRD.R"))
#source(paste0(projectFolder, "/scripts/additional_codelist_drugs_CPRD.R")) not needed
}
source(paste0(projectFolder, "/scripts/crosscheck_script.R"))
list_of_studies<-c("Pfizer",
"Pfizer_Myo",
"AZ",
"Moderna",
"Moderna_Myo",
"J&J",
"ROC20",
"CONSIGN",
"EMA_ROC11_CONSIGN",
"EMA_ROC12_effectiveness",
"Conception",
"ConcePTIONAlgorithmPregnancies")
source(paste0(projectFolder, "/scripts/individual_data.R"))
source(paste0(projectFolder, "/scripts/create_drug_proxy_codelist.R"))
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source("99_path.R")
files<-sub('\\.csv$', '', list.files(path_dir))
###########################
#VISIT_OCCURRENCE table
###########################
table<-"VISIT_OCCURRENCE"
k=0
for (i in 1:length(files)) {
if (str_detect(files[i], paste0("^",table))) {
k=k+1
}
}
if(k!=0){
print(paste0(table," IS PRESENT, CHECK for ",table," is RUNNING"))
setwd(projectFolder)
Rmd_VISOCC<-paste0(pre_dir,"/STEP4to5-VISIT_OCCURRENCE.v10.16_05_2021.Rmd")
system.time(render(Rmd_VISOCC, output_dir = output_dir, output_file = "VISIT_OCCURRENCE.html"))
print("End VISIT_OCCURRENCE")
} else {
print(paste0(table," NOT present, PLEASE skip to next check"))
}
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source("99_path.R")
files<-sub('\\.csv$', '', list.files(path_dir))
###########################
#VISIT_OCCURRENCE table
###########################
table<-"VISIT_OCCURRENCE"
k=0
for (i in 1:length(files)) {
if (str_detect(files[i], paste0("^",table))) {
k=k+1
}
}
if(k!=0){
print(paste0(table," IS PRESENT, CHECK for ",table," is RUNNING"))
setwd(projectFolder)
Rmd_VISOCC<-paste0(pre_dir,"/STEP4to5-VISIT_OCCURRENCE.v10.16_05_2021.Rmd")
system.time(render(Rmd_VISOCC, output_dir = output_dir, output_file = "VISIT_OCCURRENCE.html"))
print("End VISIT_OCCURRENCE")
} else {
print(paste0(table," NOT present, PLEASE skip to next check"))
}
####Clean pregnancies####
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source(paste0(projectFolder,"/p_steps/clean_folders.R"))
source("99_path.R")
setwd(projectFolder)
#Run pregnancy algorithm and save results in g_intermediate/pregnancy_algorithm
source(paste0(pre_dir,"Step_00_create_clean_pregnancy_D3.R"))
render(paste0(pre_dir,"Report_0_pregnancy_algorithm_flowchart.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_0_Pregnancy_algorithm_flowchart.html"))
source(paste0(pre_dir,"save_environment.R"))
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source("99_path.R")
setwd(projectFolder)
#Create study population(persons/observation_periods/pregnancies)
load(paste0(g_intermediate,"environment.RData"))
initial_time_01<-Sys.time()
date_running_start_01<-Sys.Date()
#Clean folders
unlink(paste0(projectFolder,"/g_intermediate/tmp"), recursive = T)#delete folder
dir.create(paste0(projectFolder, "/g_intermediate/tmp"))
unlink(paste0(projectFolder,"/g_intermediate/pregnancy_d3"), recursive = T)#delete folder
dir.create(paste0(projectFolder, "/g_intermediate/pregnancy_d3"))
unlink(paste0(projectFolder,"/g_output/Pregnancy study population"), recursive = T)#delete folder
dir.create(paste0(projectFolder, "/g_output/Pregnancy study population"))
#Load the Observation periods table
####load info, parameters, conceptsets####
source(paste0(pre_dir,"info/directory_info.R"))
source(paste0(pre_dir,"functions/CreateSpells_v15.R"))
print('Import and append observation periods files')
obs_table_files<-actual_tables$OBSERVATION_PERIODS
OBS_PER<-lapply(paste0(path_dir,obs_table_files),function(x) fread(x, colClasses = "character"))
OBS_PER<-as.data.table(rbindlist(OBS_PER))
OBS_PER[,op_origin:=NULL]
OBS_PER<-OBS_PER[, lapply(.SD, FUN=function(x) gsub("^$|^ $", NA, x))] #make sure missing data is read appropriately
projectFolder
pre_dir
dir_base
dirinput
path_dir
list.files(path_dir,"CDM_SOURCE")
fread(paste0(path_dir, list.files(path_dir,"CDM_SOURCE")))
#Check if DAP is Effemeris and then create one observation period per women
DAP_name<-fread(paste0(path_dir, list.files(path_dir,"CDM_SOURCE")))[,data_access_provider_name]
DAP_name
#Find the minimum date for each subject
OBS_PER[,min_start_date:=min(op_start_date), by="person_id"]
View(OBS_PER)
#Load the Observation periods table
####load info, parameters, conceptsets####
source(paste0(pre_dir,"info/directory_info.R"))
source(paste0(pre_dir,"functions/CreateSpells_v15.R"))
print('Import and append observation periods files')
obs_table_files<-actual_tables$OBSERVATION_PERIODS
OBS_PER<-lapply(paste0(path_dir,obs_table_files),function(x) fread(x, colClasses = "character"))
OBS_PER<-as.data.table(rbindlist(OBS_PER))
OBS_PER[,op_origin:=NULL]
OBS_PER<-OBS_PER[, lapply(.SD, FUN=function(x) gsub("^$|^ $", NA, x))] #make sure missing data is read appropriately
#create an op_end_date_max with the maximum between gdm_pe_end_study_date, mig_end_study_date, du_end_study_date, saf_end_study_date
#create an op_end_date_min with the minimum between gdm_pe_start_study_date, mig_start_study_date, du_start_study_date, saf_start_study_date
#Allows to run the CreateSpells once
OBS_PER[,op_end_date_max:=as.character()]
op_end_date_max<-max(gdm_pe_end_study_date,mig_end_study_date,du_end_study_date,saf_end_study_date)
end_date_max <- paste0(year(op_end_date_max),sprintf("%02d",month(op_end_date_max)),sprintf("%02d",day(op_end_date_max)))
OBS_PER[, op_end_date_max:= as.character(op_end_date)]
OBS_PER[is.na(op_end_date), op_end_date_max:= as.character(end_date_max)]
print('Set start and end date to date format')
lapply(c("op_start_date","op_end_date","op_end_date_max"), function (x) OBS_PER <- OBS_PER[,eval(x) := as.IDate(as.character(get(x)),"%Y%m%d")])
OBS_PER[,min_start_date:=min(op_start_date), by="person_id"]
OBS_PER[,max_end_date:=max(op_end_date), by="person_id"]
View(OBS_PER)
OBS_PER[,max_end_date:=max(op_end_date_max), by="person_id"]
#remove all duplicated person id
OBS_PER_concept<-OBS_PER[,c("person_id","min_start_date","max_end_date")]
OBS_PER_concept<-OBS_PER_concept[!duplicated(person_id)]
#Add data to orignal table
OBS_PER<-rbind(OBS_PER,OBS_PER_concept,fill=T)
View(OBS_PER)
OBS_PER[is.na(op_start_date),op_start_date:=min_start_date]
OBS_PER[is.na(op_end_date_max),op_start_date:=max_end_date]
View(OBS_PER)
#Load the Observation periods table
####load info, parameters, conceptsets####
source(paste0(pre_dir,"info/directory_info.R"))
source(paste0(pre_dir,"functions/CreateSpells_v15.R"))
print('Import and append observation periods files')
obs_table_files<-actual_tables$OBSERVATION_PERIODS
OBS_PER<-lapply(paste0(path_dir,obs_table_files),function(x) fread(x, colClasses = "character"))
OBS_PER<-as.data.table(rbindlist(OBS_PER))
OBS_PER[,op_origin:=NULL]
OBS_PER<-OBS_PER[, lapply(.SD, FUN=function(x) gsub("^$|^ $", NA, x))] #make sure missing data is read appropriately
#create an op_end_date_max with the maximum between gdm_pe_end_study_date, mig_end_study_date, du_end_study_date, saf_end_study_date
#create an op_end_date_min with the minimum between gdm_pe_start_study_date, mig_start_study_date, du_start_study_date, saf_start_study_date
#Allows to run the CreateSpells once
OBS_PER[,op_end_date_max:=as.character()]
op_end_date_max<-max(gdm_pe_end_study_date,mig_end_study_date,du_end_study_date,saf_end_study_date)
end_date_max <- paste0(year(op_end_date_max),sprintf("%02d",month(op_end_date_max)),sprintf("%02d",day(op_end_date_max)))
OBS_PER[, op_end_date_max:= as.character(op_end_date)]
OBS_PER[is.na(op_end_date), op_end_date_max:= as.character(end_date_max)]
View(OBS_PER)
OBS_PER[,min_start_date:=min(op_start_date), by="person_id"]
OBS_PER[,max_end_date:=max(op_end_date_max), by="person_id"]
#remove all duplicated person id
OBS_PER_concept<-OBS_PER[,c("person_id","min_start_date","max_end_date")]
OBS_PER_concept<-OBS_PER_concept[!duplicated(person_id)]
#Add data to orignal table
OBS_PER<-rbind(OBS_PER,OBS_PER_concept,fill=T)
rm(OBS_PER_concept)
OBS_PER[is.na(op_start_date),op_start_date:=min_start_date]
OBS_PER[is.na(op_end_date_max),op_start_date:=max_end_date]
View(OBS_PER)
OBS_PER[is.na(op_end_date_max),op_end_date_max:=max_end_date]
View(OBS_PER)
lapply(c("op_start_date","op_end_date","op_end_date_max"), function (x) OBS_PER <- OBS_PER[,eval(x) := as.IDate(as.character(get(x)),"%Y%m%d")])
View(OBS_PER)
View(OBS_PER)
OBS_PER<-lapply(paste0(path_dir,obs_table_files),function(x) fread(x, colClasses = "character"))
OBS_PER<-as.data.table(rbindlist(OBS_PER))
OBS_PER[,op_origin:=NULL]
OBS_PER<-OBS_PER[, lapply(.SD, FUN=function(x) gsub("^$|^ $", NA, x))] #make sure missing data is read appropriately
OBS_PER[,op_end_date_max:=as.character()]
op_end_date_max<-max(gdm_pe_end_study_date,mig_end_study_date,du_end_study_date,saf_end_study_date)
end_date_max <- paste0(year(op_end_date_max),sprintf("%02d",month(op_end_date_max)),sprintf("%02d",day(op_end_date_max)))
OBS_PER[, op_end_date_max:= as.character(op_end_date)]
OBS_PER[is.na(op_end_date), op_end_date_max:= as.character(end_date_max)]
#Find the minimum date for each subject
OBS_PER[,min_start_date:=min(op_start_date), by="person_id"]
OBS_PER[,max_end_date:=max(op_end_date_max), by="person_id"]
#remove all duplicated person id
OBS_PER_concept<-OBS_PER[,c("person_id","min_start_date","max_end_date")]
OBS_PER_concept<-OBS_PER_concept[!duplicated(person_id)]
#Add data to orignal table
OBS_PER<-rbind(OBS_PER,OBS_PER_concept,fill=T)
rm(OBS_PER_concept)
OBS_PER[is.na(op_start_date),op_start_date:=min_start_date]
OBS_PER[is.na(op_end_date_max),op_end_date_max:=max_end_date]
View(OBS_PER)
lapply(c("op_start_date","op_end_date","op_end_date_max"), function (x) OBS_PER <- OBS_PER[,eval(x) := as.IDate(as.character(get(x)),"%Y%m%d")])
View(OBS_PER)
####Run create spells####
OBS_PER1 <- CreateSpells(
dataset=OBS_PER,
id="person_id" ,
start_date = "op_start_date",
end_date = "op_end_date_max",
overlap = FALSE,
only_overlaps = F
)
View(OBS_PER1)
####Create pregnancy study population####
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source("99_path.R")
setwd(projectFolder)
#Create study population(persons/observation_periods/pregnancies)
load(paste0(g_intermediate,"environment.RData"))
source(paste0(pre_dir,"Step_01_create_study_population.R"))
render(paste0(pre_dir,"Report_1_pregnancy_study_population.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_1_Pregnancy_study_population.html"))
source(paste0(pre_dir,"save_environment.R"))
