pregnancy_d3_mig[is.na(get(paste0(names_events[mig_fl],"_third"))),eval(paste0(names_events[mig_fl],"_third")):=0]
}else{
pregnancy_d3_mig[,eval(paste0(names_events[mig_fl],"_baseline")):=0]
pregnancy_d3_mig[,eval(paste0(names_events[mig_fl],"_baseline_2")):=0]
pregnancy_d3_mig[,eval(paste0(names_events[mig_fl],"_during")):=0]
pregnancy_d3_mig[,eval(paste0(names_events[mig_fl],"_first")):=0]
pregnancy_d3_mig[,eval(paste0(names_events[mig_fl],"_second")):=0]
pregnancy_d3_mig[,eval(paste0(names_events[mig_fl],"_third")):=0]
}
}else{
pregnancy_d3_mig[,eval(paste0(names_events[mig_fl],"_baseline")):=0]
pregnancy_d3_mig[,eval(paste0(names_events[mig_fl],"_baseline_2")):=0]
pregnancy_d3_mig[,eval(paste0(names_events[mig_fl],"_during")):=0]
pregnancy_d3_mig[,eval(paste0(names_events[mig_fl],"_first")):=0]
pregnancy_d3_mig[,eval(paste0(names_events[mig_fl],"_second")):=0]
pregnancy_d3_mig[,eval(paste0(names_events[mig_fl],"_third")):=0]
}
rm(mig_dt)
w<-w+1
}
names_migraine<-c("MG_baseline","MG_baseline_2","MG_during","MG_first","MG_second","MG_third")
#identify events that are not present from conditions_migraine
not_present<-setdiff(names_migraine, names(pregnancy_d3_mig))
if(length(not_present)>0){pregnancy_d3_mig[,eval(not_present):=list(0)]}
####Migraine MEDICINES: Triptans####
print("Loading all Migraine medicines D3 and merge with the pregnancy D3.")
mig_med_fl<-list.files(paste0(projectFolder,"/g_intermediate/migraine_algorithm_sensitivity/migraine_medicines/"),"Migraine_medicines_S")
mig_med<-readRDS(paste0(projectFolder,"/g_intermediate/migraine_algorithm_sensitivity/migraine_medicines/",mig_med_fl))
#Migraine_medicines: triptans separately
mig_med[,truncated_atc:=substr(atc_code,1,5)]
mig_med<-mig_med[truncated_atc == "N02CC"]
mig_med[,truncated_atc:=NULL]
#Find all triptans
cols_to_merge<-c("person_id","pregnancy_id","pregnancy_start_date","pregnancy_end_date","year","birth_date","death_date","op_end_date_mig","op_start_date_mig","age","maternal_age","year_group")
mig_med<-merge.data.table(pregnancy_d3_mig[,cols_to_merge,with=F], mig_med, by="person_id", all.x=T, allow.cartesian = T)
mig_med<-mig_med[!is.na(medicine_date)]
mig_med[,pregnancy_start_date:=as.IDate(pregnancy_start_date)][,pregnancy_end_date:=as.IDate(pregnancy_end_date)][,birth_date:=as.IDate(birth_date)][,death_date:=as.IDate(death_date)][,op_start_date_mig:=as.IDate(op_start_date_mig)][,op_end_date_mig:=as.IDate(op_end_date_mig)][,medicine_date:=as.IDate(medicine_date)]
w<-1
for(med_fl in 1:length(obs_period_med[,.N])){
if(mig_med[,.N]>0){
if(obs_period_med[med_fl,lookback]>0){
mig_med[,lookback:=obs_period_med[med_fl,lookback]]
mig_med[,start_preg:=as.IDate(pregnancy_start_date-lookback)]
#exclude all pregnancies that are outside observation period of interest
mig_med[,diff:=medicine_date-start_preg]
#remove all records with date before start date pregnancy+lookback
mig_med<-mig_med[diff>=0]
mig_med[,diff:=NULL][,lookback:=NULL][,start_preg:=NULL]
}else{
#remove all records before start obs
mig_med[,start:=obs_period_med[med_fl,start_date]]
mig_med[,start_preg:=as.IDate(pregnancy_start_date+start)]
mig_med[,diff:=medicine_date-start_preg]
mig_med<-mig_med[diff>=0]
mig_med[,diff:=NULL][,start:=NULL][,start_preg:=NULL]
}
if(mig_med[,.N]>0){
if(obs_period_med[med_fl,after]>0){
mig_med[,after:=obs_period_med[med_fl,after]]
mig_med[,end_preg:=as.IDate(pregnancy_end_date+after)]
mig_med[,diff:=medicine_date-end_preg]
mig_med<-mig_med[diff<=0]
mig_med[,diff:=NULL][,after:=NULL][,end_preg:=NULL]
}else{
#mig_med[,end:=after]
mig_med[,end_preg:=as.IDate(pregnancy_end_date)]
mig_med[,diff:=medicine_date-end_preg]
mig_med<-mig_med[diff<=0]
mig_med[,diff:=NULL][,end_preg:=NULL]
}
}
if(mig_med[,.N]>0){
cols<-c("person_id","pregnancy_id","pregnancy_start_date","pregnancy_end_date","medicine_date")
mig_med<-mig_med[,cols,with=F]
#Identify all baseline prescriptions
mig_med[,dif:=medicine_date-pregnancy_start_date]
mig_med[dif<0,paste0(obs_period_med[med_fl, StudyVar],"_baseline"):=1]
mig_med_baseline<-mig_med[get(paste0(obs_period_med[med_fl, StudyVar],"_baseline"))==1,lapply(.SD, sum),.SDcols = paste0(obs_period_med[med_fl, StudyVar],"_baseline"), by=c("person_id","pregnancy_id","pregnancy_start_date","pregnancy_end_date")]
mig_med[,dif:=NULL][,eval(paste0(obs_period_med[med_fl, StudyVar],"_baseline")):=NULL]
pregnancy_d3_mig<-merge.data.table(pregnancy_d3_mig,mig_med_baseline,all.x=T, by=cols[!cols %in% c("medicine_date")])
rm(mig_med_baseline)
pregnancy_d3_mig[is.na(get(paste0(obs_period_med[med_fl, StudyVar],"_baseline"))),eval(paste0(obs_period_med[med_fl, StudyVar],"_baseline")):=0]
#depending on the DAP: Different lookback
if(!DAP_name %in% c("NIHW", "CHUT")){
mig_med[,start:=pregnancy_start_date - 3*30.25]
mig_med[medicine_date>=start & medicine_date<pregnancy_start_date,paste0(obs_period_med[med_fl, StudyVar],"_baseline_2"):=1]
mig_baseline_2<-mig_med[get(paste0(obs_period_med[med_fl, StudyVar],"_baseline_2"))==1,lapply(.SD, sum),.SDcols = paste0(obs_period_med[med_fl, StudyVar],"_baseline_2"), by=c("person_id","pregnancy_id","pregnancy_start_date","pregnancy_end_date")]
mig_med[,start:=NULL][,eval(paste0(obs_period_med[med_fl, StudyVar],"_baseline_2")):=NULL]
pregnancy_d3_mig<-merge.data.table(pregnancy_d3_mig,mig_baseline_2,all.x=T, by=cols[!cols %in% c("medicine_date")])
rm(mig_baseline_2)
pregnancy_d3_mig[is.na(get(paste0(obs_period_med[med_fl, StudyVar],"_baseline_2"))),eval(paste0(obs_period_med[med_fl, StudyVar],"_baseline_2")):=0]
}else{
pregnancy_d3_mig[,eval(paste0(obs_period_med[med_fl, StudyVar],"_baseline_2")):=get(paste0(obs_period_med[med_fl, StudyVar],"_baseline"))]
}
#during pregnancy
mig_med[medicine_date>=pregnancy_start_date & medicine_date<=pregnancy_end_date,paste0(obs_period_med[med_fl, StudyVar],"_during"):=1]
mig_med_during<-mig_med[get(paste0(obs_period_med[med_fl, StudyVar],"_during"))==1,lapply(.SD, sum),.SDcols = paste0(obs_period_med[med_fl, StudyVar],"_during"), by=c("person_id","pregnancy_id","pregnancy_start_date","pregnancy_end_date")]
mig_med[,eval(paste0(obs_period_med[med_fl, StudyVar],"_during")):=NULL]
pregnancy_d3_mig<-merge.data.table(pregnancy_d3_mig,mig_med_during,all.x=T, by=cols[!cols %in% c("medicine_date")])
rm(mig_med_during)
pregnancy_d3_mig[is.na(get(paste0(obs_period_med[med_fl, StudyVar],"_during"))),eval(paste0(obs_period_med[med_fl, StudyVar],"_during")):=0]
cols<-cols[!cols %in% c("medicinal_product_id","injection")]
#first
mig_med[,start:=pregnancy_start_date + trimester_timepoint[Indicator=="first",as.numeric(start)]][,end:=pregnancy_start_date + trimester_timepoint[Indicator=="first",as.numeric(end)]]
mig_med[medicine_date>=start & medicine_date<end,paste0(obs_period_med[med_fl, StudyVar],"_first"):=1]
mig_med_first<-mig_med[get(paste0(obs_period_med[med_fl, StudyVar],"_first"))==1,lapply(.SD, sum),.SDcols = paste0(obs_period_med[med_fl, StudyVar],"_first"), by=c("person_id","pregnancy_id","pregnancy_start_date","pregnancy_end_date")]
mig_med[,eval(paste0(obs_period_med[med_fl, StudyVar],"_first")):=NULL]
pregnancy_d3_mig<-merge.data.table(pregnancy_d3_mig,mig_med_first,all.x=T, by=cols[!cols %in% "medicine_date"])
rm(mig_med_first)
pregnancy_d3_mig[is.na(get(paste0(obs_period_med[med_fl, StudyVar],"_first"))),eval(paste0(obs_period_med[med_fl, StudyVar],"_first")):=0]
#second
mig_med[,start:=pregnancy_start_date + trimester_timepoint[Indicator=="second",as.numeric(start)]][,end:=pregnancy_start_date + trimester_timepoint[Indicator=="second",as.numeric(end)]]
mig_med[medicine_date>=start & medicine_date<end,paste0(obs_period_med[med_fl, StudyVar],"_second"):=1]
mig_med_second<-mig_med[get(paste0(obs_period_med[med_fl, StudyVar],"_second"))==1,lapply(.SD, sum),.SDcols = paste0(obs_period_med[med_fl, StudyVar],"_second"), by=c("person_id","pregnancy_id","pregnancy_start_date","pregnancy_end_date")]
mig_med[,eval(paste0(obs_period_med[med_fl, StudyVar],"_second")):=NULL]
pregnancy_d3_mig<-merge.data.table(pregnancy_d3_mig,mig_med_second,all.x=T, by=cols[!cols %in% "medicine_date"])
rm(mig_med_second)
pregnancy_d3_mig[is.na(get(paste0(obs_period_med[med_fl, StudyVar],"_second"))),eval(paste0(obs_period_med[med_fl, StudyVar],"_second")):=0]
#third
mig_med[,start:=pregnancy_start_date + trimester_timepoint[Indicator=="third",as.numeric(start)]][,end:=pregnancy_start_date + trimester_timepoint[Indicator=="third",as.numeric(end)]]
mig_med[medicine_date>=start & medicine_date<end,paste0(obs_period_med[med_fl, StudyVar],"_third"):=1]
mig_med_third<-mig_med[get(paste0(obs_period_med[med_fl, StudyVar],"_third"))==1,lapply(.SD, sum),.SDcols = paste0(obs_period_med[med_fl, StudyVar],"_third"), by=c("person_id","pregnancy_id","pregnancy_start_date","pregnancy_end_date")]
mig_med[,eval(paste0(obs_period_med[med_fl, StudyVar],"_third")):=NULL]
pregnancy_d3_mig<-merge.data.table(pregnancy_d3_mig,mig_med_third,all.x=T, by=cols[!cols %in% "medicine_date"])
rm(mig_med_third)
pregnancy_d3_mig[is.na(get(paste0(obs_period_med[med_fl, StudyVar],"_third"))),eval(paste0(obs_period_med[med_fl, StudyVar],"_third")):=0]
}else{
pregnancy_d3_mig[,eval(paste0(obs_period_med[med_fl,StudyVar],"_baseline")):=0]
pregnancy_d3_mig[,eval(paste0(obs_period_med[med_fl,StudyVar],"_baseline_2")):=0]
pregnancy_d3_mig[,eval(paste0(obs_period_med[med_fl,StudyVar],"_during")):=0]
pregnancy_d3_mig[,eval(paste0(obs_period_med[med_fl,StudyVar],"_first")):=0]
pregnancy_d3_mig[,eval(paste0(obs_period_med[med_fl,StudyVar],"_second")):=0]
pregnancy_d3_mig[,eval(paste0(obs_period_med[med_fl,StudyVar],"_third")):=0]
}
}else{
pregnancy_d3_mig[,eval(paste0(obs_period_med[med_fl,StudyVar],"_baseline")):=0]
pregnancy_d3_mig[,eval(paste0(obs_period_med[med_fl,StudyVar],"_baseline_2")):=0]
pregnancy_d3_mig[,eval(paste0(obs_period_med[med_fl,StudyVar],"_during")):=0]
pregnancy_d3_mig[,eval(paste0(obs_period_med[med_fl,StudyVar],"_first")):=0]
pregnancy_d3_mig[,eval(paste0(obs_period_med[med_fl,StudyVar],"_second")):=0]
pregnancy_d3_mig[,eval(paste0(obs_period_med[med_fl,StudyVar],"_third")):=0]
}
}
rm(mig_med)
saveRDS(pregnancy_d3_mig, paste0(projectFolder,"/g_intermediate/migraine_algorithm_sensitivity/pregnancy_D3_sensitivity/final_d3/MIG_Pregnancy_D3_S.rds"))
#### Apply the algorithm ####
source(paste0(projectFolder,"/p_steps/Step_05_a_migraine_algorithms_sensitivity.R"))
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source(paste0(projectFolder,"/p_steps/clean_folders.R"))
source("99_path.R")
setwd(projectFolder)
#Run pregnancy algorithm and save results to g_intermediate/pregnancy after clean up
#source(paste0(pre_dir,"Pregnancy algorithm/to_run.R"))
#Load the final pregnancy D3
rm(list=setdiff(ls(), "projectFolder"))
setwd(projectFolder)
source("99_path.R")
setwd(projectFolder)
initial_time_00<-Sys.time()
date_running_start_00<-Sys.Date()
#Load study parameters
source(paste0(projectFolder,"/p_steps/info/DAP_info.R"))
source(paste0(projectFolder,"/p_steps/parameters/study_parameters.R"))
####Load the final pregnancy D3####
preg_file<-list.files(paste0(thisdir,"/g_output/"), "pregnancy_final")
#decluter environment and set up the 99_path again
get(load(paste0(thisdir,"/g_output/", preg_file)))
pregnancy_D3<-D3_pregnancy_final
rm(D3_pregnancy_final)
pregnancy_D3[,pregnancy_start_date:=as.IDate(pregnancy_start_date)]
pregnancy_D3[,pregnancy_end_date:=as.IDate(pregnancy_end_date)]
original_rows<-pregnancy_D3[,.N]
###Get a cross tabulation between quality color, outcomes and type of data
crosstab_rec<-pregnancy_D3[,.N, by=c("highest_quality","type_of_pregnancy_end")]
setnames(crosstab_rec,"N","no_records")
fwrite(crosstab_rec,paste0(output_dir, "Pregnancy algorithm/Step_00_crosstabulation_quality_outcome.csv"), row.names = F)
all_colors_present<-pregnancy_D3[!duplicated(highest_quality),highest_quality]
all_color_present<-paste(all_colors_present,collapse=",")
all_outcomes_present<-pregnancy_D3[!duplicated(type_of_pregnancy_end),type_of_pregnancy_end]
all_outcome_present<-paste(all_outcomes_present,collapse=",")
####cross tab of included records####
#count number of records that are removed
crosstab_rec_inc<-pregnancy_D3[,.N, by=c("highest_quality","type_of_pregnancy_end")]
setnames(crosstab_rec_inc,"N","included_records")
#combine
crosstab<-merge.data.table(crosstab_rec,crosstab_rec_inc, by=c("highest_quality","type_of_pregnancy_end"), all=T)
crosstab[is.na(included_records), included_records:=0]
crosstab[,no_records:=as.numeric(no_records)][,included_records:=as.numeric(included_records)]
crosstab[,removed_records:=no_records-included_records]
crosstab[,removal_percentage:=round((removed_records/no_records)*100,1)]
not_incl_rec<-crosstab[,sum(removed_records)]
fwrite(crosstab,paste0(output_dir, "Pregnancy algorithm/Step_00_other_quality_records_removed.csv"), row.names = F)
rm(crosstab)
####check for issues####
issues_preg_alg_sex<-pregnancy_D3[sex_at_instance_creation!="F",.N]
pregnancy_D3<-pregnancy_D3[sex_at_instance_creation=="F"]
issues_preg_alg_date<-pregnancy_D3[is.na(pregnancy_start_date)|is.na(pregnancy_end_date),.N]
pregnancy_D3<-pregnancy_D3[!is.na(pregnancy_start_date) & !is.na(pregnancy_end_date)]
issues_preg_alg_pid<-pregnancy_D3[is.na(person_id),.N]
pregnancy_D3<-pregnancy_D3[!is.na(person_id)]
issues_preg_alg_prid<-pregnancy_D3[is.na(pregnancy_id),.N]
pregnancy_D3<-pregnancy_D3[!is.na(pregnancy_id)]
#calculate gestational age and exclude all records with gestational age>43 weeks(301 days)
pregnancy_D3[,diff:=pregnancy_end_date- pregnancy_start_date]
issues_preg_alg_ga<-pregnancy_D3[diff>=301,.N]
pregnancy_D3<-pregnancy_D3[diff<301]
#Check for presence of multiple pregnancies
#We eitehr check for the same combination person_id:pregnancy_id:start_date_pregnancy or person_id:start_date_pregnancy
pregnancy_D3[,id_st:=rowid(person_id, pregnancy_start_date)]
issue_1<-pregnancy_D3[id_st>1,.N]
if(issue_1>0){
pregnancy_D3[,comb:=paste(person_id,pregnancy_start_date,sep="_")]
pregnancy_D3[duplicated(comb) | duplicated(comb, fromLast = TRUE)][,Filter := diff == max(diff), by = comb]
#keep only records where FILTER is equal to TRUE
pregnancy_D3<-pregnancy_D3[Filter==T]
pregnancy_D3[,Filter:=NULL]
#Keep not duplicated id(remove twins, triplets etc)
pregnancy_D3<-pregnancy_D3[!duplicated(comb)]
pregnancy_D3[,comb:=NULL]
}
incl_rec<-pregnancy_D3[,.N]
Indicator<-c("1.0. Number of original records from the pregnancy algorithm",
"1.1. Number of records with quality other than needed",
"1.2. Records with sex other than female",
"1.3. Records with missing start or end date of pregnancy or both",
"1.4. Records with missing person id",
"1.5. Records with missing pregnancy id",
"1.6. Records where gestational age is longer than 43 weeks(301 days)",
"1.7. Records with the same person_id and start_date_pregnancy(keep the longest record, exclude others)",
"1.8. Records left after exclusions")
placeholder<-c(original_rows,not_incl_rec,issues_preg_alg_sex,issues_preg_alg_date,issues_preg_alg_pid,issues_preg_alg_prid,issues_preg_alg_ga,issue_1, incl_rec)
issues<-data.table(Indicator=Indicator, Count=placeholder)
rm(Indicator,placeholder)
rm(issues_preg_alg_sex,not_incl_rec,issues_preg_alg_date,issues_preg_alg_pid,issues_preg_alg_prid,issues_preg_alg_ga,incl_rec, issue_1)
fwrite(issues,paste0(output_dir, "Pregnancy algorithm/Step_00_issues_flowchart_pregnancy_D3.csv"), row.names = F)
rm(issues)
####Remove all records with date before min preg date####
####GDM and PE####
pregnancy_D3[,filter_1:=as.character(NA)]
pregnancy_D3[,min_preg_date:=min_preg_date_gdm_pe]
pregnancy_D3[,dif:=min_preg_date - pregnancy_start_date]
before_min_date_gdm_pe<-pregnancy_D3[dif>0,.N]
pregnancy_D3[dif<=0,filter_1:=1]
pregnancy_D3[,min_preg_date:=NULL][,dif:=NULL]
pregnancy_D3[,filter_2:=as.character(NA)]
pregnancy_D3[,max_preg_date:=max_preg_date_gdm_pe]
pregnancy_D3[,dif:=max_preg_date - pregnancy_start_date]
after_max_date_gdm_pe<-pregnancy_D3[dif<0 & filter_1==1,.N]
pregnancy_D3[dif>=0 & filter_1==1,filter_2:=1]
pregnancy_D3[,max_preg_date:=NULL][,dif:=NULL]
pregnancy_D3[filter_1==1 & filter_2==1,gdm_pe_filter:=1]
pregnancy_D3[,filter_1:=NULL][,filter_2:=NULL]
#pregnancies with ga>20 weeks(140 days) only
pregnancy_D3[,GA:=pregnancy_end_date - pregnancy_start_date]
pregnancy_D3[GA>140, include_ga:=1]
not_incl_ga<-pregnancy_D3[GA<=140 & gdm_pe_filter==1,.N]
#update gdm_pe_filter
pregnancy_D3[GA<=140, gdm_pe_filter:=NA]
pregnancy_D3[,GA:=NULL]
included_gdm_pe<-pregnancy_D3[gdm_pe_filter==1,.N]
issues_gdm_pe<-data.table(Indicator=c(paste0("1.0. Records with start date before: ",min_preg_date_gdm_pe),
paste0("1.1. Records with end date after: ", max_preg_date_gdm_pe),
"1.2. Records with GA<20 weeks(140 days)",
#                          "Records with pregnancy outcome other than LB/SB",
"1.3. Records left after removing all issues above"),
GDM_and_PE=c(before_min_date_gdm_pe,
after_max_date_gdm_pe,
not_incl_ga,
#                                       "N/A",
included_gdm_pe)
)
rm(before_min_date_gdm_pe,after_max_date_gdm_pe,not_incl_ga,included_gdm_pe)
fwrite(issues_gdm_pe,paste0(output_dir, "Pregnancy algorithm/Step_00_issues_GDM_PE_flowchart_pregnancy_D3.csv"), row.names = F)
rm(issues_gdm_pe)
####Migraine####
pregnancy_D3[,filter_1:=as.character(NA)]
pregnancy_D3[,min_preg_date:=min_preg_date_mig]
pregnancy_D3[,dif:=min_preg_date - pregnancy_start_date]
before_min_date_mig<-pregnancy_D3[dif>0,.N]
pregnancy_D3[dif<=0,filter_1:=1]
pregnancy_D3[,min_preg_date:=NULL][,dif:=NULL]
pregnancy_D3[,filter_2:=as.character(NA)]
pregnancy_D3[,max_preg_date:=max_preg_date_mig]
pregnancy_D3[,dif:=max_preg_date - pregnancy_start_date]
after_max_date_mig<-pregnancy_D3[dif<0 & filter_1==1,.N]
pregnancy_D3[dif>=0 & filter_1==1,filter_2:=1]
pregnancy_D3[,max_preg_date:=NULL][,dif:=NULL]
pregnancy_D3[filter_1==1 & filter_2==1,mig_filter:=1]
pregnancy_D3[,filter_1:=NULL][,filter_2:=NULL]
#Calculate number of pregnancy records with outcome LB/SB
if(data_access_provider_name=="NIHW"){
pregnancy_D3[type_of_pregnancy_end  %in% c("LB", "SB"), keep_outcome:=1]
}else{
pregnancy_D3[type_of_pregnancy_end %in% c("LB", "SB", "SA", "T"), keep_outcome:=1]
}
other_outcome_mig<-pregnancy_D3[is.na(keep_outcome) & mig_filter==1,.N]
if(other_outcome_mig>0){
type_other_outcome<-paste(unique(pregnancy_D3[is.na(keep_outcome) & mig_filter==1,type_of_pregnancy_end]), collapse = ",")
}else{
type_other_outcome<-"N/A"
}
#Update filter_mig based on the type of outcome
pregnancy_D3[is.na(keep_outcome), mig_filter:=NA]
pregnancy_D3[,keep_outcome:=NULL]
included_mig<-pregnancy_D3[mig_filter==1,.N]
issues_mig<-data.table(Indicator=c(paste0("1.0. Records with start date before: ", min_preg_date_mig),
paste0("1.1. Records with end date after: ", max_preg_date_mig),
#                                   "Records with GA> 20 weeks(140 days)",
paste0("1.2. Records with pregnancy outcome other than LB/SB/SA/T (",type_other_outcome,")"),
"1.3. Records left after removing all issues above"),
Migraine=c(before_min_date_mig,
after_max_date_mig,
#                                     "N/A",
other_outcome_mig,
included_mig)
)
rm(before_min_date_mig,after_max_date_mig,other_outcome_mig,included_mig,type_other_outcome)
fwrite(issues_mig,paste0(output_dir, "Pregnancy algorithm/Step_00_issues_Migraine_flowchart_pregnancy_D3.csv"), row.names = F)
rm(issues_mig)
####Drug utilisation####
pregnancy_D3[,filter_1:=as.character(NA)]
pregnancy_D3[,min_preg_date:=min_preg_date_du]
pregnancy_D3[,dif:=min_preg_date - pregnancy_start_date]
before_min_date_du<-pregnancy_D3[dif>0,.N]
pregnancy_D3[dif<=0,filter_1:=1]
pregnancy_D3[,min_preg_date:=NULL][,dif:=NULL]
pregnancy_D3[,filter_2:=as.character(NA)]
pregnancy_D3[,max_preg_date:=max_preg_date_du]
pregnancy_D3[,dif:=max_preg_date - pregnancy_start_date]
after_max_date_du<-pregnancy_D3[dif<0 & filter_1==1,.N]
pregnancy_D3[dif>=0 & filter_1==1,filter_2:=1]
pregnancy_D3[,max_preg_date:=NULL][,dif:=NULL]
pregnancy_D3[filter_1==1 & filter_2==1,du_filter:=1]
pregnancy_D3[,filter_1:=NULL][,filter_2:=NULL]
#Calculate number of pregnancy records with outcome LB/SB
if(data_access_provider_name=="NIHW"){
pregnancy_D3[type_of_pregnancy_end  %in% c("LB", "SB"), keep_outcome:=1]
}else{
pregnancy_D3[type_of_pregnancy_end  %in% c("LB", "SB", "SA", "T"), keep_outcome:=1]
}
other_outcome_du<-pregnancy_D3[is.na(keep_outcome) & du_filter==1,.N]
if(other_outcome_du>0){
type_other_outcome<-paste(unique(pregnancy_D3[is.na(keep_outcome) & du_filter==1,type_of_pregnancy_end]), collapse = ",")
}else{
type_other_outcome<-"N/A"
}
#Update filter_mig based on the type of outcome
pregnancy_D3[is.na(keep_outcome), du_filter:=NA]
pregnancy_D3[,keep_outcome:=NULL]
included_du<-pregnancy_D3[du_filter==1,.N]
issues_du<-data.table(Indicator=c(paste0("1.0. Records with start date before: ",min_preg_date_du),
paste0("1.1. Records with end date after:", max_preg_date_du),
#                                   "Records with GA> 20 weeks(140 days)",
paste0("1.2. Records with pregnancy outcome other than LB/SB/SA/T (",type_other_outcome,")"),
"1.3. Records left after removing all issues above"),
Drug_utilisation=c(before_min_date_du,
after_max_date_du,
#                                  "N/A",
other_outcome_du,
included_du)
)
rm(before_min_date_du,after_max_date_du,other_outcome_du,included_du,type_other_outcome)
fwrite(issues_du,paste0(output_dir, "Pregnancy algorithm/Step_00_issues_DU_flowchart_pregnancy_D3.csv"), row.names = F)
rm(issues_du)
####Safety####
pregnancy_D3[,filter_1:=as.character(NA)]
pregnancy_D3[,min_preg_date:=min_preg_date_saf]
pregnancy_D3[,dif:=min_preg_date - pregnancy_start_date]
before_min_date_saf<-pregnancy_D3[dif>0,.N]
pregnancy_D3[dif<=0,filter_1:=1]
pregnancy_D3[,min_preg_date:=NULL][,dif:=NULL]
pregnancy_D3[,filter_2:=as.character(NA)]
pregnancy_D3[,max_preg_date:=max_preg_date_saf]
pregnancy_D3[,dif:=max_preg_date - pregnancy_start_date]
after_max_date_saf<-pregnancy_D3[dif<0 & filter_1==1,.N]
pregnancy_D3[dif>=0 & filter_1==1,filter_2:=1]
pregnancy_D3[,max_preg_date:=NULL][,dif:=NULL]
pregnancy_D3[filter_1==1 & filter_2==1,saf_filter:=1]
pregnancy_D3[,filter_1:=NULL][,filter_2:=NULL]
#Calculate number of pregnancy records with outcome LB/SB
if(data_access_provider_name=="NIHW"){
pregnancy_D3[type_of_pregnancy_end  %in% c("LB", "SB", "T"), keep_outcome:=1]
}else{
pregnancy_D3[type_of_pregnancy_end  %in% c("LB", "SB", "SA", "T"), keep_outcome:=1]
}
other_outcome_saf<-pregnancy_D3[is.na(keep_outcome) & saf_filter==1,.N]
if(other_outcome_saf>0){
type_other_outcome<-paste(unique(pregnancy_D3[is.na(keep_outcome) & saf_filter==1,type_of_pregnancy_end]), collapse = ",")
}else{
type_other_outcome<-"N/A"
}
#Update filter_mig based on the type of outcome
pregnancy_D3[is.na(keep_outcome), saf_filter:=NA]
pregnancy_D3[,keep_outcome:=NULL]
included_saf<-pregnancy_D3[saf_filter==1,.N]
issues_saf<-data.table(Indicator=c(paste0("1.0. Records with start date before: ",min_preg_date_saf),
paste0("1.1. Records with end date after: ", max_preg_date_saf),
#                                  "Records with GA> 20 weeks(140 days)",
paste0("1.2. Records with pregnancy outcome other than LB/SB/SA/T (",type_other_outcome,")"),
"1.3. Records left after removing all issues above"),
Safety=c(before_min_date_saf,
after_max_date_saf,
#                                 "N/A",
other_outcome_saf,
included_saf)
)
rm(before_min_date_saf,after_max_date_saf,other_outcome_saf,included_saf,type_other_outcome)
fwrite(issues_saf,paste0(output_dir, "Pregnancy algorithm/Step_00_issues_Safety_flowchart_pregnancy_D3.csv"), row.names = F)
rm(issues_saf)
####remove uneccessary columns####
pregnancy_D3<-pregnancy_D3[,c("person_id","pregnancy_id","pregnancy_start_date","pregnancy_end_date","gdm_pe_filter","mig_filter","du_filter","saf_filter")]
####Create summary of included records by year of start pregnancy####
pregnancy_D3[,year:=year(pregnancy_start_date)]
summary_gdm<-as.data.table(pregnancy_D3[gdm_pe_filter==1,.N,by="year"])
setnames(summary_gdm,"N","GDM_and_PE")
summary_mig<-as.data.table(pregnancy_D3[mig_filter==1,.N,by="year"])
setnames(summary_mig,"N","Migraine")
summary_du<-as.data.table(pregnancy_D3[du_filter==1,.N,by="year"])
setnames(summary_du,"N","Drug_utilisation")
summary_saf<-as.data.table(pregnancy_D3[saf_filter==1,.N,by="year"])
setnames(summary_saf,"N","Safety")
summary<-merge.data.table(summary_gdm,summary_mig,by="year",all=T)
rm(summary_gdm,summary_mig)
summary<-merge.data.table(summary,summary_du,by="year",all=T)
rm(summary_du)
summary<-merge.data.table(summary,summary_saf,by="year",all=T)
rm(summary_saf)
summary[is.na(GDM_and_PE),GDM_and_PE:=0]
summary[is.na(Migraine),Migraine:=0]
summary[is.na(Drug_utilisation),Drug_utilisation:=0]
summary[is.na(Safety),Safety:=0]
fwrite(summary,paste0(output_dir, "Pregnancy algorithm/Step_00_included_records_pregnancy_D3.csv"), row.names = F)
rm(summary)
#save pregnancy population to g_intermediate
saveRDS(pregnancy_D3,paste0(g_intermediate,"pregnancy_algorithm/pregnancy_D3.rds"))
rm(pregnancy_D3)
date_running_end_00<-Sys.Date()
end_time_00<-Sys.time()
time_log<-data.table(DAP=data_access_provider_name,
Script="Step_00_create_clean_pregnancy_D3.R",
Start_date=date_running_start_00,
End_date=date_running_end_00,
Time_elaspsed=format(end_time_00-initial_time_00, digits=2))
fwrite(time_log,paste0(output_dir,"/Time log/Step_00_time_log.csv"),row.names = F)
rm(time_log)
render(paste0(pre_dir,"Report_0_pregnancy_algorithm_flowchart.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_0_Pregnancy_algorithm_flowchart.html"))
source(paste0(pre_dir,"save_environment.R"))
####Create pregnancy study population####
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source("99_path.R")
setwd(projectFolder)
#Create study population(persons/observation_periods/pregnancies)
load(paste0(g_intermediate,"environment.RData"))
source(paste0(pre_dir,"Step_01_create_study_population.R"))
render(paste0(pre_dir,"Report_1_pregnancy_study_population.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_1_Pregnancy_study_population.html"))
source(paste0(pre_dir,"save_environment.R"))
####Run diagnostic filtering script####
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source("99_path.R")
setwd(projectFolder)
#Create diagnoses D3(GDM/PE/Migraine)
load(paste0(g_intermediate,"environment.RData"))
source(paste0(pre_dir,"Step_02_diagnoses_clean_up.R"))
source(paste0(pre_dir,"Step_02_diagnoses_clean_up_combine.R"))
render(paste0(pre_dir,"Report_2_diagnoses_clean_up.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_2_Diagnoses_clean_up.html"))
source(paste0(pre_dir,"save_environment.R"))
####Run medicines filtering script####
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source("99_path.R")
setwd(projectFolder)
#Create medicines D3(GDM/PE/Migraine)
load(paste0(g_intermediate,"environment.RData"))
source(paste0(pre_dir,"Step_03_medicines_clean_up.R"))
source(paste0(pre_dir,"Step_03_medicines_clean_up_combine.R"))
render(paste0(pre_dir,"Report_3_medicines_clean_up.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_3_Medicines_clean_up.html"))
source(paste0(pre_dir,"save_environment.R"))
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source("99_path.R")
setwd(projectFolder)
load(paste0(projectFolder,"/g_intermediate/environment.RData"))
source(paste0(pre_dir,"Step_04_algorithms.R"))
source(paste0(pre_dir,"Step_05_algorithms_sensitivity.R"))
render(paste0(pre_dir,"Report_4_gdm_pe_algorithms.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_4_gdm_pe_algorithms.html"))
render(paste0(pre_dir,"Report_4_migraine_algorithms.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_4_migraine_algorithms.html"))
render(paste0(pre_dir,"Report_4_migraine_algorithms_type.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_4_migraine_algorithms_type.html"))
render(paste0(pre_dir,"Report_4_migraine_algorithms_severity.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_4_migraine_algorithms_severity.html"))
source(paste0(pre_dir,"save_environment.R"))
