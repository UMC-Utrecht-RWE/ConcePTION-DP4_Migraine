}
year_group_creation<-function(x){
if(x>=2005 & x<=2009){y<-"2005-2009"}
if(x>=2010 & x<=2014){y<-"2010-2014"}
if(x>=2015 & x<=2019){y<-"2015-2019"}
if(x>=2020){y<-"2020-present"}
return(y)
}
#### GDM and PE ####
#Load all gdm_algorithm file and combine with the pregnancy D3
pregnancy_d3_gdm_pe<-readRDS(paste0(projectFolder,"/g_intermediate/pregnancy_d3/GDM_PE_Pregnancy_D3.rds"))
pregnancy_d3_gdm_pe[,pregnancy_start_date:=as.IDate(pregnancy_start_date)][,pregnancy_end_date:=as.IDate(pregnancy_end_date)][,birth_date:=as.IDate(birth_date)][,death_date:=as.IDate(death_date)][,op_start_date_gdm_pe:=as.IDate(op_start_date_gdm_pe)][,op_end_date_gdm_pe:=as.IDate(op_end_date_gdm_pe)]
pregnancy_d3_gdm_pe[,age:=floor((pregnancy_start_date-birth_date)/365.25)]
pregnancy_d3_gdm_pe[,maternal_age:=as.character(lapply(age, age_band_creation))]
pregnancy_d3_gdm_pe[,year:=year(pregnancy_start_date)]
pregnancy_d3_gdm_pe[,year_group:=as.character(lapply(year, year_group_creation))]
if("final_d3" %in% list.files(paste0(projectFolder,"/g_intermediate/gdm_algorithm/"))){
unlink(paste0(projectFolder,"/g_intermediate/gdm_algorithm/final_d3"), recursive = T)
}
source(paste0(projectFolder,"/p_steps/Step_04_a_gdm_algorithms.R"))
if("final_d3" %in% list.files(paste0(projectFolder,"/g_intermediate/pe_algorithm/"))){
unlink(paste0(projectFolder,"/g_intermediate/pe_algorithm/final_d3"), recursive = T)
}
source(paste0(projectFolder,"/p_steps/Step_04_b_pe_algorithms.R"))
#removed rec
removed_rec<-rbind(removed_rec_gdm,removed_rec_pe)
fwrite(removed_rec,paste0(projectFolder,"/g_output/PE and GDM algorithm/Step_04_excluded_records_gdm_pe.csv"),row.names = F)
rm(removed_rec,removed_rec_gdm,removed_rec_pe)
sum<-rbind(sum_gdm,sum_pe)
fwrite(sum,paste0(projectFolder,"/g_output/PE and GDM algorithm/Step_04_summary_included_records_gdm_pe.csv"),row.names = F)
rm(sum,sum_gdm,sum_pe)
rm(pregnancy_d3_gdm_pe)
gc()
#### Migraine ####
#Load all migraine_algorithm file and combine with the pregnancy D3
pregnancy_d3_mig<-readRDS(paste0(projectFolder,"/g_intermediate/pregnancy_d3/MIG_Pregnancy_D3.rds"))
pregnancy_d3_mig[,pregnancy_start_date:=as.IDate(pregnancy_start_date)][,pregnancy_end_date:=as.IDate(pregnancy_end_date)][,birth_date:=as.IDate(birth_date)][,death_date:=as.IDate(death_date)][,op_start_date_mig:=as.IDate(op_start_date_mig)][,op_end_date_mig:=as.IDate(op_end_date_mig)]
pregnancy_d3_mig[,age:=floor((pregnancy_start_date-birth_date)/365.25)]
pregnancy_d3_mig[,maternal_age:=as.character(lapply(age, age_band_creation))]
pregnancy_d3_mig[,year:=year(pregnancy_start_date)]
pregnancy_d3_mig[,year_group:=as.character(lapply(year, year_group_creation))]
#remove uneccesary variables
if("gdm_pe_filter" %in% names(pregnancy_d3_mig)){pregnancy_d3_mig[,gdm_pe_filter:=NULL]}
if("du_filter" %in% names(pregnancy_d3_mig)){pregnancy_d3_mig[,du_filter:=NULL]}
if("saf_filter" %in% names(pregnancy_d3_mig)){pregnancy_d3_mig[,saf_filter:=NULL]}
if("mig_filter" %in% names(pregnancy_d3_mig)){pregnancy_d3_mig[,mig_filter:=NULL]}
if("op_end_date_gdm_pe" %in% names(pregnancy_d3_mig)){pregnancy_d3_mig[,op_end_date_gdm_pe:=NULL]}
if("op_end_date_du" %in% names(pregnancy_d3_mig)){pregnancy_d3_mig[,op_end_date_du:=NULL]}
if("op_end_date_saf" %in% names(pregnancy_d3_mig)){pregnancy_d3_mig[,op_end_date_saf:=NULL]}
if("op_start_date_gdm_pe" %in% names(pregnancy_d3_mig)){pregnancy_d3_mig[,op_start_date_gdm_pe:=NULL]}
if("op_start_date_du" %in% names(pregnancy_d3_mig)){pregnancy_d3_mig[,op_start_date_du:=NULL]}
if("op_start_date_saf" %in% names(pregnancy_d3_mig)){pregnancy_d3_mig[,op_start_date_saf:=NULL]}
if("sex_at_instance_creation" %in% names(pregnancy_d3_mig)){pregnancy_d3_mig[,sex_at_instance_creation:=NULL]}
if("final_d3" %in% list.files(paste0(projectFolder,"/g_intermediate/migraine_algorithm/"))){
unlink(paste0(projectFolder,"/g_intermediate/migraine_algorithm/final_d3"), recursive = T)
}
orig_mig<-pregnancy_d3_mig[,.N]
####Migraine DIAGNOSES FILES####
print("Loading all Migraine diagnoses D3 and merge with the pregnancy D3.")
if(DAP_name %in% c("CHUT")){
obs_period_diag<-data.table(StudyVar=c("MG","MG_NO_AURA","MG_AURA","MG_STATUS","MG_OTHER","MG_UNSP","MG_COMP"),
lookback=c(3*30.25,3*30.25,3*30.25,3*30.25,3*30.25,3*30.25,3*30.25),
start_date=c(0,0,0,0,0,0,0),
end_date=c(7*40,7*40,7*40,7*40,7*40,7*40,7*40),
after=c(0,0,0,0,0,0,0))
}else{
obs_period_diag<-data.table(StudyVar=c("MG","MG_NO_AURA","MG_AURA","MG_STATUS","MG_OTHER","MG_UNSP","MG_COMP"),
lookback=c(365.25,365.25,365.25,365.25,365.25,365.25,365.25),
start_date=c(0,0,0,0,0,0,0),
end_date=c(7*40,7*40,7*40,7*40,7*40,7*40,7*40),
after=c(0,0,0,0,0,0,0))
}
#trimester dates
trimester_timepoint<-data.table(Indicator=c("first","second","third"),
start=c(0,98,196),
end=c(97,195,7*40))
#start: pregnancy start date + start -1 will give the next window
#end: pregnancy start date + start will give the previous window
#example second trimester: start=pregnancy start date + 98 -1 end=pregnancy start date + end
#mig files
mig_files<-list.files(paste0(projectFolder,"/g_intermediate/migraine_algorithm/"))
mig_files<-mig_files[!mig_files %in% "Migraine_medicines.rds"]
names_events<-list()
for(i in 1:length(mig_files)){
names_events[[i]]<-unlist(str_split(mig_files[i],"[.]"))[1]
}
names_events<-as.vector(do.call(rbind,names_events))
names_events_extend<-c(paste0(names_events,"_baseline"),paste0(names_events,"_baseline_2"),paste0(names_events,"_during"),paste0(names_events,"_first"),paste0(names_events,"_second"),paste0(names_events,"_third"))
#Add onset diagnoses and mendication variable to the pregnancy d3
pregnancy_d3_mig[,onset_diag:=0][,onset_med:=0]
####Exclude all onset diagnoses of migraine####
#Create an exclude variable that will be used to exclude pregnancies with onset migraine diagnoses or triptan prescription in pregnancy
#Check only MG diagnoses files as it inlcuded all children codes
files_mg<-mig_files[str_detect(mig_files,"MG.rds")]
names_mg<-names_events[names_events %in% "MG"]
mig_dt<-readRDS(paste0(projectFolder,"/g_intermediate/migraine_algorithm/", files_mg))
#merge with the pregnancy d3
mig_dt<-merge.data.table(pregnancy_d3_mig, mig_dt, by="person_id", all.x=T, allow.cartesian = T)
mig_dt<-mig_dt[!is.na(event_date)]
if("keep" %in% names(mig_dt)){mig_dt[,keep:=NULL]}
if(mig_dt[,.N]>0){
mig_dt[,event_date:=as.IDate(event_date)]
#remove all records 1 year before start of pregnancy
if(obs_period_diag[StudyVar==names_mg,lookback]>0){
mig_dt[,lookback:=obs_period_diag[StudyVar==names_mg,lookback]]
mig_dt[,start_preg:=as.IDate(pregnancy_start_date-lookback)]
#exclude all events that are outside observation period of interest
mig_dt[,diff:=event_date-start_preg]
#remove all records with date before start date pregnancy+lookback
mig_dt<-mig_dt[diff>=0]
mig_dt[,diff:=NULL][,lookback:=NULL][,start_preg:=NULL]
}else{
#remove all records before start obs
mig_dt[,start:=obs_period_diag[StudyVar==names_mg,start_date]]
mig_dt[,start_preg:=as.IDate(pregnancy_start_date+start)]
mig_dt[,diff:=event_date-start_preg]
mig_dt<-mig_dt[diff>=0]
mig_dt[,diff:=NULL][,start:=NULL][,start_preg:=NULL]
}
if(mig_dt[,.N]>0){
if(obs_period_diag[StudyVar==names_mg,after]>0){
mig_dt[,after:=obs_period_diag[StudyVar==names_mg,after]]
mig_dt[,end_preg:=as.IDate(pregnancy_end_date+after)]
mig_dt[,diff:=event_date-end_preg]
mig_dt<-mig_dt[diff<=0]
mig_dt[,diff:=NULL][,after:=NULL][,end_preg:=NULL]
}else{
mig_dt[,end:=obs_period_diag[StudyVar==names_mg,end_date]]
mig_dt[,end_preg:=as.IDate(pregnancy_start_date+end)]
mig_dt[,diff:=event_date-end_preg]
mig_dt<-mig_dt[diff<=0]
mig_dt[,diff:=NULL][,end:=NULL][,end_preg:=NULL]
}
}
if(mig_dt[,.N]>0){
#Check for diagnoses before start date of pregnancy(12 months before start date)
mig_dt[,min_date_diag:=pregnancy_start_date-obs_period_diag[StudyVar==names_mg,lookback]]
mig_dt[,prior_diag:=ifelse(event_date>=min_date_diag & event_date<pregnancy_start_date,1,0)]
#Check for diagnoses in pregnancy
mig_dt[,preg_diag:=ifelse(event_date>=pregnancy_start_date & event_date<=pregnancy_end_date,1,0)]
#add preg id
mig_dt[,preg_diag:=as.numeric(preg_diag)][,prior_diag:=as.numeric(prior_diag)]
prior_diag<-mig_dt[prior_diag==1,.N, by=c("person_id","pregnancy_id")]
setnames(prior_diag,"N","prior_diag")
preg_diag<-mig_dt[preg_diag==1,.N, by=c("person_id","pregnancy_id")]
setnames(preg_diag,"N","preg_diag")
prior_diag<-merge.data.table(prior_diag,preg_diag, all=T, by=c("person_id","pregnancy_id"))
prior_diag[is.na(prior_diag),prior_diag:=0]
prior_diag[is.na(preg_diag),preg_diag:=0]
prior_diag<-prior_diag[prior_diag==0 & preg_diag>0]
#Count the number of cases to exclude
excluded_prior_diag<-data.table(event_definition=names_mg, excluded_records=prior_diag[,.N])
prior_diag[,prior_diag:=NULL]
#Add the identifier pregnancy id to the main pregnancy D3
pregnancy_d3_mig<-merge.data.table(pregnancy_d3_mig,prior_diag, by=c("person_id","pregnancy_id"), all.x=T)
#update the exclude variable
pregnancy_d3_mig[preg_diag>0, onset_diag:=1]
pregnancy_d3_mig[,preg_diag:=NULL]
pregnancy_d3_mig[is.na(onset_diag), onset_diag:=0]
}
}
rm(mig_dt)
print("Loading all Migraine medicines D3 and merge with the pregnancy D3.")
if (DAP_name %in% c("NIHW", "CHUT")){
obs_period_med<-data.table(StudyVar=c("Migraine_medicines"),
lookback=c(3*30.25),
start_date=c(0),
end_date=c(40*7),
after=c(0))
}else{
obs_period_med<-data.table(StudyVar=c("Migraine_medicines"),
lookback=c(365.25),
start_date=c(0),
end_date=c(40*7),
after=c(0))
}
####Exclude all onset prescriptions of migraine####
mig_med_fl<-list.files(paste0(projectFolder,"/g_intermediate/migraine_algorithm/"),"Migraine_medicines")
mig_med<-readRDS(paste0(projectFolder,"/g_intermediate/migraine_algorithm/",mig_med_fl))
View(mig_med)
mig_med[,truncated_atc:=substr(atc_code,1,5)]
mig_med<-mig_med[truncated_atc == "N02CC"]
mig_med[,truncated_atc:=NULL]
View(mig_med)
mig_med<-merge.data.table(pregnancy_d3_mig, mig_med, by="person_id", all.x=T, allow.cartesian = T)
View(mig_med)
mig_med<-mig_med[!is.na(medicine_date)]
mig_med[,pregnancy_start_date:=as.IDate(pregnancy_start_date)][,pregnancy_end_date:=as.IDate(pregnancy_end_date)][,birth_date:=as.IDate(birth_date)][,death_date:=as.IDate(death_date)][,op_start_date_mig:=as.IDate(op_start_date_mig)][,op_end_date_mig:=as.IDate(op_end_date_mig)][,medicine_date:=as.IDate(medicine_date)]
obs_period_med[med_fl,lookback]
mig_med[,lookback:=obs_period_med[med_fl,lookback]]
mig_med[,start_preg:=as.IDate(pregnancy_start_date-lookback)]
#exclude all records that are outside observation period of interest
mig_med[,diff:=medicine_date-start_preg]
View(mig_med)
if(obs_period_med[med_fl,lookback]>0){
mig_med[,lookback:=obs_period_med[med_fl,lookback]]
mig_med[,start_preg:=as.IDate(pregnancy_start_date-lookback)]
#exclude all records that are outside observation period of interest
mig_med[,diff:=medicine_date-start_preg]
#remove all records with date before start date pregnancy+lookback
mig_med<-mig_med[diff>=0]
mig_med[,diff:=NULL][,lookback:=NULL][,start_preg:=NULL]
}else{
#remove all records before start obs
mig_med[,start:=obs_period_med[med_fl,start_date]]
mig_med[,start_preg:=as.IDate(pregnancy_start_date+start)]
mig_med[,diff:=medicine_date-start_preg]
mig_med<-mig_med[diff>=0]
mig_med[,diff:=NULL][,start:=NULL][,start_preg:=NULL]
}
obs_period_med[med_fl,after]>0
obs_period_med[med_fl,after]
if(mig_med[,.N]>0){
#remove all records after end of pregnancy
if(obs_period_med[med_fl,after]>0){
mig_med[,after:=obs_period_med[med_fl,after]]
mig_med[,end_preg:=as.IDate(pregnancy_end_date+after)]
mig_med[,diff:=medicine_date-end_preg]
mig_med<-mig_med[diff<=0]
mig_med[,diff:=NULL][,after:=NULL][,end_preg:=NULL]
}else{
mig_med[,end:=obs_period_med[med_fl,end_date]]
mig_med[,end_preg:=as.IDate(pregnancy_start_date+end)]
mig_med[,diff:=medicine_date-end_preg]
mig_med<-mig_med[diff<=0]
mig_med[,diff:=NULL][,end:=NULL][,end_preg:=NULL]
}
}
mig_med[,min_date_med:=pregnancy_start_date-obs_period_med[med_fl,lookback]]
mig_med[,prior_med:=ifelse(medicine_date>=min_date_med & medicine_date<pregnancy_start_date,1,0)]
View(mig_med)
View(mig_med)
#Check for prescriptions in pregnancy
mig_med[,preg_med:=ifelse(medicine_date>=pregnancy_start_date & medicine_date<=pregnancy_end_date,1,0)]
#add preg id
mig_med[,preg_med:=as.numeric(preg_med)]
View(mig_med)
prior_med<-mig_med[prior_med==1,.N, by=c("person_id","pregnancy_id")]
setnames(prior_med,"N","prior_med")
preg_med<-mig_med[preg_med==1,.N, by=c("person_id","pregnancy_id")]
setnames(preg_med,"N","preg_med")
rm(mig_med)
View(prior_med)
prior_med<-merge.data.table(prior_med,preg_med, all=T, by=c("person_id","pregnancy_id"))
View(prior_med)
prior_med[is.na(prior_med),prior_med:=0]
prior_med[is.na(preg_med),preg_med:=0]
View(prior_med)
prior_med<-prior_med[prior_med==0 & preg_med>0]
#Count the number of cases to exclude
excluded_prior_med<-data.table(event_definition="Triptan_prescription(N02CC)", excluded_records=prior_med[,.N])
prior_med[,prior_med:=NULL]
#Add the identifier pregnancy id to the main pregnancy D3
pregnancy_d3_mig<-merge.data.table(pregnancy_d3_mig,prior_med, by=c("person_id","pregnancy_id"), all.x=T)
View(pregnancy_d3_mig)
prior_med
#update the exclude variable
pregnancy_d3_mig[!is.na(preg_med), onset_med:=1]
View(pregnancy_d3_mig)
pregnancy_d3_mig[,preg_med:=NULL]
pregnancy_d3_mig[is.na(onset_med),onset_med:=0]
onset_diag<-pregnancy_d3_mig[onset_diag==1 & onset_med==0,.N]
#number of pregnancies with onset prescription
onset_med<-pregnancy_d3_mig[onset_diag==0 & onset_med==1,.N]
#number of pregnancies with onset of diag and pres
onset_both<-pregnancy_d3_mig[onset_diag==1 & onset_med==1,.N]
#excluded preg
excluded_preg<-pregnancy_d3_mig[onset_diag==1 | onset_med==1,.N]
pregnancy_d3_mig<-pregnancy_d3_mig[onset_diag==0 & onset_med==0]
included_preg<-pregnancy_d3_mig[,.N]
pregnancy_d3_mig[,onset_diag:=NULL][,onset_med:=NULL]
excluded_preg_flowchart<-data.table(Indicator=c("1.0. Number of pregnancies before exclusions",
"1.1. Number of pregnancies with onset diagnoses of migraine only",
"1.2. Number of pregnancies with onset prescription of triptans only",
"1.3. Number of pregnancies with onset diagnoses of migraine and prescription of triptans",
"1.4. Number of excluded pregnancies",
"1.5. Number of included pregnancies"),
Count=c(orig_mig,
onset_diag,
onset_med,
onset_both,
excluded_preg,
included_preg))
rm(orig_mig,onset_diag,onset_med,onset_both,excluded_preg,included_preg)
fwrite(excluded_preg_flowchart, paste0(projectFolder,"/g_output/Migraine algorithm/Step_04_excluded_pregnancies_onset_diag_med.csv"), row.names = F)
rm(excluded_preg_flowchart)
#delete the first version of the pregnancy D3 and save this one
file.remove(paste0(projectFolder,"/g_intermediate/pregnancy_d3/MIG_Pregnancy_D3.rds"))
saveRDS(pregnancy_d3_mig,paste0(projectFolder,"/g_intermediate/pregnancy_d3/MIG_Pregnancy_D3.rds"))
####Migraine DIAGNOSES####
original<-list()
before<-list()
after<-list()
sum<-list()
dir.create(paste0(projectFolder,"/g_intermediate/migraine_algorithm/final_d3"))
w<-1
for(mig_fl in 1:length(mig_files)){
mig_dt<-readRDS(paste0(projectFolder,"/g_intermediate/migraine_algorithm/", mig_files[mig_fl]))
#merge with the pregnancy d3
mig_dt<-merge.data.table(pregnancy_d3_mig, mig_dt, by="person_id", all.x=T, allow.cartesian = T)
mig_dt<-mig_dt[!is.na(event_date)]
if(mig_dt[,.N]>0){
original[[w]]<-data.table(StudyVar=names_events[mig_fl], event_records=mig_dt[,.N])
mig_dt[,event_date:=as.IDate(event_date)]
if(obs_period_diag[StudyVar==names_events[mig_fl],lookback]>0){
mig_dt[,lookback:=obs_period_diag[StudyVar==names_events[mig_fl],lookback]]
mig_dt[,start_preg:=as.IDate(pregnancy_start_date-lookback)]
#exclude all events that are outside observation period of interest
mig_dt[,diff:=event_date-start_preg]
#remove all records with date before start date pregnancy+lookback
before[[w]]<-data.table(StudyVar=names_events[mig_fl], before_start=mig_dt[diff<0,.N])
mig_dt<-mig_dt[diff>=0]
mig_dt[,diff:=NULL][,lookback:=NULL][,start_preg:=NULL]
}else{
#remove all records before start obs
mig_dt[,start:=obs_period_diag[StudyVar==names_events[mig_fl],start_date]]
mig_dt[,start_preg:=as.IDate(pregnancy_start_date+start)]
mig_dt[,diff:=event_date-start_preg]
before[[w]]<-data.table(StudyVar=names_events[mig_fl], before_start=mig_dt[diff<0,.N])
mig_dt<-mig_dt[diff>=0]
mig_dt[,diff:=NULL][,start:=NULL][,start_preg:=NULL]
}
if(mig_dt[,.N]>0){
if(obs_period_diag[StudyVar==names_events[mig_fl],after]>0){
mig_dt[,after:=obs_period_diag[StudyVar==names_events[mig_fl],after]]
mig_dt[,end_preg:=as.IDate(pregnancy_end_date+after)]
mig_dt[,diff:=event_date-end_preg]
after[[w]]<-data.table(StudyVar=names_events[mig_fl], after_end=mig_dt[diff>0,.N])
mig_dt<-mig_dt[diff<=0]
mig_dt[,diff:=NULL][,after:=NULL][,end_preg:=NULL]
}else{
mig_dt[,end:=obs_period_diag[StudyVar==names_events[mig_fl],end_date]]
mig_dt[,end_preg:=as.IDate(pregnancy_start_date+end)]
mig_dt[,diff:=event_date-end_preg]
after[[w]]<-data.table(StudyVar=names_events[mig_fl], after_end=mig_dt[diff>0,.N])
mig_dt<-mig_dt[diff<=0]
mig_dt[,diff:=NULL][,end:=NULL][,end_preg:=NULL]
}
}else{
after[[w]]<-data.table(StudyVar=names_events[mig_fl], after_end=0)
}
if(mig_dt[,.N]>0){
#create a summary of included records
sum[[w]]<-data.table(StudyVar=names_events[mig_fl], no_records=mig_dt[!is.na(event_date),.N], no_pregnancies=mig_dt[!duplicated(pregnancy_id),.N])
saveRDS(mig_dt, paste0(projectFolder,"/g_intermediate/migraine_algorithm/final_d3/", names_events[mig_fl],"_pregnancy_D3.rds"))
cols<-c("person_id","pregnancy_id","pregnancy_start_date","pregnancy_end_date","event_date")
mig_dt<-mig_dt[,cols,with=F]
#Identify all baseline events
mig_dt[,dif:=event_date-pregnancy_start_date]
mig_dt[dif<0,paste0(names_events[mig_fl],"_baseline"):=1]
mig_baseline<-mig_dt[get(paste0(names_events[mig_fl],"_baseline"))==1,lapply(.SD, sum),.SDcols = paste0(names_events[mig_fl],"_baseline"), by=c("person_id","pregnancy_id","pregnancy_start_date","pregnancy_end_date")]
mig_dt[,dif:=NULL][,eval(paste0(names_events[mig_fl],"_baseline")):=NULL]
pregnancy_d3_mig<-merge.data.table(pregnancy_d3_mig,mig_baseline,all.x=T, by=cols[!cols %in% "event_date"])
pregnancy_d3_mig[is.na(get(paste0(names_events[mig_fl],"_baseline"))),eval(paste0(names_events[mig_fl],"_baseline")):=0]
#depending on the DAP
if(!DAP_name %in% c("CHUT")){
mig_dt[,start:=pregnancy_start_date - 3*30.25]
mig_dt[event_date>=start & event_date<pregnancy_start_date,paste0(names_events[mig_fl],"_baseline_2"):=1]
mig_baseline_2<-mig_dt[get(paste0(names_events[mig_fl],"_baseline_2"))==1,lapply(.SD, sum),.SDcols = paste0(names_events[mig_fl],"_baseline_2"), by=c("person_id","pregnancy_id","pregnancy_start_date","pregnancy_end_date")]
mig_dt[,start:=NULL][,eval(paste0(names_events[mig_fl],"_baseline_2")):=NULL]
pregnancy_d3_mig<-merge.data.table(pregnancy_d3_mig,mig_baseline_2,all.x=T, by=cols[!cols %in% "event_date"])
pregnancy_d3_mig[is.na(get(paste0(names_events[mig_fl],"_baseline_2"))),eval(paste0(names_events[mig_fl],"_baseline_2")):=0]
}else{
pregnancy_d3_mig[,eval(paste0(names_events[mig_fl],"_baseline_2")):=get(paste0(names_events[mig_fl],"_baseline"))]
}
#during pregnancy
mig_dt[event_date>=pregnancy_start_date & event_date<pregnancy_end_date,paste0(names_events[mig_fl],"_during"):=1]
mig_during<-mig_dt[get(paste0(names_events[mig_fl],"_during"))==1,lapply(.SD, sum),.SDcols = paste0(names_events[mig_fl],"_during"), by=c("person_id","pregnancy_id","pregnancy_start_date","pregnancy_end_date")]
mig_dt[,eval(paste0(names_events[mig_fl],"_during")):=NULL]
pregnancy_d3_mig<-merge.data.table(pregnancy_d3_mig,mig_during,all.x=T, by=cols[!cols %in% "event_date"])
pregnancy_d3_mig[is.na(get(paste0(names_events[mig_fl],"_during"))),eval(paste0(names_events[mig_fl],"_during")):=0]
#first
mig_dt[,start:=pregnancy_start_date + trimester_timepoint[Indicator=="first",as.numeric(start)]][,end:=pregnancy_start_date + trimester_timepoint[Indicator=="first",as.numeric(end)]]
mig_dt[event_date>=start & event_date<=end,paste0(names_events[mig_fl],"_first"):=1]
mig_first<-mig_dt[get(paste0(names_events[mig_fl],"_first"))==1,lapply(.SD, sum),.SDcols = paste0(names_events[mig_fl],"_first"), by=c("person_id","pregnancy_id","pregnancy_start_date","pregnancy_end_date")]
mig_dt[,eval(paste0(names_events[mig_fl],"_first")):=NULL]
pregnancy_d3_mig<-merge.data.table(pregnancy_d3_mig,mig_first,all.x=T, by=cols[!cols %in% "event_date"])
pregnancy_d3_mig[is.na(get(paste0(names_events[mig_fl],"_first"))),eval(paste0(names_events[mig_fl],"_first")):=0]
#second
mig_dt[,start:=pregnancy_start_date + trimester_timepoint[Indicator=="second",as.numeric(start)]][,end:=pregnancy_start_date + trimester_timepoint[Indicator=="second",as.numeric(end)]]
mig_dt[event_date>=start & event_date<=end,paste0(names_events[mig_fl],"_second"):=1]
mig_second<-mig_dt[get(paste0(names_events[mig_fl],"_second"))==1,lapply(.SD, sum),.SDcols = paste0(names_events[mig_fl],"_second"), by=c("person_id","pregnancy_id","pregnancy_start_date","pregnancy_end_date")]
mig_dt[,eval(paste0(names_events[mig_fl],"_second")):=NULL]
pregnancy_d3_mig<-merge.data.table(pregnancy_d3_mig,mig_second,all.x=T, by=cols[!cols %in% "event_date"])
pregnancy_d3_mig[is.na(get(paste0(names_events[mig_fl],"_second"))),eval(paste0(names_events[mig_fl],"_second")):=0]
#third
mig_dt[,start:=pregnancy_start_date + trimester_timepoint[Indicator=="third",as.numeric(start)]][,end:=pregnancy_start_date + trimester_timepoint[Indicator=="third",as.numeric(end)]]
mig_dt[event_date>=start & event_date<=end,paste0(names_events[mig_fl],"_third"):=1]
mig_third<-mig_dt[get(paste0(names_events[mig_fl],"_third"))==1,lapply(.SD, sum),.SDcols = paste0(names_events[mig_fl],"_third"), by=c("person_id","pregnancy_id","pregnancy_start_date","pregnancy_end_date")]
mig_dt[,eval(paste0(names_events[mig_fl],"_third")):=NULL]
pregnancy_d3_mig<-merge.data.table(pregnancy_d3_mig,mig_third,all.x=T, by=cols[!cols %in% "event_date"])
pregnancy_d3_mig[is.na(get(paste0(names_events[mig_fl],"_third"))),eval(paste0(names_events[mig_fl],"_third")):=0]
}else{
pregnancy_d3_mig[,eval(paste0(names_events[mig_fl],"_baseline")):=0]
pregnancy_d3_mig[,eval(paste0(names_events[mig_fl],"_baseline_2")):=0]
pregnancy_d3_mig[,eval(paste0(names_events[mig_fl],"_during")):=0]
pregnancy_d3_mig[,eval(paste0(names_events[mig_fl],"_first")):=0]
pregnancy_d3_mig[,eval(paste0(names_events[mig_fl],"_second")):=0]
pregnancy_d3_mig[,eval(paste0(names_events[mig_fl],"_third")):=0]
}
}else{
pregnancy_d3_mig[,eval(paste0(names_events[mig_fl],"_baseline")):=0]
pregnancy_d3_mig[,eval(paste0(names_events[mig_fl],"_baseline_2")):=0]
pregnancy_d3_mig[,eval(paste0(names_events[mig_fl],"_during")):=0]
pregnancy_d3_mig[,eval(paste0(names_events[mig_fl],"_first")):=0]
pregnancy_d3_mig[,eval(paste0(names_events[mig_fl],"_second")):=0]
pregnancy_d3_mig[,eval(paste0(names_events[mig_fl],"_third")):=0]
}
rm(mig_dt)
w<-w+1
}
#Combine files
original<-as.data.table(do.call(rbind,original))
before<-as.data.table(do.call(rbind,before))
after<-as.data.table(do.call(rbind,after))
if(sum(length(original),length(before))>0){
removed_rec<-merge.data.table(original,before,by="StudyVar",all=T)
}else{
removed_rec<-NULL
}
if(sum(length(removed_rec),length(after))>0){
removed_rec<-merge.data.table(removed_rec,after,by="StudyVar",all=T)
removed_rec[is.na(before_start),before_start:="N/A"]
removed_rec[is.na(after_end),after_end:="N/A"]
setnames(removed_rec,"event_records","original_records")
}else{
removed_rec<-NULL
}
#Pregnancies that had the event of interest not in the timeframe of study were excluded, this is why the number of pregnancies is different between different events
sum_mig<-as.data.table(do.call(rbind,sum))
rm(original,before,after,sum)
rm(mig_files)
fwrite(sum_mig,paste0(projectFolder,"/g_output/Migraine algorithm/Step_04_summary_included_records_migraine.csv"),row.names = F)
rm(sum_mig)
names_migraine<-c(paste0(names(conditions_migraine),"_baseline"),paste0(names(conditions_migraine),"_baseline_2"),paste0(names(conditions_migraine),"_during"),paste0(names(conditions_migraine),"_first"),paste0(names(conditions_migraine),"_second"),paste0(names(conditions_migraine),"_third"))
#identify events that are not present from conditions_migraine
not_present<-setdiff(names_migraine, names_events_extend)
pregnancy_d3_mig[,eval(not_present):=list(0)]
mig_med_fl<-list.files(paste0(projectFolder,"/g_intermediate/migraine_algorithm/"),"Migraine_medicines")
mig_med<-readRDS(paste0(projectFolder,"/g_intermediate/migraine_algorithm/",mig_med_fl))
####Clean pregnancies####
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source(paste0(projectFolder,"/p_steps/clean_folders.R"))
source("99_path.R")
setwd(projectFolder)
#Run pregnancy algorithm and save results in g_intermediate/pregnancy_algorithm
source(paste0(pre_dir,"Step_00_create_clean_pregnancy_D3.R"))
render(paste0(pre_dir,"Report_0_pregnancy_algorithm_flowchart.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_0_Pregnancy_algorithm_flowchart.html"))
source(paste0(pre_dir,"save_environment.R"))
####Create pregnancy study population####
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source("99_path.R")
setwd(projectFolder)
#Create study population(persons/observation_periods/pregnancies)
load(paste0(g_intermediate,"environment.RData"))
source(paste0(pre_dir,"Step_01_create_study_population.R"))
render(paste0(pre_dir,"Report_1_pregnancy_study_population.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_1_Pregnancy_study_population.html"))
source(paste0(pre_dir,"save_environment.R"))
####Run diagnostic filtering script####
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source("99_path.R")
setwd(projectFolder)
#Create diagnoses D3(GDM/PE/Migraine)
load(paste0(g_intermediate,"environment.RData"))
source(paste0(pre_dir,"Step_02_diagnoses_clean_up.R"))
source(paste0(pre_dir,"Step_02_diagnoses_clean_up_combine.R"))
render(paste0(pre_dir,"Report_2_diagnoses_clean_up.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_2_Diagnoses_clean_up.html"))
source(paste0(pre_dir,"save_environment.R"))
####Run medicines filtering script####
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source("99_path.R")
setwd(projectFolder)
#Create medicines D3(GDM/PE/Migraine)
load(paste0(g_intermediate,"environment.RData"))
source(paste0(pre_dir,"Step_03_medicines_clean_up.R"))
source(paste0(pre_dir,"Step_03_medicines_clean_up_combine.R"))
render(paste0(pre_dir,"Report_3_medicines_clean_up.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_3_Medicines_clean_up.html"))
source(paste0(pre_dir,"save_environment.R"))
####Create algorithms for GDM/PE/Migraine####
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source("99_path.R")
setwd(projectFolder)
load(paste0(g_intermediate,"environment.RData"))
source(paste0(pre_dir,"Step_04_algorithms.R"))
render(paste0(pre_dir,"Report_4_gdm_pe_algorithms.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_4_gdm_pe_algorithms.html"))
render(paste0(pre_dir,"Report_4_migraine_algorithms.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_4_migraine_algorithms.html"))
source(paste0(pre_dir,"save_environment.R"))
