rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source("99_path.R")
setwd(projectFolder)
source(paste0(pre_dir,"Pregnancy algorithm/to_run.R"))
#Load the final pregnancy D3
rm(list=setdiff(ls(), "projectFolder"))
setwd(projectFolder)
source("99_path.R")
setwd(projectFolder)
#Load study parameters
source(paste0(projectFolder,"/p_steps/info/DAP_info.R"))
source(paste0(projectFolder,"/p_steps/parameters/study_parameters.R"))
####Load the final pregnancy D3####
preg_file<-list.files(paste0(thisdir,"/g_output/"), "pregnancy_final")
#decluter environment and set up the 99_path again
get(load(paste0(thisdir,"/g_output/", preg_file)))
pregnancy_D3<-D3_pregnancy_final
rm(D3_pregnancy_final)
pregnancy_D3[,pregnancy_start_date:=as.IDate(pregnancy_start_date)]
pregnancy_D3[,pregnancy_end_date:=as.IDate(pregnancy_end_date)]
original_rows<-pregnancy_D3[,.N]
####keep only green records####
#count number of records that are removed
yellow_rec<-pregnancy_D3[highest_quality=="2_yellow",.N]
blue_rec<-pregnancy_D3[highest_quality=="3_blue",.N]
red_rec<-pregnancy_D3[highest_quality=="4_red",.N]
not_green_rec<-pregnancy_D3[highest_quality!="1_green",.N]
removed_rec<-data.table(Indicator="Pregnancy records",
Quality=c("yellow","blue","red"),
removed_records=c(yellow_rec,blue_rec,red_rec),
percentage=c(round((yellow_rec/pregnancy_D3[,.N])*100,1),
round((blue_rec/pregnancy_D3[,.N])*100,1),
round((red_rec/pregnancy_D3[,.N])*100,1)))
rm(yellow_rec,blue_rec,red_rec)
fwrite(removed_rec,paste0(output_dir, "Pregnancy algorithm/other_quality_records_removed.csv"), row.names = F)
pregnancy_D3<-pregnancy_D3[highest_quality=="1_green"]
####check for issues####
issues_preg_alg_sex<-pregnancy_D3[sex_at_instance_creation!="F",.N]
pregnancy_D3<-pregnancy_D3[sex_at_instance_creation=="F"]
issues_preg_alg_date<-pregnancy_D3[is.na(pregnancy_start_date)|is.na(pregnancy_end_date),.N]
pregnancy_D3<-pregnancy_D3[!is.na(pregnancy_start_date) & !is.na(pregnancy_end_date)]
issues_preg_alg_pid<-pregnancy_D3[is.na(person_id),.N]
pregnancy_D3<-pregnancy_D3[!is.na(person_id)]
issues_preg_alg_prid<-pregnancy_D3[is.na(pregnancy_id),.N]
pregnancy_D3<-pregnancy_D3[!is.na(pregnancy_id)]
#calculate gestational age and exclude all records with gestational age>43 weeks(301 days)
pregnancy_D3[,diff:=pregnancy_end_date- pregnancy_start_date]
issues_preg_alg_ga<-pregnancy_D3[diff>=301,.N]
pregnancy_D3<-pregnancy_D3[diff<301]
pregnancy_D3[,diff:=NULL]
incl_rec<-pregnancy_D3[,.N]
Indicator<-c("Number of original records from the pregnancy algorithm",
"Number of records with quality other than green",
"Records with sex other than female",
"Records with missing start or end date of pregnancy or both",
"Records with missing person id",
"Records with missing pregnancy id",
"Records where gestational age is longer than 43 weeks(301 days)",
"Records left after exclusions")
placeholder<-c(original_rows,not_green_rec,issues_preg_alg_sex,issues_preg_alg_date,issues_preg_alg_pid,issues_preg_alg_prid,issues_preg_alg_ga,incl_rec)
issues<-data.table(Indicator=Indicator, Count=placeholder)
rm(Indicator,placeholder)
rm(issues_preg_alg_sex,not_green_rec,issues_preg_alg_date,issues_preg_alg_pid,issues_preg_alg_prid,issues_preg_alg_ga,incl_rec)
fwrite(issues,paste0(output_dir, "Pregnancy algorithm/issues_flowchart_pregnancy_D3.csv"), row.names = F)
rm(issues)
#Load the final pregnancy D3
rm(list=setdiff(ls(), "projectFolder"))
setwd(projectFolder)
source("99_path.R")
setwd(projectFolder)
#Load study parameters
source(paste0(projectFolder,"/p_steps/info/DAP_info.R"))
source(paste0(projectFolder,"/p_steps/parameters/study_parameters.R"))
####Load the final pregnancy D3####
preg_file<-list.files(paste0(thisdir,"/g_output/"), "pregnancy_final")
#decluter environment and set up the 99_path again
get(load(paste0(thisdir,"/g_output/", preg_file)))
pregnancy_D3<-D3_pregnancy_final
rm(D3_pregnancy_final)
pregnancy_D3[,pregnancy_start_date:=as.IDate(pregnancy_start_date)]
pregnancy_D3[,pregnancy_end_date:=as.IDate(pregnancy_end_date)]
original_rows<-pregnancy_D3[,.N]
####keep only green records####
#count number of records that are removed
yellow_rec<-pregnancy_D3[highest_quality=="2_yellow",.N]
blue_rec<-pregnancy_D3[highest_quality=="3_blue",.N]
red_rec<-pregnancy_D3[highest_quality=="4_red",.N]
not_green_rec<-pregnancy_D3[highest_quality!="1_green",.N]
removed_rec<-data.table(Indicator="Pregnancy records",
Quality=c("yellow","blue","red"),
removed_records=c(yellow_rec,blue_rec,red_rec),
percentage=c(round((yellow_rec/pregnancy_D3[,.N])*100,1),
round((blue_rec/pregnancy_D3[,.N])*100,1),
round((red_rec/pregnancy_D3[,.N])*100,1)))
rm(yellow_rec,blue_rec,red_rec)
fwrite(removed_rec,paste0(output_dir, "Pregnancy algorithm/other_quality_records_removed.csv"), row.names = F)
pregnancy_D3<-pregnancy_D3[highest_quality=="1_green"]
####check for issues####
issues_preg_alg_sex<-pregnancy_D3[sex_at_instance_creation!="F",.N]
pregnancy_D3<-pregnancy_D3[sex_at_instance_creation=="F"]
issues_preg_alg_date<-pregnancy_D3[is.na(pregnancy_start_date)|is.na(pregnancy_end_date),.N]
pregnancy_D3<-pregnancy_D3[!is.na(pregnancy_start_date) & !is.na(pregnancy_end_date)]
issues_preg_alg_pid<-pregnancy_D3[is.na(person_id),.N]
pregnancy_D3<-pregnancy_D3[!is.na(person_id)]
issues_preg_alg_prid<-pregnancy_D3[is.na(pregnancy_id),.N]
pregnancy_D3<-pregnancy_D3[!is.na(pregnancy_id)]
#calculate gestational age and exclude all records with gestational age>43 weeks(301 days)
pregnancy_D3[,diff:=pregnancy_end_date- pregnancy_start_date]
issues_preg_alg_ga<-pregnancy_D3[diff>=301,.N]
pregnancy_D3<-pregnancy_D3[diff<301]
pregnancy_D3[,diff:=NULL]
incl_rec<-pregnancy_D3[,.N]
Indicator<-c("Number of original records from the pregnancy algorithm",
"Number of records with quality other than green",
"Records with sex other than female",
"Records with missing start or end date of pregnancy or both",
"Records with missing person id",
"Records with missing pregnancy id",
"Records where gestational age is longer than 43 weeks(301 days)",
"Records left after exclusions")
placeholder<-c(original_rows,not_green_rec,issues_preg_alg_sex,issues_preg_alg_date,issues_preg_alg_pid,issues_preg_alg_prid,issues_preg_alg_ga,incl_rec)
issues<-data.table(Indicator=Indicator, Count=placeholder)
rm(Indicator,placeholder)
rm(issues_preg_alg_sex,not_green_rec,issues_preg_alg_date,issues_preg_alg_pid,issues_preg_alg_prid,issues_preg_alg_ga,incl_rec)
fwrite(issues,paste0(output_dir, "Pregnancy algorithm/issues_flowchart_pregnancy_D3.csv"), row.names = F)
View(issues)
