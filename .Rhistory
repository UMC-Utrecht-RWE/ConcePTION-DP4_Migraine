mig_start_preg_lookback<- min_preg_date_mig + as.numeric(opt_lookback)
}
study_dates
####Load CDM Source table####
if(length(list.files(path_dir,"^CDM_SOURCE"))>1){
stop("More than one CDM SOURCE table is present in the working directory. Fix error and run the script again.")
}
CDM_SOURCE<-fread(paste0(path_dir, list.files(path_dir,"^CDM_SOURCE")))
#####Load study dates template####
study_dates_file<-list.files(paste0(projectFolder,"/p_steps/parameters/"), "study_dates")
study_dates<-read_excel(paste0(projectFolder,"/p_steps/parameters/",study_dates_file),col_types = "text")
study_dates<-as.data.table(study_dates)
#Keep only needed information based on the DAP
study_dates<-study_dates[DAP==data_access_provider_name]
if(study_dates[,.N]==0){
stop("This is not a script issue. There is no data for your data source in study_dates. Fix the issue and then rerun the script.")
}
study_dates[,optional_lookback:=as.numeric(optional_lookback)]
#source(paste0(pre_dir,"parameters/template_error_check.R"))
#Split the information into medicines or diagnoses codesheet(where the codelists will be used) and not fixed
####Start dates end End dates for all projects####
####GDM & PE####
#start study date
gdm_pe_start_study_date<-as.IDate(study_dates[Study=="GDM_and_PE",start_coverage],"%Y%m%d")
#Will be used in observation periods
#end study date: the min date between date creation and recommended end date or end study date
gdm_pe_end_study_date<-min(as.IDate(as.character(CDM_SOURCE[,date_creation]),"%Y%m%d"),
as.IDate(as.character(CDM_SOURCE[,recommended_end_date]),"%Y%m%d"),
as.IDate(study_dates[Study=="GDM_and_PE",end_coverage],"%Y%m%d"), na.rm = T)
#optional_lookback: will be used for diagnoses, medication and other data related to the event
opt_lookback<-study_dates[Study=="GDM_and_PE",optional_lookback]
if(opt_lookback==0){
gmd_pe_start_coverage_lookback<-NULL
}else{
gdm_pe_start_coverage_lookback<- gdm_pe_start_study_date - as.numeric(opt_lookback)
}
#min_preg_date_gdm_pe
min_preg_date_gdm_pe<-as.IDate(as.character(study_dates[Study=="GDM_and_PE",min_preg_date]),"%Y%m%d")
#max_preg_date_gdm_pe
max_preg_date_gdm_pe<-as.IDate(as.character(study_dates[Study=="GDM_and_PE",max_preg_date]),"%Y%m%d")
####Migraine####
#start study date
mig_start_study_date<-unique(as.IDate(study_dates[Study=="Migraine",start_coverage],"%Y%m%d"))
#end study date: the min date between date creation and recommended end date or end study date
mig_end_study_date<-min(as.IDate(as.character(CDM_SOURCE[,date_creation]),"%Y%m%d"),
as.IDate(as.character(CDM_SOURCE[,recommended_end_date]),"%Y%m%d"),
as.IDate(study_dates[Study=="Migraine",end_coverage],"%Y%m%d"), na.rm = T)
#min_preg_date_mig
min_preg_date_mig<-unique(as.IDate(study_dates[Study=="Migraine",min_preg_date],"%Y%m%d"))
#max_preg_date_gdm_pe
max_preg_date_mig<-as.IDate(as.character(study_dates[Study=="Migraine",max_preg_date]),"%Y%m%d")
#optional_lookback: will be used for pregnancy start date
opt_lookback<-unique(study_dates[Study=="Migraine",optional_lookback])
if(opt_lookback==0){
mig_start_preg_lookback<-NULL
}else{
mig_start_preg_lookback<- min_preg_date_mig + as.numeric(opt_lookback)
}
#optional_lookback: will be used for diagnoses, medication and other data related to the event
opt_lookback<-study_dates[Study=="GDM_and_PE",optional_lookback]
opt_lookback
#study parameters
####Load CDM Source table####
if(length(list.files(path_dir,"^CDM_SOURCE"))>1){
stop("More than one CDM SOURCE table is present in the working directory. Fix error and run the script again.")
}
CDM_SOURCE<-fread(paste0(path_dir, list.files(path_dir,"^CDM_SOURCE")))
#####Load study dates template####
study_dates_file<-list.files(paste0(projectFolder,"/p_steps/parameters/"), "study_dates")
study_dates<-read_excel(paste0(projectFolder,"/p_steps/parameters/",study_dates_file),col_types = "text")
study_dates<-as.data.table(study_dates)
#Keep only needed information based on the DAP
study_dates<-study_dates[DAP==data_access_provider_name]
if(study_dates[,.N]==0){
stop("This is not a script issue. There is no data for your data source in study_dates. Fix the issue and then rerun the script.")
}
study_dates[,optional_lookback:=as.numeric(optional_lookback)]
#source(paste0(pre_dir,"parameters/template_error_check.R"))
#Split the information into medicines or diagnoses codesheet(where the codelists will be used) and not fixed
####Start dates end End dates for all projects####
####GDM & PE####
#start study date
gdm_pe_start_study_date<-as.IDate(study_dates[Study=="GDM_and_PE",start_coverage],"%Y%m%d")
#Will be used in observation periods
#end study date: the min date between date creation and recommended end date or end study date
gdm_pe_end_study_date<-min(as.IDate(as.character(CDM_SOURCE[,date_creation]),"%Y%m%d"),
as.IDate(as.character(CDM_SOURCE[,recommended_end_date]),"%Y%m%d"),
as.IDate(study_dates[Study=="GDM_and_PE",end_coverage],"%Y%m%d"), na.rm = T)
#optional_lookback: will be used for diagnoses, medication and other data related to the event
opt_lookback<-study_dates[Study=="GDM_and_PE",optional_lookback]
if(opt_lookback==0){
gmd_pe_start_coverage_lookback<-NULL
}else{
gdm_pe_start_coverage_lookback<- gdm_pe_start_study_date - as.numeric(opt_lookback)
}
#min_preg_date_gdm_pe
min_preg_date_gdm_pe<-as.IDate(as.character(study_dates[Study=="GDM_and_PE",min_preg_date]),"%Y%m%d")
#max_preg_date_gdm_pe
max_preg_date_gdm_pe<-as.IDate(as.character(study_dates[Study=="GDM_and_PE",max_preg_date]),"%Y%m%d")
rm(opt_lookback)
####Migraine####
#start study date
mig_start_study_date<-unique(as.IDate(study_dates[Study=="Migraine",start_coverage],"%Y%m%d"))
#end study date: the min date between date creation and recommended end date or end study date
mig_end_study_date<-min(as.IDate(as.character(CDM_SOURCE[,date_creation]),"%Y%m%d"),
as.IDate(as.character(CDM_SOURCE[,recommended_end_date]),"%Y%m%d"),
as.IDate(study_dates[Study=="Migraine",end_coverage],"%Y%m%d"), na.rm = T)
#min_preg_date_mig
min_preg_date_mig<-unique(as.IDate(study_dates[Study=="Migraine",min_preg_date],"%Y%m%d"))
#max_preg_date_gdm_pe
max_preg_date_mig<-as.IDate(as.character(study_dates[Study=="Migraine",max_preg_date]),"%Y%m%d")
#optional_lookback: will be used for pregnancy start date
opt_lookback<-unique(study_dates[Study=="Migraine",optional_lookback])
if(opt_lookback==0){
mig_start_preg_lookback<-NULL
}else{
mig_start_preg_lookback<- min_preg_date_mig + as.numeric(opt_lookback)
}
opt_lookback<-study_dates[Study=="GDM_and_PE",optional_lookback]
opt_lookback
if(opt_lookback==0){
gmd_pe_start_coverage_lookback<-NULL
}else{
gdm_pe_start_coverage_lookback<- gdm_pe_start_study_date - as.numeric(opt_lookback)
}
rm(opt_lookback)
mig_start_study_date<-unique(as.IDate(study_dates[Study=="Migraine",start_coverage],"%Y%m%d"))
#end study date: the min date between date creation and recommended end date or end study date
mig_end_study_date<-min(as.IDate(as.character(CDM_SOURCE[,date_creation]),"%Y%m%d"),
as.IDate(as.character(CDM_SOURCE[,recommended_end_date]),"%Y%m%d"),
as.IDate(study_dates[Study=="Migraine",end_coverage],"%Y%m%d"), na.rm = T)
#min_preg_date_mig
min_preg_date_mig<-unique(as.IDate(study_dates[Study=="Migraine",min_preg_date],"%Y%m%d"))
#max_preg_date_gdm_pe
max_preg_date_mig<-as.IDate(as.character(study_dates[Study=="Migraine",max_preg_date]),"%Y%m%d")
#optional_lookback: will be used for pregnancy start date
opt_lookback<-unique(study_dates[Study=="Migraine",optional_lookback])
opt_lookback
if(opt_lookback==0){
mig_start_preg_lookback<-NULL
}else{
mig_start_preg_lookback<- min_preg_date_mig + as.numeric(opt_lookback)
}
opt_lookback
pt_lookback==0
opt_lookback==0
View(study_dates)
#study parameters
####Load CDM Source table####
if(length(list.files(path_dir,"^CDM_SOURCE"))>1){
stop("More than one CDM SOURCE table is present in the working directory. Fix error and run the script again.")
}
CDM_SOURCE<-fread(paste0(path_dir, list.files(path_dir,"^CDM_SOURCE")))
#####Load study dates template####
study_dates_file<-list.files(paste0(projectFolder,"/p_steps/parameters/"), "study_dates")
study_dates<-read_excel(paste0(projectFolder,"/p_steps/parameters/",study_dates_file),col_types = "text")
study_dates<-as.data.table(study_dates)
#Keep only needed information based on the DAP
study_dates<-study_dates[DAP==data_access_provider_name]
if(study_dates[,.N]==0){
stop("This is not a script issue. There is no data for your data source in study_dates. Fix the issue and then rerun the script.")
}
#study parameters
####Load CDM Source table####
if(length(list.files(path_dir,"^CDM_SOURCE"))>1){
stop("More than one CDM SOURCE table is present in the working directory. Fix error and run the script again.")
}
CDM_SOURCE<-fread(paste0(path_dir, list.files(path_dir,"^CDM_SOURCE")))
#####Load study dates template####
study_dates_file<-list.files(paste0(projectFolder,"/p_steps/parameters/"), "study_dates")
study_dates<-read_excel(paste0(projectFolder,"/p_steps/parameters/",study_dates_file),col_types = "text")
study_dates<-as.data.table(study_dates)
#Keep only needed information based on the DAP
study_dates<-study_dates[DAP==data_access_provider_name]
if(study_dates[,.N]==0){
stop("This is not a script issue. There is no data for your data source in study_dates. Fix the issue and then rerun the script.")
}
study_dates[,optional_lookback:=as.numeric(optional_lookback)]
#source(paste0(pre_dir,"parameters/template_error_check.R"))
#Split the information into medicines or diagnoses codesheet(where the codelists will be used) and not fixed
####Start dates end End dates for all projects####
####GDM & PE####
if(study_dates[Study=="GDM_and_PE" & DAP==data_access_provider_name,.N]>0){
#start study date
gdm_pe_start_study_date<-as.IDate(study_dates[Study=="GDM_and_PE",start_coverage],"%Y%m%d")
#Will be used in observation periods
#end study date: the min date between date creation and recommended end date or end study date
gdm_pe_end_study_date<-min(as.IDate(as.character(CDM_SOURCE[,date_creation]),"%Y%m%d"),
as.IDate(as.character(CDM_SOURCE[,recommended_end_date]),"%Y%m%d"),
as.IDate(study_dates[Study=="GDM_and_PE",end_coverage],"%Y%m%d"), na.rm = T)
#optional_lookback: will be used for diagnoses, medication and other data related to the event
opt_lookback<-study_dates[Study=="GDM_and_PE",optional_lookback]
if(opt_lookback==0){
gmd_pe_start_coverage_lookback<-NULL
}else{
gdm_pe_start_coverage_lookback<- gdm_pe_start_study_date - as.numeric(opt_lookback)
}
#min_preg_date_gdm_pe
min_preg_date_gdm_pe<-as.IDate(as.character(study_dates[Study=="GDM_and_PE",min_preg_date]),"%Y%m%d")
#max_preg_date_gdm_pe
max_preg_date_gdm_pe<-as.IDate(as.character(study_dates[Study=="GDM_and_PE",max_preg_date]),"%Y%m%d")
rm(opt_lookback)
}
####Migraine####
if(study_dates[Study=="Migraine" & DAP==data_access_provider_name,.N]>0){
#start study date
mig_start_study_date<-unique(as.IDate(study_dates[Study=="Migraine",start_coverage],"%Y%m%d"))
#end study date: the min date between date creation and recommended end date or end study date
mig_end_study_date<-min(as.IDate(as.character(CDM_SOURCE[,date_creation]),"%Y%m%d"),
as.IDate(as.character(CDM_SOURCE[,recommended_end_date]),"%Y%m%d"),
as.IDate(study_dates[Study=="Migraine",end_coverage],"%Y%m%d"), na.rm = T)
#min_preg_date_mig
min_preg_date_mig<-unique(as.IDate(study_dates[Study=="Migraine",min_preg_date],"%Y%m%d"))
#max_preg_date_gdm_pe
max_preg_date_mig<-as.IDate(as.character(study_dates[Study=="Migraine",max_preg_date]),"%Y%m%d")
#optional_lookback: will be used for pregnancy start date
opt_lookback<-unique(study_dates[Study=="Migraine",optional_lookback])
if(opt_lookback==0){
mig_start_preg_lookback<-NULL
}else{
mig_start_preg_lookback<- min_preg_date_mig + as.numeric(opt_lookback)
}
rm(opt_lookback)
}
#min age pregnancy
min_age_preg<-15
max_age_preg<-55
####Drug utilisation####
if(study_dates[Study=="Drug_utilisation" & DAP==data_access_provider_name,.N]>0){
#start study date
du_start_study_date<-as.IDate(study_dates[Study=="Drug_utilisation",start_coverage],"%Y%m%d")
#Will be used in observation periods
#end study date: the min date between date creation and recommended end date or end study date
du_end_study_date<-min(as.IDate(as.character(CDM_SOURCE[,date_creation]),"%Y%m%d"),
as.IDate(as.character(CDM_SOURCE[,recommended_end_date]),"%Y%m%d"),
as.IDate(study_dates[Study=="Drug_utilisation",end_coverage],"%Y%m%d"), na.rm = T)
# #optional_lookback: will be used for diagnoses, medication and other data related to the event
# opt_lookback<-study_dates[Study=="GDM_and_PE",optional_lookback]
# if(opt_lookback==0){
#   gmd_pe_start_coverage_lookback<-NULL
# }else{
#   gdm_pe_start_coverage_lookback<- gdm_pe_start_study_date - as.numeric(opt_lookback)
# }
#min_preg_date_du
min_preg_date_du<-as.IDate(study_dates[Study=="Drug_utilisation",min_preg_date],"%Y%m%d")
#max_preg_date_du
max_preg_date_du<-as.IDate(study_dates[Study=="Drug_utilisation",max_preg_date],"%Y%m%d")
rm(opt_lookback)
}
####Safety####
if(study_dates[Study=="Safety" & DAP==data_access_provider_name,.N]>0){
#start study date
saf_start_study_date<-as.IDate(study_dates[Study=="Safety",start_coverage],"%Y%m%d")
#Will be used in observation periods
#end study date: the min date between date creation and recommended end date or end study date
saf_end_study_date<-min(as.IDate(as.character(CDM_SOURCE[,date_creation]),"%Y%m%d"),
as.IDate(as.character(CDM_SOURCE[,recommended_end_date]),"%Y%m%d"),
as.IDate(study_dates[Study=="Safety",end_coverage],"%Y%m%d"), na.rm = T)
#optional_lookback: will be used for diagnoses, medication and other data related to the event
opt_lookback<-study_dates[Study=="Safety",optional_lookback]
if(length(opt_lookback)>0){
if(opt_lookback==0){
saf_start_coverage_lookback<-NULL
}else{
saf_start_coverage_lookback<- saf_start_study_date - as.numeric(opt_lookback)
}
saf_start_coverage_lookback<-NULL
}
#min_preg_date_saf
min_preg_date_saf<-as.IDate(study_dates[Study=="Safety",min_preg_date],"%Y%m%d")
#max_preg_date_saf
max_preg_date_saf<-as.IDate(study_dates[Study=="Safety",max_preg_date],"%Y%m%d")
rm(opt_lookback)
}
#Load the final pregnancy D3
rm(list=setdiff(ls(), "projectFolder"))
setwd(projectFolder)
source("99_path.R")
setwd(projectFolder)
#Load study parameters
source(paste0(projectFolder,"/p_steps/info/DAP_info.R"))
source(paste0(projectFolder,"/p_steps/parameters/study_parameters.R"))
if(exists(opt_lookback))rm(opt_lookback)
if(exists(opt_lookback)){rm(opt_lookback)}
exists(opt_lookback)
if(exists("opt_lookback")){rm(opt_lookback)}
#Load the final pregnancy D3
rm(list=setdiff(ls(), "projectFolder"))
setwd(projectFolder)
source("99_path.R")
setwd(projectFolder)
#Load study parameters
source(paste0(projectFolder,"/p_steps/info/DAP_info.R"))
source(paste0(projectFolder,"/p_steps/parameters/study_parameters.R"))
####Load the final pregnancy D3####
preg_file<-list.files(paste0(thisdir,"/g_output/"), "pregnancy_final")
get(load(paste0(thisdir,"/g_output/", preg_file)))
pregnancy_D3<-D3_pregnancy_final
rm(D3_pregnancy_final)
pregnancy_D3[,pregnancy_start_date:=as.IDate(pregnancy_start_date)]
pregnancy_D3[,pregnancy_end_date:=as.IDate(pregnancy_end_date)]
original_rows<-pregnancy_D3[,.N]
yellow_rec<-pregnancy_D3[highest_quality=="2_yellow",.N]
blue_rec<-pregnancy_D3[highest_quality=="3_blue",.N]
red_rec<-pregnancy_D3[highest_quality=="4_red",.N]
not_green_rec<-pregnancy_D3[highest_quality!="1_green",.N]
removed_rec<-data.table(Indicator="Pregnancy records",
Quality=c("yellow","blue","red"),
removed_records=c(yellow_rec,blue_rec,red_rec),
percentage=c(round((yellow_rec/pregnancy_D3[,.N])*100,1),
round((blue_rec/pregnancy_D3[,.N])*100,1),
round((red_rec/pregnancy_D3[,.N])*100,1)))
rm(yellow_rec,blue_rec,red_rec)
fwrite(removed_rec,paste0(output_dir, "Pregnancy algorithm/other_quality_records_removed.csv"), row.names = F)
pregnancy_D3<-pregnancy_D3[highest_quality=="1_green"]
issues_preg_alg_sex<-pregnancy_D3[sex_at_instance_creation!="F",.N]
pregnancy_D3<-pregnancy_D3[sex_at_instance_creation=="F"]
issues_preg_alg_date<-pregnancy_D3[is.na(pregnancy_start_date)|is.na(pregnancy_end_date),.N]
pregnancy_D3<-pregnancy_D3[!is.na(pregnancy_start_date) & !is.na(pregnancy_end_date)]
issues_preg_alg_pid<-pregnancy_D3[is.na(person_id),.N]
pregnancy_D3<-pregnancy_D3[!is.na(person_id)]
issues_preg_alg_prid<-pregnancy_D3[is.na(pregnancy_id),.N]
pregnancy_D3<-pregnancy_D3[!is.na(pregnancy_id)]
#calculate gestational age and exclude all records with gestational age>43 weeks(301 days)
pregnancy_D3[,diff:=pregnancy_end_date- pregnancy_start_date]
issues_preg_alg_ga<-pregnancy_D3[diff>=301,.N]
pregnancy_D3<-pregnancy_D3[diff<301]
pregnancy_D3[,diff:=NULL]
Indicator<-c("Number of original records from the pregnancy algorithm",
"Number of records with quality other than green",
"Records with sex other than female",
"Records with missing start or end date of pregnancy or both",
"Records with missing person id",
"Records with missing pregnancy id",
"Records where gestational age is longer than 43 weeks(301 days)")
placeholder<-c(original_rows,not_green_rec,issues_preg_alg_sex,issues_preg_alg_date,issues_preg_alg_pid,issues_preg_alg_prid,issues_preg_alg_ga)
issues<-data.table(Indicator=Indicator, Count=placeholder)
rm(Indicator,placeholder)
rm(issues_preg_alg_sex,not_green_rec,issues_preg_alg_date,issues_preg_alg_pid,issues_preg_alg_prid,issues_preg_alg_ga)
fwrite(issues,paste0(output_dir, "Pregnancy algorithm/issues_flowchart_pregnancy_D3.csv"), row.names = F)
rm(issues)
####GDM and PE####
pregnancy_D3[,filter_1:=as.character(NA)]
pregnancy_D3[,min_preg_date:=min_preg_date_gdm_pe]
pregnancy_D3[,dif:=min_preg_date - pregnancy_start_date]
before_min_date_gdm_pe<-pregnancy_D3[dif>0,.N]
pregnancy_D3[dif<=0,filter_1:=1]
pregnancy_D3[,min_preg_date:=NULL][,dif:=NULL]
pregnancy_D3[,filter_2:=as.character(NA)]
pregnancy_D3[,max_preg_date:=max_preg_date_gdm_pe]
pregnancy_D3[,dif:=max_preg_date - pregnancy_start_date]
after_max_date_gdm_pe<-pregnancy_D3[dif<0,.N]
pregnancy_D3[dif>=0,filter_2:=1]
pregnancy_D3[,max_preg_date:=NULL][,dif:=NULL]
pregnancy_D3[filter_1==1 & filter_2==1,gdm_pe_filter:=1]
pregnancy_D3[,filter_1:=NULL][,filter_2:=NULL]
#pregnancies with ga>20 weeks(140 days) only
pregnancy_D3[,GA:=pregnancy_end_date - pregnancy_start_date]
pregnancy_D3[GA>140, include_ga:=1]
not_incl_ga<-pregnancy_D3[GA<=140,.N]
#update gdm_pe_filter
pregnancy_D3[GA<=140, gdm_pe_filter:=NA]
pregnancy_D3[,GA:=NULL]
included_gdm_pe<-pregnancy_D3[gdm_pe_filter==1,.N]
issues_gdm_pe<-data.table(Indicator=c(paste0("Records with start date before: ",min_preg_date_gdm_pe),
paste0("Records with end date after: ", max_preg_date_gdm_pe),
"Records with GA> 20 weeks(140 days)",
#                          "Records with pregnancy outcome other than LB/SB",
"Records left after removing all issues above"),
GDM_and_PE=c(before_min_date_gdm_pe,
after_max_date_gdm_pe,
not_incl_ga,
#                                       "N/A",
included_gdm_pe)
)
rm(before_min_date_gdm_pe,after_max_date_gdm_pe,not_incl_ga,included_gdm_pe)
fwrite(issues_gdm_pe,paste0(output_dir, "Pregnancy algorithm/issues_GDM_PE_flowchart_pregnancy_D3.csv"), row.names = F)
rm(issues_gdm_pe)
####Migraine####
pregnancy_D3[,filter_1:=as.character(NA)]
pregnancy_D3[,min_preg_date:=min_preg_date_mig]
pregnancy_D3[,dif:=min_preg_date - pregnancy_start_date]
before_min_date_mig<-pregnancy_D3[dif>0,.N]
pregnancy_D3[dif<=0,filter_1:=1]
pregnancy_D3[,min_preg_date:=NULL][,dif:=NULL]
pregnancy_D3[,filter_2:=as.character(NA)]
pregnancy_D3[,max_preg_date:=max_preg_date_mig]
pregnancy_D3[,dif:=max_preg_date - pregnancy_start_date]
after_max_date_mig<-pregnancy_D3[dif<0,.N]
pregnancy_D3[dif>=0,filter_2:=1]
pregnancy_D3[,max_preg_date:=NULL][,dif:=NULL]
pregnancy_D3[filter_1==1 & filter_2==1,mig_filter:=1]
pregnancy_D3[,filter_1:=NULL][,filter_2:=NULL]
#Calculate number of pregnancy records with outcome LB/SB
pregnancy_D3[type_of_pregnancy_end=="LB" | type_of_pregnancy_end=="SB", keep_outcome:=1]
other_outcome_mig<-pregnancy_D3[is.na(keep_outcome),.N]
#Update filter_mig based on the type of outcome
pregnancy_D3[is.na(keep_outcome), mig_filter:=NA]
pregnancy_D3[,keep_outcome:=NULL]
included_mig<-pregnancy_D3[mig_filter==1,.N]
issues_mig<-data.table(Indicator=c(paste0("Records with start date before: ", min_preg_date_mig),
paste0("Records with end date after: ", max_preg_date_mig),
#                                   "Records with GA> 20 weeks(140 days)",
"Records with pregnancy outcome other than LB/SB",
"Records left after removing all issues above"),
Migraine=c(before_min_date_mig,
after_max_date_mig,
#                                     "N/A",
other_outcome_mig,
included_mig)
)
rm(before_min_date_mig,after_max_date_mig,other_outcome_mig,included_mig)
fwrite(issues_mig,paste0(output_dir, "Pregnancy algorithm/issues_Migraine_flowchart_pregnancy_D3.csv"), row.names = F)
rm(issues_mig)
####Drug utilisation####
pregnancy_D3[,filter_1:=as.character(NA)]
pregnancy_D3[,min_preg_date:=min_preg_date_du]
pregnancy_D3[,dif:=min_preg_date - pregnancy_start_date]
before_min_date_du<-pregnancy_D3[dif>0,.N]
pregnancy_D3[dif<=0,filter_1:=1]
pregnancy_D3[,min_preg_date:=NULL][,dif:=NULL]
pregnancy_D3[,filter_2:=as.character(NA)]
pregnancy_D3[,max_preg_date:=max_preg_date_du]
pregnancy_D3[,dif:=max_preg_date - pregnancy_start_date]
after_max_date_du<-pregnancy_D3[dif<0,.N]
pregnancy_D3[dif>=0,filter_2:=1]
pregnancy_D3[,max_preg_date:=NULL][,dif:=NULL]
pregnancy_D3[filter_1==1 & filter_2==1,du_filter:=1]
pregnancy_D3[,filter_1:=NULL][,filter_2:=NULL]
#Calculate number of pregnancy records with outcome LB/SB
pregnancy_D3[type_of_pregnancy_end=="LB" | type_of_pregnancy_end=="SB", keep_outcome:=1]
other_outcome_du<-pregnancy_D3[is.na(keep_outcome),.N]
#Update filter_mig based on the type of outcome
pregnancy_D3[is.na(keep_outcome), du_filter:=NA]
pregnancy_D3[,keep_outcome:=NULL]
included_du<-pregnancy_D3[du_filter==1,.N]
issues_du<-data.table(Indicator=c(paste0("Records with start date before: ",min_preg_date_du),
paste0("Records with end date after:", max_preg_date_du),
#                                   "Records with GA> 20 weeks(140 days)",
"Records with pregnancy outcome other than LB/SB",
"Records left after removing all issues above"),
Drug_utilisation=c(before_min_date_du,
after_max_date_du,
#                                  "N/A",
other_outcome_du,
included_du)
)
rm(before_min_date_du,after_max_date_du,other_outcome_du,included_du)
fwrite(issues_du,paste0(output_dir, "Pregnancy algorithm/issues_DU_flowchart_pregnancy_D3.csv"), row.names = F)
rm(issues_du)
####Safety####
pregnancy_D3[,filter_1:=as.character(NA)]
pregnancy_D3[,min_preg_date:=min_preg_date_saf]
pregnancy_D3[,dif:=min_preg_date - pregnancy_start_date]
before_min_date_saf<-pregnancy_D3[dif>0,.N]
pregnancy_D3[dif<=0,filter_1:=1]
pregnancy_D3[,min_preg_date:=NULL][,dif:=NULL]
pregnancy_D3[,filter_2:=as.character(NA)]
pregnancy_D3[,max_preg_date:=max_preg_date_saf]
pregnancy_D3[,dif:=max_preg_date - pregnancy_start_date]
after_max_date_saf<-pregnancy_D3[dif<0,.N]
pregnancy_D3[dif>=0,filter_2:=1]
pregnancy_D3[,max_preg_date:=NULL][,dif:=NULL]
pregnancy_D3[filter_1==1 & filter_2==1,saf_filter:=1]
pregnancy_D3[,filter_1:=NULL][,filter_2:=NULL]
#Calculate number of pregnancy records with outcome LB/SB
pregnancy_D3[type_of_pregnancy_end=="LB" | type_of_pregnancy_end=="SB", keep_outcome:=1]
other_outcome_saf<-pregnancy_D3[is.na(keep_outcome),.N]
#Update filter_mig based on the type of outcome
pregnancy_D3[is.na(keep_outcome), saf_filter:=NA]
pregnancy_D3[,keep_outcome:=NULL]
included_saf<-pregnancy_D3[saf_filter==1,.N]
issues_saf<-data.table(Indicator=c(paste0("Records with start date before: ",min_preg_date_saf),
paste0("Records with end date after: ", max_preg_date_saf),
#                                  "Records with GA> 20 weeks(140 days)",
"Records with pregnancy outcome other than LB/SB",
"Records left after removing all issues above"),
Safety=c(before_min_date_saf,
after_max_date_saf,
#                                 "N/A",
other_outcome_saf,
included_saf)
)
rm(before_min_date_saf,after_max_date_saf,other_outcome_saf,included_saf)
fwrite(issues_saf,paste0(output_dir, "Pregnancy algorithm/issues_Safety_flowchart_pregnancy_D3.csv"), row.names = F)
rm(issues_saf)
pregnancy_D3<-pregnancy_D3[,c("person_id","pregnancy_id","pregnancy_start_date","pregnancy_end_date","gdm_pe_filter","mig_filter","du_filter","saf_filter")]
####Create summary of included records by year of start pregnancy
pregnancy_D3[,year:=year(pregnancy_start_date)]
summary_gdm<-as.data.table(pregnancy_D3[gdm_pe_filter==1,.N,by="year"])
setnames(summary_gdm,"N","GDM_and_PE")
summary_mig<-as.data.table(pregnancy_D3[mig_filter==1,.N,by="year"])
setnames(summary_mig,"N","Migraine")
summary_du<-as.data.table(pregnancy_D3[du_filter==1,.N,by="year"])
setnames(summary_du,"N","Drug_utilization")
summary_saf<-as.data.table(pregnancy_D3[saf_filter==1,.N,by="year"])
setnames(summary_saf,"N","Safety")
summary<-merge.data.table(summary_gdm,summary_mig,by="year",all=T)
rm(summary_gdm,summary_mig)
summary<-merge.data.table(summary,summary_du,by="year",all=T)
rm(summary_du)
summary<-merge.data.table(summary,summary_saf,by="year",all=T)
rm(summary_saf)
summary[is.na(GDM_and_PE),GDM_and_PE:=0]
summary[is.na(Migraine),Migraine:=0]
summary[is.na(Drug_utilization),Drug_utilization:=0]
summary[is.na(Safety),Safety:=0]
fwrite(summary,paste0(output_dir, "Pregnancy algorithm/included_records_pregnancy_D3.csv"), row.names = F)
rm(summary)
#save pregnancy population to g_intermediate
saveRDS(pregnancy_D3,paste0(g_intermediate,"pregnancy_algorithm/pregnancy_D3.rds"))
rm(pregnancy_D3)
