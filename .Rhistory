after=c(7,7,7,7))
#pe files
pe_files<-list.files(paste0(projectFolder,"/g_intermediate/pe_algorithm/"))
names_events<-list()
for(i in 1:length(pe_files)){
names_events[[i]]<-unlist(str_split(pe_files[i],"[.]"))[1]
}
names_events<-as.vector(do.call(rbind,names_events))
original<-list()
before<-list()
after<-list()
sum<-list()
dir.create(paste0(projectFolder,"/g_intermediate/pe_algorithm/final_d3"))
w<-1
for(pe_fl in 1:length(pe_files)){
pe_dt<-readRDS(paste0(projectFolder,"/g_intermediate/pe_algorithm/", pe_files[pe_fl]))
#merge with the pregnancy d3
pe_dt<-merge.data.table(pregnancy_d3_gdm_pe, pe_dt, by="person_id", all.x=T, allow.cartesian = T)
pe_dt<-pe_dt[!is.na(event_date)]
if(pe_dt[,.N]>0){
original[[w]]<-data.table(StudyVar=names_events[pe_fl], event_records=pe_dt[,.N])
pe_dt[,event_date:=as.IDate(event_date)]
if(obs_period[StudyVar==names_events[pe_fl],lookback]>0){
pe_dt[,lookback:=obs_period[StudyVar==names_events[pe_fl],lookback]]
pe_dt[,start_preg:=as.IDate(pregnancy_start_date-lookback)]
#exclude all pregnancies that are outside observation period of interest
pe_dt[,diff:=event_date-start_preg]
#remove all records with date before start date pregnancy+lookback
before[[w]]<-data.table(StudyVar=names_events[pe_fl], before_start=pe_dt[diff<0,.N])
pe_dt<-pe_dt[diff>=0]
pe_dt[,diff:=NULL][,lookback:=NULL][,start_preg:=NULL]
}else{
#remove all records before start obs
pe_dt[,start:=obs_period[StudyVar==names_events[pe_fl],start_date]]
pe_dt[,start_preg:=as.IDate(pregnancy_start_date+start)]
pe_dt[,diff:=event_date-start_preg]
before[[w]]<-data.table(StudyVar=names_events[pe_fl], before_start=pe_dt[diff<0,.N])
pe_dt<-pe_dt[diff>=0]
pe_dt[,diff:=NULL][,start:=NULL][,start_preg:=NULL]
}
if(pe_dt[,.N]>0){
if(obs_period[StudyVar==names_events[pe_fl],after]>0){
pe_dt[,after:=obs_period[StudyVar==names_events[pe_fl],after]]
pe_dt[,end_preg:=as.IDate(pregnancy_end_date+after)]
pe_dt[,diff:=event_date-end_preg]
after[[w]]<-data.table(StudyVar=names_events[pe_fl], after_end=pe_dt[diff>0,.N])
pe_dt<-pe_dt[diff<=0]
pe_dt[,diff:=NULL][,after:=NULL][,end_preg:=NULL]
}else{
pe_dt[,end:=obs_period[StudyVar==names_events[pe_fl],end_date]]
pe_dt[,end_preg:=as.IDate(pregnancy_start_date+end)]
pe_dt[,diff:=event_date-end_preg]
after[[w]]<-data.table(StudyVar=names_events[pe_fl], after_end=pe_dt[diff>0,.N])
pe_dt<-pe_dt[diff<=0]
pe_dt[,diff:=NULL][,end:=NULL][,end_preg:=NULL]
}
}else{
after[[w]]<-data.table(StudyVar=names_events[pe_fl], after_end=0)
}
if(pe_dt[,.N]>0){
#create a summary of included records
sum[[w]]<-data.table(StudyVar=names_events[pe_fl], no_records=pe_dt[!is.na(event_date),.N], no_pregnancies=pe_dt[!duplicated(pregnancy_id),.N])
saveRDS(pe_dt, paste0(projectFolder,"/g_intermediate/pe_algorithm/final_d3/", names_events[pe_fl],"_pregnancy_D3.rds"))
cols<-c("person_id","pregnancy_id","pregnancy_start_date","pregnancy_end_date","maternal_age")
pe_dt<-pe_dt[,cols,with=F]
pe_dt[,names_events[pe_fl]:=1]
pe_dt<-pe_dt[,lapply(.SD,sum),.SDcols = names_events[pe_fl], by=c("person_id","pregnancy_id","pregnancy_start_date","pregnancy_end_date","maternal_age")]
pregnancy_d3_gdm_pe<-merge.data.table(pregnancy_d3_gdm_pe,pe_dt,all.x=T, by=cols)
pregnancy_d3_gdm_pe[is.na(get(names_events[pe_fl])),names_events[pe_fl]:=0]
}else{
pregnancy_d3_gdm_pe[,names_events[pe_fl]:=0]
}
}else{
pregnancy_d3_gdm_pe[,names_events[pe_fl]:=0]
}
rm(pe_dt)
w<-w+1
}
original<-as.data.table(do.call(rbind,original))
before<-as.data.table(do.call(rbind,before))
after<-as.data.table(do.call(rbind,after))
removed_rec<-merge.data.table(original,before,by="StudyVar",all=T)
removed_rec<-merge.data.table(removed_rec,after,by="StudyVar",all=T)
removed_rec[is.na(before_start),before_start:="N/A"]
removed_rec[is.na(after_end),after_end:="N/A"]
sum_pe<-as.data.table(do.call(rbind,sum))
rm(original,before,after,sum)
rm(obs_period,pe_files)
sum_pe
not_present<-setdiff(names(conditions_pe), names_events)
pregnancy_d3_gdm_pe[,eval(not_present):=list(0,0)]
PE_1<-algorithm_template[NEW_STUDY_VARIABLES=="PE_1"]
#excl_col<-PE_1[TYPE=="AND_NOT",STUDY_VARIABLES]
inc_col<-PE_1[TYPE=="AND",STUDY_VARIABLES]
#alt_col<-PE_1[TYPE=="OR",STUDY_VARIABLES]
#if(length(excl_col)>0){pregnancy_d3_gdm_pe[pregnancy_d3_gdm_pe[,Reduce("|" , lapply(.SD,`>=`, 1)),.SDcols=excl_col],exclude:=1]}else{pregnancy_d3_gdm_pe[,exclude:=NA]}
if(length(inc_col)>0){pregnancy_d3_gdm_pe[pregnancy_d3_gdm_pe[,Reduce("|" , lapply(.SD,`>=`, 1)),.SDcols=inc_col],include:=1]}else{pregnancy_d3_gdm_pe[,include:=NA]}
#if(length(alt_col)>0){pregnancy_d3_gdm_pe[pregnancy_d3_gdm_pe[,Reduce("|" , lapply(.SD,`>=`, 1)),.SDcols=alt_col],alternative:=1]}else{pregnancy_d3_gdm_pe[,alternative:=1]}
PE_1_a<-data.table(algorithm="PE_1", no_diagnosed_pregnancies=pregnancy_d3_gdm_pe[include>=1 & !duplicated(pregnancy_id),.N], no_pregnancies=pregnancy_d3_gdm_pe[!duplicated(pregnancy_id),.N])
PE_1_a
pregnancy_d3_gdm_pe[include>=1 & !duplicated(pregnancy_id),by="maternal_age", .N]
records<-pregnancy_d3_gdm_pe[include>=1 & !duplicated(pregnancy_id),by="maternal_age", .N]
total<-pregnancy_d3_gdm_pe[!duplicated(pregnancy_id),.N]
records
total
names(records)<-c("maternal_age","no_diagnosed_pregnancies")
names(total)<-c("maternal_age","no_pregnancies")
records<-pregnancy_d3_gdm_pe[include>=1 & !duplicated(pregnancy_id),by="maternal_age", .N]
names(records)<-c("maternal_age","no_diagnosed_pregnancies")
total<-pregnancy_d3_gdm_pe[!duplicated(pregnancy_id),by="maternal_age",.N]
names(total)<-c("maternal_age","no_pregnancies")
records<-merge.data.table(records,total)
records
View(pregnancy_d3_gdm_pe)
PE_1_b<-data.table(algorithm="PE_1", records)
PE_1_b
records<-pregnancy_d3_gdm_pe[include>=1 & !duplicated(pregnancy_id),by="year", .N]
records
names(records)<-c("maternal_age","no_diagnosed_pregnancies")
records<-pregnancy_d3_gdm_pe[include>=1 & !duplicated(pregnancy_id),by="year", .N]
names(records)<-c("maternal_age","no_diagnosed_pregnancies")
total<-pregnancy_d3_gdm_pe[!duplicated(pregnancy_id),by="year",.N]
names(total)<-c("maternal_age","no_pregnancies")
records<-merge.data.table(records,total)
PE_1_c<-data.table(algorithm="PE_1", records)
rm(records,total)
PE_1_c
records<-pregnancy_d3_gdm_pe[include>=1 & !duplicated(pregnancy_id),by="year", .N]
names(records)<-c("year","no_diagnosed_pregnancies")
total<-pregnancy_d3_gdm_pe[!duplicated(pregnancy_id),by="year",.N]
names(total)<-c("year","no_pregnancies")
records<-merge.data.table(records,total)
PE_1_c<-data.table(algorithm="PE_1", records)
rm(records,total)
PE_1_c
function(x){
if(x>=15 & x<=24){y<-"15-24"}
if(x>=25 & x<=29){y<-"25-29"}
if(x>=30 & x<=34){y<-"30-34"}
if(x>=35 & x<=39){y<-"35-39"}
if(x>=40){y<-"40+"}
}
age_band_creation<-function(x){
if(x>=15 & x<=24){y<-"15-24"}
if(x>=25 & x<=29){y<-"25-29"}
if(x>=30 & x<=34){y<-"30-34"}
if(x>=35 & x<=39){y<-"35-39"}
if(x>=40){y<-"40+"}
}
pregnancy_d3_gdm_pe<-readRDS(paste0(projectFolder,"/g_intermediate/pregnancy_d3/GDM_PE_Pregnancy_D3.rds"))
pregnancy_d3_gdm_pe[,pregnancy_start_date:=as.IDate(pregnancy_start_date)][,pregnancy_end_date:=as.IDate(pregnancy_end_date)][,birth_date:=as.IDate(birth_date)][,death_date:=as.IDate(death_date)][,op_start_date_gdm_pe:=as.IDate(op_start_date_gdm_pe)][,op_end_date_gdm_pe:=as.IDate(op_end_date_gdm_pe)]
pregnancy_d3_gdm_pe[,maternal_age:=floor((pregnancy_start_date-birth_date)/365.25)]
pregnancy_d3_gdm_pe[,year:=year(pregnancy_start_date)]
pregnancy_d3_gdm_pe<-readRDS(paste0(projectFolder,"/g_intermediate/pregnancy_d3/GDM_PE_Pregnancy_D3.rds"))
pregnancy_d3_gdm_pe[,pregnancy_start_date:=as.IDate(pregnancy_start_date)][,pregnancy_end_date:=as.IDate(pregnancy_end_date)][,birth_date:=as.IDate(birth_date)][,death_date:=as.IDate(death_date)][,op_start_date_gdm_pe:=as.IDate(op_start_date_gdm_pe)][,op_end_date_gdm_pe:=as.IDate(op_end_date_gdm_pe)]
pregnancy_d3_gdm_pe[,age:=floor((pregnancy_start_date-birth_date)/365.25)]
pregnancy_d3_gdm_pe[,maternal_age:=age_band_creation(age)]
age_band_creation<-function(x){
if(x>=15 & x<=24){y<-"15-24"}
if(x>=25 & x<=29){y<-"25-29"}
if(x>=30 & x<=34){y<-"30-34"}
if(x>=35 & x<=39){y<-"35-39"}
if(x>=40){y<-"40+"}
return(y)
}
age_band_creation<-function(x){
if(x>=15 & x<=24){y<-"15-24"}
if(x>=25 & x<=29){y<-"25-29"}
if(x>=30 & x<=34){y<-"30-34"}
if(x>=35 & x<=39){y<-"35-39"}
if(x>=40){y<-"40+"}
return(y)
}
pregnancy_d3_gdm_pe[,maternal_age:=age_band_creation(age)]
pregnancy_d3_gdm_pe[,maternal_age:=lapply(age, age_band_creation)]
View(pregnancy_d3_gdm_pe)
year_group_creation<-function(x){
if(x>=2005 & x<=2009){y<-"2005-2009"}
if(x>=2010 & x<=2014){y<-"2010-2014"}
if(x>=2015 & x<=2019){y<-"2015-2019"}
return(y)
}
age_band_creation<-function(x){
if(x>=15 & x<=24){y<-"15-24"}
if(x>=25 & x<=29){y<-"25-29"}
if(x>=30 & x<=34){y<-"30-34"}
if(x>=35 & x<=39){y<-"35-39"}
if(x>=40){y<-"40+"}
return(y)
}
year_group_creation<-function(x){
if(x>=2005 & x<=2009){y<-"2005-2009"}
if(x>=2010 & x<=2014){y<-"2010-2014"}
if(x>=2015 & x<=2019){y<-"2015-2019"}
return(y)
}
#Load all gdm_algorithm file and combine with the pregnancy D3
pregnancy_d3_gdm_pe<-readRDS(paste0(projectFolder,"/g_intermediate/pregnancy_d3/GDM_PE_Pregnancy_D3.rds"))
pregnancy_d3_gdm_pe[,pregnancy_start_date:=as.IDate(pregnancy_start_date)][,pregnancy_end_date:=as.IDate(pregnancy_end_date)][,birth_date:=as.IDate(birth_date)][,death_date:=as.IDate(death_date)][,op_start_date_gdm_pe:=as.IDate(op_start_date_gdm_pe)][,op_end_date_gdm_pe:=as.IDate(op_end_date_gdm_pe)]
pregnancy_d3_gdm_pe[,age:=floor((pregnancy_start_date-birth_date)/365.25)]
pregnancy_d3_gdm_pe[,maternal_age:=lapply(age, age_band_creation)]
pregnancy_d3_gdm_pe[,year:=year(pregnancy_start_date)]
pregnancy_d3_gdm_pe[,year_group:=lapply(year, year_group_creation)]
obs_period<-data.table(StudyVar=c("PE","ECL","HELLP","PE_checkbox"),
lookback=c(0,0,0,0),
start_date=c(20*7,20*7,20*7,20*7),
end_date=c(7*40,7*40,7*40,7*40),
after=c(7,7,7,7))
#pe files
pe_files<-list.files(paste0(projectFolder,"/g_intermediate/pe_algorithm/"))
names_events<-list()
for(i in 1:length(pe_files)){
names_events[[i]]<-unlist(str_split(pe_files[i],"[.]"))[1]
}
names_events<-as.vector(do.call(rbind,names_events))
original<-list()
before<-list()
after<-list()
sum<-list()
dir.create(paste0(projectFolder,"/g_intermediate/pe_algorithm/final_d3"))
w<-1
sum[[w]]<-data.table(StudyVar=names_events[pe_fl], no_records=pe_dt[!is.na(event_date),.N], no_pregnancies=pe_dt[!duplicated(pregnancy_id),.N])
pe_dt<-readRDS(paste0(projectFolder,"/g_intermediate/pe_algorithm/", pe_files[pe_fl]))
#merge with the pregnancy d3
pe_dt<-merge.data.table(pregnancy_d3_gdm_pe, pe_dt, by="person_id", all.x=T, allow.cartesian = T)
pe_dt<-pe_dt[!is.na(event_date)]
original[[w]]<-data.table(StudyVar=names_events[pe_fl], event_records=pe_dt[,.N])
pe_dt[,event_date:=as.IDate(event_date)]
if(obs_period[StudyVar==names_events[pe_fl],lookback]>0){
pe_dt[,lookback:=obs_period[StudyVar==names_events[pe_fl],lookback]]
pe_dt[,start_preg:=as.IDate(pregnancy_start_date-lookback)]
#exclude all pregnancies that are outside observation period of interest
pe_dt[,diff:=event_date-start_preg]
#remove all records with date before start date pregnancy+lookback
before[[w]]<-data.table(StudyVar=names_events[pe_fl], before_start=pe_dt[diff<0,.N])
pe_dt<-pe_dt[diff>=0]
pe_dt[,diff:=NULL][,lookback:=NULL][,start_preg:=NULL]
}else{
#remove all records before start obs
pe_dt[,start:=obs_period[StudyVar==names_events[pe_fl],start_date]]
pe_dt[,start_preg:=as.IDate(pregnancy_start_date+start)]
pe_dt[,diff:=event_date-start_preg]
before[[w]]<-data.table(StudyVar=names_events[pe_fl], before_start=pe_dt[diff<0,.N])
pe_dt<-pe_dt[diff>=0]
pe_dt[,diff:=NULL][,start:=NULL][,start_preg:=NULL]
}
if(pe_dt[,.N]>0){
if(obs_period[StudyVar==names_events[pe_fl],after]>0){
pe_dt[,after:=obs_period[StudyVar==names_events[pe_fl],after]]
pe_dt[,end_preg:=as.IDate(pregnancy_end_date+after)]
pe_dt[,diff:=event_date-end_preg]
after[[w]]<-data.table(StudyVar=names_events[pe_fl], after_end=pe_dt[diff>0,.N])
pe_dt<-pe_dt[diff<=0]
pe_dt[,diff:=NULL][,after:=NULL][,end_preg:=NULL]
}else{
pe_dt[,end:=obs_period[StudyVar==names_events[pe_fl],end_date]]
pe_dt[,end_preg:=as.IDate(pregnancy_start_date+end)]
pe_dt[,diff:=event_date-end_preg]
after[[w]]<-data.table(StudyVar=names_events[pe_fl], after_end=pe_dt[diff>0,.N])
pe_dt<-pe_dt[diff<=0]
pe_dt[,diff:=NULL][,end:=NULL][,end_preg:=NULL]
}
}else{
after[[w]]<-data.table(StudyVar=names_events[pe_fl], after_end=0)
}
#create a summary of included records
sum[[w]]<-data.table(StudyVar=names_events[pe_fl], no_records=pe_dt[!is.na(event_date),.N], no_pregnancies=pe_dt[!duplicated(pregnancy_id),.N])
saveRDS(pe_dt, paste0(projectFolder,"/g_intermediate/pe_algorithm/final_d3/", names_events[pe_fl],"_pregnancy_D3.rds"))
cols<-c("person_id","pregnancy_id","pregnancy_start_date","pregnancy_end_date", "maternal_age")
pe_dt<-pe_dt[,cols,with=F]
pe_dt[,names_events[pe_fl]:=1]
pe_dt<-pe_dt[,lapply(.SD,sum),.SDcols = names_events[pe_fl], by=c("person_id","pregnancy_id","pregnancy_start_date","pregnancy_end_date","maternal_age")]
age_band_creation<-function(x){
if(x>=15 & x<=24){y<-"15-24"}
if(x>=25 & x<=29){y<-"25-29"}
if(x>=30 & x<=34){y<-"30-34"}
if(x>=35 & x<=39){y<-"35-39"}
if(x>=40){y<-"40+"}
return(y)
}
year_group_creation<-function(x){
if(x>=2005 & x<=2009){y<-"2005-2009"}
if(x>=2010 & x<=2014){y<-"2010-2014"}
if(x>=2015 & x<=2019){y<-"2015-2019"}
return(y)
}
pregnancy_d3_gdm_pe<-readRDS(paste0(projectFolder,"/g_intermediate/pregnancy_d3/GDM_PE_Pregnancy_D3.rds"))
pregnancy_d3_gdm_pe[,pregnancy_start_date:=as.IDate(pregnancy_start_date)][,pregnancy_end_date:=as.IDate(pregnancy_end_date)][,birth_date:=as.IDate(birth_date)][,death_date:=as.IDate(death_date)][,op_start_date_gdm_pe:=as.IDate(op_start_date_gdm_pe)][,op_end_date_gdm_pe:=as.IDate(op_end_date_gdm_pe)]
pregnancy_d3_gdm_pe[,age:=floor((pregnancy_start_date-birth_date)/365.25)]
pregnancy_d3_gdm_pe[,maternal_age:=lapply(age, age_band_creation)]
pregnancy_d3_gdm_pe[,year:=year(pregnancy_start_date)]
pregnancy_d3_gdm_pe[,year_group:=lapply(year, year_group_creation)]
obs_period<-data.table(StudyVar=c("PE","ECL","HELLP","PE_checkbox"),
lookback=c(0,0,0,0),
start_date=c(20*7,20*7,20*7,20*7),
end_date=c(7*40,7*40,7*40,7*40),
after=c(7,7,7,7))
#pe files
pe_files<-list.files(paste0(projectFolder,"/g_intermediate/pe_algorithm/"))
names_events<-list()
for(i in 1:length(pe_files)){
names_events[[i]]<-unlist(str_split(pe_files[i],"[.]"))[1]
}
names_events<-as.vector(do.call(rbind,names_events))
original<-list()
before<-list()
after<-list()
sum<-list()
dir.create(paste0(projectFolder,"/g_intermediate/pe_algorithm/final_d3"))
w<-1
pe_dt<-readRDS(paste0(projectFolder,"/g_intermediate/pe_algorithm/", pe_files[pe_fl]))
#merge with the pregnancy d3
pe_dt<-merge.data.table(pregnancy_d3_gdm_pe, pe_dt, by="person_id", all.x=T, allow.cartesian = T)
pe_dt<-pe_dt[!is.na(event_date)]
original[[w]]<-data.table(StudyVar=names_events[pe_fl], event_records=pe_dt[,.N])
pe_dt[,event_date:=as.IDate(event_date)]
if(obs_period[StudyVar==names_events[pe_fl],lookback]>0){
pe_dt[,lookback:=obs_period[StudyVar==names_events[pe_fl],lookback]]
pe_dt[,start_preg:=as.IDate(pregnancy_start_date-lookback)]
#exclude all pregnancies that are outside observation period of interest
pe_dt[,diff:=event_date-start_preg]
#remove all records with date before start date pregnancy+lookback
before[[w]]<-data.table(StudyVar=names_events[pe_fl], before_start=pe_dt[diff<0,.N])
pe_dt<-pe_dt[diff>=0]
pe_dt[,diff:=NULL][,lookback:=NULL][,start_preg:=NULL]
}else{
#remove all records before start obs
pe_dt[,start:=obs_period[StudyVar==names_events[pe_fl],start_date]]
pe_dt[,start_preg:=as.IDate(pregnancy_start_date+start)]
pe_dt[,diff:=event_date-start_preg]
before[[w]]<-data.table(StudyVar=names_events[pe_fl], before_start=pe_dt[diff<0,.N])
pe_dt<-pe_dt[diff>=0]
pe_dt[,diff:=NULL][,start:=NULL][,start_preg:=NULL]
}
if(pe_dt[,.N]>0){
if(obs_period[StudyVar==names_events[pe_fl],after]>0){
pe_dt[,after:=obs_period[StudyVar==names_events[pe_fl],after]]
pe_dt[,end_preg:=as.IDate(pregnancy_end_date+after)]
pe_dt[,diff:=event_date-end_preg]
after[[w]]<-data.table(StudyVar=names_events[pe_fl], after_end=pe_dt[diff>0,.N])
pe_dt<-pe_dt[diff<=0]
pe_dt[,diff:=NULL][,after:=NULL][,end_preg:=NULL]
}else{
pe_dt[,end:=obs_period[StudyVar==names_events[pe_fl],end_date]]
pe_dt[,end_preg:=as.IDate(pregnancy_start_date+end)]
pe_dt[,diff:=event_date-end_preg]
after[[w]]<-data.table(StudyVar=names_events[pe_fl], after_end=pe_dt[diff>0,.N])
pe_dt<-pe_dt[diff<=0]
pe_dt[,diff:=NULL][,end:=NULL][,end_preg:=NULL]
}
}else{
after[[w]]<-data.table(StudyVar=names_events[pe_fl], after_end=0)
}
sum[[w]]<-data.table(StudyVar=names_events[pe_fl], no_records=pe_dt[!is.na(event_date),.N], no_pregnancies=pe_dt[!duplicated(pregnancy_id),.N])
saveRDS(pe_dt, paste0(projectFolder,"/g_intermediate/pe_algorithm/final_d3/", names_events[pe_fl],"_pregnancy_D3.rds"))
pe_dt
pe_fl
pe_fl<-1
pe_dt<-readRDS(paste0(projectFolder,"/g_intermediate/pe_algorithm/", pe_files[pe_fl]))
#merge with the pregnancy d3
pe_dt<-merge.data.table(pregnancy_d3_gdm_pe, pe_dt, by="person_id", all.x=T, allow.cartesian = T)
pe_dt<-pe_dt[!is.na(event_date)]
original[[w]]<-data.table(StudyVar=names_events[pe_fl], event_records=pe_dt[,.N])
pe_dt[,event_date:=as.IDate(event_date)]
if(obs_period[StudyVar==names_events[pe_fl],lookback]>0){
pe_dt[,lookback:=obs_period[StudyVar==names_events[pe_fl],lookback]]
pe_dt[,start_preg:=as.IDate(pregnancy_start_date-lookback)]
#exclude all pregnancies that are outside observation period of interest
pe_dt[,diff:=event_date-start_preg]
#remove all records with date before start date pregnancy+lookback
before[[w]]<-data.table(StudyVar=names_events[pe_fl], before_start=pe_dt[diff<0,.N])
pe_dt<-pe_dt[diff>=0]
pe_dt[,diff:=NULL][,lookback:=NULL][,start_preg:=NULL]
}else{
#remove all records before start obs
pe_dt[,start:=obs_period[StudyVar==names_events[pe_fl],start_date]]
pe_dt[,start_preg:=as.IDate(pregnancy_start_date+start)]
pe_dt[,diff:=event_date-start_preg]
before[[w]]<-data.table(StudyVar=names_events[pe_fl], before_start=pe_dt[diff<0,.N])
pe_dt<-pe_dt[diff>=0]
pe_dt[,diff:=NULL][,start:=NULL][,start_preg:=NULL]
}
if(pe_dt[,.N]>0){
if(obs_period[StudyVar==names_events[pe_fl],after]>0){
pe_dt[,after:=obs_period[StudyVar==names_events[pe_fl],after]]
pe_dt[,end_preg:=as.IDate(pregnancy_end_date+after)]
pe_dt[,diff:=event_date-end_preg]
after[[w]]<-data.table(StudyVar=names_events[pe_fl], after_end=pe_dt[diff>0,.N])
pe_dt<-pe_dt[diff<=0]
pe_dt[,diff:=NULL][,after:=NULL][,end_preg:=NULL]
}else{
pe_dt[,end:=obs_period[StudyVar==names_events[pe_fl],end_date]]
pe_dt[,end_preg:=as.IDate(pregnancy_start_date+end)]
pe_dt[,diff:=event_date-end_preg]
after[[w]]<-data.table(StudyVar=names_events[pe_fl], after_end=pe_dt[diff>0,.N])
pe_dt<-pe_dt[diff<=0]
pe_dt[,diff:=NULL][,end:=NULL][,end_preg:=NULL]
}
}else{
after[[w]]<-data.table(StudyVar=names_events[pe_fl], after_end=0)
}
#create a summary of included records
sum[[w]]<-data.table(StudyVar=names_events[pe_fl], no_records=pe_dt[!is.na(event_date),.N], no_pregnancies=pe_dt[!duplicated(pregnancy_id),.N])
saveRDS(pe_dt, paste0(projectFolder,"/g_intermediate/pe_algorithm/final_d3/", names_events[pe_fl],"_pregnancy_D3.rds"))
cols<-c("person_id","pregnancy_id","pregnancy_start_date","pregnancy_end_date", "maternal_age")
pe_dt<-pe_dt[,cols,with=F]
pe_dt[,names_events[pe_fl]:=1]
pe_dt<-pe_dt[,lapply(.SD,sum),.SDcols = names_events[pe_fl], by=c("person_id","pregnancy_id","pregnancy_start_date","pregnancy_end_date","maternal_age")]
names_events
initial_time<-Sys.time()
date_running_start<-Sys.Date()
age_band_creation<-function(x){
if(x>=15 & x<=24){y<-"15-24"}
if(x>=25 & x<=29){y<-"25-29"}
if(x>=30 & x<=34){y<-"30-34"}
if(x>=35 & x<=39){y<-"35-39"}
if(x>=40){y<-"40+"}
return(y)
}
year_group_creation<-function(x){
if(x>=2005 & x<=2009){y<-"2005-2009"}
if(x>=2010 & x<=2014){y<-"2010-2014"}
if(x>=2015 & x<=2019){y<-"2015-2019"}
return(y)
}
#Load all gdm_algorithm file and combine with the pregnancy D3
pregnancy_d3_gdm_pe<-readRDS(paste0(projectFolder,"/g_intermediate/pregnancy_d3/GDM_PE_Pregnancy_D3.rds"))
pregnancy_d3_gdm_pe[,pregnancy_start_date:=as.IDate(pregnancy_start_date)][,pregnancy_end_date:=as.IDate(pregnancy_end_date)][,birth_date:=as.IDate(birth_date)][,death_date:=as.IDate(death_date)][,op_start_date_gdm_pe:=as.IDate(op_start_date_gdm_pe)][,op_end_date_gdm_pe:=as.IDate(op_end_date_gdm_pe)]
pregnancy_d3_gdm_pe[,age:=floor((pregnancy_start_date-birth_date)/365.25)]
pregnancy_d3_gdm_pe[,maternal_age:=lapply(age, age_band_creation)]
pregnancy_d3_gdm_pe[,year:=year(pregnancy_start_date)]
pregnancy_d3_gdm_pe[,year_group:=lapply(year, year_group_creation)]
obs_period<-data.table(StudyVar=c("PE","ECL","HELLP","PE_checkbox"),
lookback=c(0,0,0,0),
start_date=c(20*7,20*7,20*7,20*7),
end_date=c(7*40,7*40,7*40,7*40),
after=c(7,7,7,7))
#pe files
pe_files<-list.files(paste0(projectFolder,"/g_intermediate/pe_algorithm/"))
names_events<-list()
for(i in 1:length(pe_files)){
names_events[[i]]<-unlist(str_split(pe_files[i],"[.]"))[1]
}
names_events<-as.vector(do.call(rbind,names_events))
original<-list()
before<-list()
after<-list()
sum<-list()
dir.create(paste0(projectFolder,"/g_intermediate/pe_algorithm/final_d3"))
w<-1
pe_dt<-readRDS(paste0(projectFolder,"/g_intermediate/pe_algorithm/", pe_files[pe_fl]))
#merge with the pregnancy d3
pe_dt<-merge.data.table(pregnancy_d3_gdm_pe, pe_dt, by="person_id", all.x=T, allow.cartesian = T)
pe_dt<-pe_dt[!is.na(event_date)]
original[[w]]<-data.table(StudyVar=names_events[pe_fl], event_records=pe_dt[,.N])
pe_dt[,event_date:=as.IDate(event_date)]
if(obs_period[StudyVar==names_events[pe_fl],lookback]>0){
pe_dt[,lookback:=obs_period[StudyVar==names_events[pe_fl],lookback]]
pe_dt[,start_preg:=as.IDate(pregnancy_start_date-lookback)]
#exclude all pregnancies that are outside observation period of interest
pe_dt[,diff:=event_date-start_preg]
#remove all records with date before start date pregnancy+lookback
before[[w]]<-data.table(StudyVar=names_events[pe_fl], before_start=pe_dt[diff<0,.N])
pe_dt<-pe_dt[diff>=0]
pe_dt[,diff:=NULL][,lookback:=NULL][,start_preg:=NULL]
}else{
#remove all records before start obs
pe_dt[,start:=obs_period[StudyVar==names_events[pe_fl],start_date]]
pe_dt[,start_preg:=as.IDate(pregnancy_start_date+start)]
pe_dt[,diff:=event_date-start_preg]
before[[w]]<-data.table(StudyVar=names_events[pe_fl], before_start=pe_dt[diff<0,.N])
pe_dt<-pe_dt[diff>=0]
pe_dt[,diff:=NULL][,start:=NULL][,start_preg:=NULL]
}
if(pe_dt[,.N]>0){
if(obs_period[StudyVar==names_events[pe_fl],after]>0){
pe_dt[,after:=obs_period[StudyVar==names_events[pe_fl],after]]
pe_dt[,end_preg:=as.IDate(pregnancy_end_date+after)]
pe_dt[,diff:=event_date-end_preg]
after[[w]]<-data.table(StudyVar=names_events[pe_fl], after_end=pe_dt[diff>0,.N])
pe_dt<-pe_dt[diff<=0]
pe_dt[,diff:=NULL][,after:=NULL][,end_preg:=NULL]
}else{
pe_dt[,end:=obs_period[StudyVar==names_events[pe_fl],end_date]]
pe_dt[,end_preg:=as.IDate(pregnancy_start_date+end)]
pe_dt[,diff:=event_date-end_preg]
after[[w]]<-data.table(StudyVar=names_events[pe_fl], after_end=pe_dt[diff>0,.N])
pe_dt<-pe_dt[diff<=0]
pe_dt[,diff:=NULL][,end:=NULL][,end_preg:=NULL]
}
}else{
after[[w]]<-data.table(StudyVar=names_events[pe_fl], after_end=0)
}
sum[[w]]<-data.table(StudyVar=names_events[pe_fl], no_records=pe_dt[!is.na(event_date),.N], no_pregnancies=pe_dt[!duplicated(pregnancy_id),.N])
saveRDS(pe_dt, paste0(projectFolder,"/g_intermediate/pe_algorithm/final_d3/", names_events[pe_fl],"_pregnancy_D3.rds"))
pe_dt
names(pe_dt)
cols<-c("person_id","pregnancy_id","pregnancy_start_date","pregnancy_end_date","year","age", "maternal_age","year_group")
pe_dt<-pe_dt[,cols,with=F]
pe_dt[,names_events[pe_fl]:=1]
pe_dt
names_events[pe_fl]
pe_dt[,lapply(.SD,sum),.SDcols = names_events[pe_fl], by=c("person_id","pregnancy_id","pregnancy_start_date","pregnancy_end_date","year","age", "maternal_age","year_group")]
pe_dt[,lapply(.SD,sum),.SDcols = get(names_events[pe_fl]), by=c("person_id","pregnancy_id","pregnancy_start_date","pregnancy_end_date","year","age", "maternal_age","year_group")]
names_events[pe_fl]
pe_dt[,.N, by=c("person_id","pregnancy_id","pregnancy_start_date","pregnancy_end_date","year","age", "maternal_age","year_group",names_events[pe_fl])]
names_events[pe_fl]
pe_dt[, names_events[pe_fl]=.N, by=c("person_id","pregnancy_id","pregnancy_start_date","pregnancy_end_date","year","age", "maternal_age", "year_group")]
pe_dt[, names_events[pe_fl]:=.N, by=c("person_id","pregnancy_id","pregnancy_start_date","pregnancy_end_date","year","age", "maternal_age", "year_group")]
pe_dt[,.N, by=c("person_id","pregnancy_id","pregnancy_start_date","pregnancy_end_date","year","age", "maternal_age", "year_group")]
pe_dt[ , names_events[pe_fl]:=.N, by=list(person_id,pregnancy_id,pregnancy_start_date,pregnancy_end_date,year,age,maternal_age,year_group)]
pe_dt[ ,.N, by=list(person_id,pregnancy_id,pregnancy_start_date,pregnancy_end_date,year,age,maternal_age,year_group)]
