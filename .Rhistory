if(length(mask_cols>0)){
for (j in 1:length(mask_cols)){
target_col<-mask_cols[j]
#my_file[,..target_col]<-
print( mask(my_file[,..target_col]))
}
}
}
for (i in 1:length(raw_file)){
print(i)
print(raw_file[i])
my_file<-fread(paste0(output_dir,raw_file[i]))
mask_cols<-my_cols[my_cols%in%colnames(my_file)]
print(mask_cols)
if(length(mask_cols>0)){
for (j in 1:length(mask_cols)){
target_col<-mask_cols[j]
#my_file[,..target_col]<-
print( mask(my_file[,..target_col]))
}
}
}
output_dir
dir.create(paste0(output_dir,'masked/'), showWarnings = FALSE)
masked_folder<-paste0(output_dir,'masked/')
for (i in 1:length(raw_file)){
print(i)
print(raw_file[i])
my_file<-fread(paste0(output_dir,raw_file[i]))
mask_cols<-my_cols[my_cols%in%colnames(my_file)]
print(mask_cols)
if(length(mask_cols>0)){
for (j in 1:length(mask_cols)){
target_col<-mask_cols[j]
#my_file[,..target_col]<-
print( mask(my_file[,..target_col]))
}
fwrite(my_file, paste0(masked_folder,"masked",raw_file[i]))}
}
masked_folder
raw_file
filename<-split(raw_file[i],"/")
filename
filename<-str_split(raw_file[i],"/")
filename
filename<-str_split(raw_file[i],"/")[2]
filename
filename<-str_split(raw_file[i],"/")
filename
filename[2]
filename[[1]][2]
filename<-str_split(raw_file[i],"/")[[1]][2]
fwrite(my_file, paste0(masked_folder,"masked",raw_file[i]))}
filename
fwrite(my_file, paste0(masked_folder,"masked",filename))}
fwrite(my_file, paste0(masked_folder,"masked",filename))
#my_file[,..target_col]<-
my_file$paste0('mask_',target_col)<- mask(my_file[,..target_col])
paste0('mask_',target_col)
my_file[,..target_col]<-NA
my_file[,..target_col]
my_file$included_records<-sample(c(2,6,5), size=8, replace=T)
my_file$removed_rec<-sample(c(2,6,5), size=8, replace=T)
mask_cols<-my_cols[my_cols%in%colnames(my_file)]
print(mask_cols)
if(length(mask_cols>0)){
for (j in 1:length(mask_cols)){
target_col<-mask_cols[j]
#my_file[,..target_col]<-
my_file$paste0('mask_',target_col)<- mask(my_file[,..target_col])
}
my_file
View(my_file)
length(mask_cols>0
my_file
if(length(mask_cols>0)){
for (j in 1:length(mask_cols)){
target_col<-mask_cols[j]
#my_file[,..target_col]<-
my_file$paste0('mask_',target_col)<- mask(my_file[,..target_col])
}
for (j in 1:length(mask_cols)){
target_col<-mask_cols[j]
#my_file[,..target_col]<-
newcol<- mask(my_file[,..target_col])
print(newcol)
}
for (j in 1:length(mask_cols)){
target_col<-mask_cols[j]
#my_file[,..target_col]<-
newcol<- mask(my_file[,..target_col])
print(newcol)
}
for (j in 1:length(mask_cols)){
target_col<-mask_cols[j]
#my_file[,..target_col]<-
newcol<- mask(my_file[,..target_col])
print(newcol)
my_file<-cbind(my_file, newcol)
print(my_file)
}
colnames(newcol)<-(paste0("mask_", target_col))
print(newcol)
my_file<-cbind(my_file, newcol)
print(my_file)
filename<-str_split(raw_file[i],"/")[[1]][2]
filename
filename<-str_split(raw_file[i],"/")
filename
for (i in 1:length(raw_file)){
print(i)
print(raw_file[i])
my_file<-fread(paste0(output_dir,raw_file[i]))
mask_cols<-my_cols[my_cols%in%colnames(my_file)]
print(mask_cols)
if(length(mask_cols>0)){
for (j in 1:length(mask_cols)){
target_col<-mask_cols[j]
#my_file[,..target_col]<-
newcol<- mask(my_file[,..target_col])
colnames(newcol)<-(paste0("mask_", target_col))
print(newcol)
my_file<-cbind(my_file, newcol)
print(my_file)
}
filename<-str_split(raw_file[i],"/")
fwrite(my_file, paste0(masked_folder,"masked",filename[[1]][1],"_",filename[[1]][2]))}
}
####Clean pregnancies####
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source("99_path.R")
setwd(projectFolder)
raw_file<-list.files(tables_dir, pattern=".csv", recursive = TRUE)
raw_file<-raw_file[!grepl('^final', raw_file)]
masked_folder<-paste0(output_dir,'masked_tables/')
dir.create(masked_folder, showWarnings = FALSE)
raw_file
raw_file<-grep(list.files(path=tables_dir), pattern='final', invert=TRUE, value=TRUE)
raw_file
mask= function(x){
x[x<6]<-"<=5"
return (x)}
for (i in 1:length(raw_file)){
#print(i)
print(raw_file[i])
my_file<-fread(paste0(output_dir,raw_file[i]))
my_file$masked_N<-mask(my_file$N)
fwrite(my_file, paste0(masked_folder,"masked_",raw_file[i]))
}
for (i in 1:length(raw_file)){
#print(i)
print(raw_file[i])
my_file<-fread(paste0(tables_dir,raw_file[i]))
my_file$masked_N<-mask(my_file$N)
fwrite(my_file, paste0(masked_folder,"masked_",raw_file[i]))
}
mask= function(x){
x[between(x, 0,5,incbounds = T)]<-"<=5"
return (x)}
for (i in 1:length(raw_file)){
#print(i)
print(raw_file[i])
my_file<-fread(paste0(tables_dir,raw_file[i]))
my_file$masked_N<-mask(my_file$N)
fwrite(my_file, paste0(masked_folder,"masked_",raw_file[i]))
}
mask= function(x){
x[between(x, 1,5,incbounds = T)]<-"<=5"
return (x)}
for (i in 1:length(raw_file)){
#print(i)
print(raw_file[i])
my_file<-fread(paste0(tables_dir,raw_file[i]))
my_file$masked_N<-mask(my_file$N)
fwrite(my_file, paste0(masked_folder,"masked_",raw_file[i]))
}
prop<-prop.test(5,my_file$Denominator[1])
prop
prop$estimate
for (i in 1:length(raw_file)){
#print(i)
print(raw_file[i])
my_file<-fread(paste0(tables_dir,raw_file[i]))
my_file$masked_N<-mask(my_file$N)
prop<-prop.test(5,my_file$Denominator[1])
perc<-5/my_file$Denominator[1]
lower<-(prop$conf.int[1])
upper<-(prop$conf.int[2])
perc<-round(perc*100, 2)
lower<-round((lower)*100, 2)
upper<-round((upper)*100, 2)
my_file$mask_CI<-my_file$Prevalence..95..CI.
my_file$mask_CI[between(my_file$N,1,5,incbounds = T),]<-paste0(perc,"% (",lower, "-", upper,")")
fwrite(my_file, paste0(masked_folder,"masked_",raw_file[i]))
}
for (i in 1:length(raw_file)){
#print(i)
print(raw_file[i])
my_file<-fread(paste0(tables_dir,raw_file[i]))
my_file$masked_N<-mask(my_file$N)
prop<-prop.test(5,my_file$Denominator[1])
perc<-5/my_file$Denominator[1]
lower<-(prop$conf.int[1])
upper<-(prop$conf.int[2])
perc<-round(perc*100, 2)
lower<-round((lower)*100, 2)
upper<-round((upper)*100, 2)
my_file$mask_CI<-my_file$Prevalence..95..CI.
my_file$mask_CI[between(my_file$N,1,5,incbounds = T)]<-paste0(perc,"% (",lower, "-", upper,")")
fwrite(my_file, paste0(masked_folder,"masked_",raw_file[i]))
}
select(my_file -c(N, Prevalence..95..CI.))
select(my_file, -c(N, Prevalence..95..CI.))
for (i in 1:length(raw_file)){
#print(i)
print(raw_file[i])
my_file<-fread(paste0(tables_dir,raw_file[i]))
my_file$masked_N<-mask(my_file$N)
prop<-prop.test(5,my_file$Denominator[1])
perc<-5/my_file$Denominator[1]
lower<-(prop$conf.int[1])
upper<-(prop$conf.int[2])
perc<-round(perc*100, 2)
lower<-round((lower)*100, 2)
upper<-round((upper)*100, 2)
my_file$mask_CI<-my_file$Prevalence..95..CI.
my_file$mask_CI[between(my_file$N,1,5,incbounds = T)]<-paste0(perc,"% (",lower, "-", upper,")")
my_file<-select(my_file, -c(N, Prevalence..95..CI.))
fwrite(my_file, paste0(masked_folder,"masked_",raw_file[i]))
}
#masking script for DP4
# (1) For masking, I checked the tables and I think it is enough if you loop over all the tables and mask the columns if their names belong to one of the below:
#   c("removed_rec", "included_records", "no_records", "no_diagnosed_pregnancies", "no_pregnancies", "no_pregnancies_same_type", "Count", "original_records", "before_start", "after_end")
#
# --> assume tables all in g_output
#
#set packages and paths so file can be run independently
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source("99_path.R")
setwd(projectFolder)
masked_folder<-paste0(output_dir,'masked/')
dir.create(masked_folder, showWarnings = FALSE)
#list all files in g_output
raw_file<-list.files(output_dir, pattern=".csv", recursive = TRUE)
raw_file<-raw_file[!grepl('^Time$|log|flowchart|issues', raw_file)]
#loop read and add column "x___masked" and make all values 5 or less ==5 for each of the target columns
my_cols<-list("removed_rec", "included_records", "no_records", "no_diagnosed_pregnancies",
"no_pregnancies", "no_pregnancies_same_type", "Count", "original_records",
"before_start", "after_end")
mask= function(x){
x[between(x, 1,5,incbounds = T)]<-"<=5"
return (x)}
for (i in 1:length(raw_file)){
#print(i)
print(raw_file[i])
my_file<-fread(paste0(output_dir,raw_file[i]))
mask_cols<-my_cols[my_cols%in%colnames(my_file)]
#print(mask_cols)
if(length(mask_cols>0)){
for (j in 1:length(mask_cols)){
target_col<-mask_cols[j]
#my_file[,..target_col]<-
newcol<- mask(my_file[,..target_col])
colnames(newcol)<-(paste0("mask_", target_col))
#print(newcol)
my_file<-cbind(my_file, newcol)
my_file[,(target_col):=NULL]
#print(my_file)
}
filename<-str_split(raw_file[i],"/")
fwrite(my_file, paste0(masked_folder,"masked_",filename[[1]][1],"_",filename[[1]][2]))}
}
age_band_creation<-function(x){
y<-vector()
if(x>=15 & x<=24){y<-"15-24"}
if(x>=25 & x<=34){y<-"25-34"}
if(x>=35){y<-"35+"}
return(y)
}
maternal_age<-sample(15:50, size=10, replace=T)
age_band<-lappl(maternal_age, age_band_creation)
age_band<-lapply(maternal_age, age_band_creation)
View(age_band)
View(mask_cols)
View(my_cols)
age_band<-unlist(age_band)
id<-1:10
df1<-as.data.frame(cbind(id, maternal_age, age_band))
df2<-as.data.frame(cbind(id, maternal_age))
df_list<-c(df1, df2)
View(df_list)
df_list<-as.list(c(df1, df2))
df_list<-list(df1, df2)
View(df_list)
df_list[1]
alg_list<-df_list
alg_list[2]$age_band
is.null(alg_list[2]$age_band)
for (i in 1:length(alg_list)){
if(is.null(alg_list[i]$age_band)){
alg_list[i]$age_band<-alg_list[i]$maternal_age
if(is.numeric(alg_list[i]$age_band)){
alg_list[i]$age_band[between(age_band, 15, 24, incbounds = T)]<-"15-24"
alg_list[i]$age_band[between(age_band, 25, 34, incbounds = T)]<-"25-34"
alg_list[i]$age_band[age_band>34 ]<-"35+"
}
}
}
View(df1)
View(df2)
View(df_list)
View(alg_list)
for (i in 1:length(alg_list)){
print(alg_list[i])
if(is.null(alg_list[i]$age_band)){
alg_list[i]$age_band<-alg_list[i]$maternal_age
if(is.numeric(alg_list[i]$age_band)){
alg_list[i]$age_band[between(age_band, 15, 24, incbounds = T)]<-"15-24"
alg_list[i]$age_band[between(age_band, 25, 34, incbounds = T)]<-"25-34"
alg_list[i]$age_band[age_band>34 ]<-"35+"
}
}
}
for (i in 1:length(alg_list)){
print(alg_list[i])
if(is.null(alg_list[i]$age_band)){
print('NULL')
alg_list[i]$age_band<-alg_list[i]$maternal_age
if(is.numeric(alg_list[i]$age_band)){
alg_list[i]$age_band[between(age_band, 15, 24, incbounds = T)]<-"15-24"
alg_list[i]$age_band[between(age_band, 25, 34, incbounds = T)]<-"25-34"
alg_list[i]$age_band[age_band>34 ]<-"35+"
}
}
}
for (i in 1:length(alg_list)){
print(alg_list[i])
if(is.null(alg_list[i]$age_band)){
print('NULL')
age_band<-alg_list[i]$maternal_age
if(is.numeric(age_band)){
age_band[between(age_band, 15, 24, incbounds = T)]<-"15-24"
age_band[between(age_band, 25, 34, incbounds = T)]<-"25-34"
age_band[age_band>34 ]<-"35+"
}
print(age_band)
alg_list[i]<-cbind(alg_list[i], age_band)
}
}
is.numeric(age_band)
age_band<-alg_list[2]$maternal_age
is.numeric(age_band)
class(age_band)
age_band<-alg_list[2]$maternal_age
age_band
alg_list[2]$maternal_age
age_band<-alg_list[[2]]$maternal_age
is.numeric(age_band)
for (i in 1:length(alg_list)){
print(alg_list[i])
if(is.null(alg_list[i]$age_band)){
print('NULL')
age_band<-alg_list[[i]]$maternal_age
if(is.numeric(age_band)){
age_band[between(age_band, 15, 24, incbounds = T)]<-"15-24"
age_band[between(age_band, 25, 34, incbounds = T)]<-"25-34"
age_band[age_band>34 ]<-"35+"
}
print(age_band)
alg_list[i]<-cbind(alg_list[i], age_band)
}
}
for (i in 1:length(alg_list)){
print(alg_list[i])
if(is.null(alg_list[i]$age_band)){
print('NULL')
age_band<-alg_list[[i]]$maternal_age
if(is.numeric(age_band)){
age_band[between(age_band, 15, 24, incbounds = T)]<-"15-24"
age_band[between(age_band, 25, 34, incbounds = T)]<-"25-34"
age_band[age_band>34 ]<-"35+"
}
print(age_band)
alg_list$age_band<- age_band
}
}
View(df2)
alg_list<-df_list
for (i in 1:length(alg_list)){
print(alg_list[i])
if(is.null(alg_list[i]$age_band)){
print('NULL')
age_band<-alg_list[[i]]$maternal_age
if(is.numeric(age_band)){
age_band[between(age_band, 15, 24, incbounds = T)]<-"15-24"
age_band[between(age_band, 25, 34, incbounds = T)]<-"25-34"
age_band[age_band>34 ]<-"35+"
}
print(age_band)
alg_list[[i]]$age_band<- age_band
}
}
View(df2)
for (i in 1:length(alg_list)){
print(alg_list[i])
if(is.null(alg_list[i]$age_band)){
print('NULL')
age_band<-alg_list[[i]]$maternal_age
if(is.numeric(age_band)){
age_band[between(age_band, 15, 24, incbounds = T)]<-"15-24"
age_band[between(age_band, 25, 34, incbounds = T)]<-"25-34"
age_band[age_band>34 ]<-"35+"
}
print(age_band)
alg_list[i]$age_band<- age_band
}
}
View(alg_list)
df_list[[1]]
df_list[[2]]
View(df_list)
for (i in 1:length(alg_list)){
print(alg_list[i])
if(is.null(alg_list[i]$age_band)){
print('NULL')
age_band<-alg_list[[i]]$maternal_age
if(is.numeric(age_band)){
age_band[between(age_band, 15, 24, incbounds = T)]<-"15-24"
age_band[between(age_band, 25, 34, incbounds = T)]<-"25-34"
age_band[age_band>34 ]<-"35+"
}
print(age_band)
alg_list[i]$age_band<- age_band
}
}
View(df_list)
for (i in 1:length(alg_list)){
print(alg_list[i])
if(is.null(alg_list[i]$age_band)){
print('NULL')
age_band<-alg_list[[i]]$maternal_age
if(is.numeric(age_band)){
age_band[between(age_band, 15, 24, incbounds = T)]<-"15-24"
age_band[between(age_band, 25, 34, incbounds = T)]<-"25-34"
age_band[age_band>34 ]<-"35+"
}
print(age_band)
alg_list[[i]]$age_band<- age_band
}
}
View(df_list)
is.numeric(age_band)
i<-2
my_alg<-alg_list[[i]]
View(my_alg)
View(alg_list)
alg_list(df_list)
alg_list<-(df_list)
for (i in 1:length(alg_list)){
if(is.null(alg_list[[i]]$age_band)){
print('NULL')
age_band<-alg_list[[i]]$maternal_age
if(is.numeric(age_band)){
age_band[between(age_band, 15, 24, incbounds = T)]<-"15-24"
age_band[between(age_band, 25, 34, incbounds = T)]<-"25-34"
age_band[age_band>34 ]<-"35+"
}
print(age_band)
alg_list[[i]]$age_band<- age_band
}
}
View(alg_list)
alg<-rbind(alg_1,alg_2,alg_3,alg_4,alg_5,alg_6,alg_7,alg_8,alg_9,alg_10,alg_11, fill=TRUE)
rbind(unlist(alg_list))
df3<-rbind(unlist(alg_list), fill=T)
View(df3)
df3<-rbind((alg_list), fill=T)
View(df3)
View(alg_list)
rbind(alg_list[[1]], alg_list[[2]])
alg_list<-c(df1, df2)
View(alg_list)
alg_list<-[df1, df2]
alg_list<-[df1, df2]
alg_list<-list(df_1, df_2)
alg_list<-list(df1, df2)
for (i in 1:length(alg_list)){
if(is.null(alg_list[[i]]$age_band)){
print('NULL')
age_band<-alg_list[[i]]$maternal_age
if(is.numeric(age_band)){
age_band[between(age_band, 15, 24, incbounds = T)]<-"15-24"
age_band[between(age_band, 25, 34, incbounds = T)]<-"25-34"
age_band[age_band>34 ]<-"35+"
}
print(age_band)
alg_list[[i]]$age_band<- age_band
}
}
alg<-rbind(alg_1,alg_2,alg_3,alg_4,alg_5,alg_6,alg_7,alg_8,alg_9,alg_10,alg_11, fill=TRUE)
View(alg_list)
do.call("rbind", alg_list)
