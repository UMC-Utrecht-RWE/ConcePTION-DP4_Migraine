gdm_diag_checkbox_mo<-diag_checkbox_gdm_mo[table=="MEDICAL_OBSERVATIONS"]
if(gdm_diag_checkbox_mo[,.N]>0){
names_df<-names(df)
same_names<-intersect(names_df,names(gdm_diag_checkbox_mo))
df<-merge.data.table(df,gdm_diag_checkbox_mo,by=same_names,all.x=T)
if(df[!is.na(event_abbreviation),.N]>0){
for(cat_ind in 1:gdm_diag_checkbox_mo[!duplicated(index),.N]){
cols_to_keep<-c(unique(gdm_diag_checkbox_mo[cat_ind==index,checkbox_date]),unique(gdm_diag_checkbox_mo[cat_ind==index,keep]))
#rename columns
setnames(df,unique(gdm_diag_checkbox_mo[cat_ind==index,checkbox_date]), "event_date")
setnames(df,unique(gdm_diag_checkbox_mo[cat_ind==index,keep]), "event_code")
setnames(df, "mo_meaning", "meaning")
setnames(df, "event_abbreviation", "condition")
#date variable
df[,event_date:=as.IDate(event_date, "%Y%m%d")]
df[,prior_gdm_pe:=ifelse(gdm_pe_start_study_date>event_date,1,0)]
df[,after_gdm_pe:=ifelse(gdm_pe_end_study_date<event_date,1,0)]
if(!"year" %in% names(df)){df[,year:=year(event_date)]}
df[prior_gdm_pe==0 & after_gdm_pe==0 & !is.na(condition),include:=1]
df[,prior_gdm_pe:=NULL][,after_gdm_pe:=NULL]
if(df[include==1 & index==cat_ind,.N]>0){
cols_to_keep<-c("event_date","event_code", "person_id","meaning","condition","year")
years_cat<-sort(df[include==1 & index==cat_ind][!duplicated(year),year])
for(year_ind in 1:length(years_cat)){
saveRDS(df[include==1 & !is.na(condition)][year==years_cat[year_ind] & index==cat_ind, cols_to_keep, with=F], paste0(projectFolder,"/g_intermediate/tmp/", years_cat[year_ind],"_", "GDM_diagnoses_checkbox_mo",cat_ind,".rds"))
}# new 01.06.2022
}
if("years_cat" %in% ls()){rm(years_cat)}
if("year_ind" %in% ls()){rm(year_ind)}
#rename columns
setnames(df, "event_date", unique(gdm_diag_checkbox_mo[cat_ind==index,checkbox_date]))
setnames(df,"event_code", unique(gdm_diag_checkbox_mo[cat_ind==index,keep]))
setnames(df, "meaning", "mo_meaning")
setnames(df, "condition", "event_abbreviation")
}
df[,table:=NULL][,event_abbreviation:=NULL][,keep:=NULL][,index:=NULL]
}
}
}
}
#remove uneccessary variables
if("checkbox_date" %in% names(df)){df[,checkbox_date:=NULL]}
if("include" %in% names(df)){df[,include:=NULL]}
if("year" %in% names(df)){df[,year:=NULL]}
#PE
if(!is.null(diag_checkbox_pe_mo)){
if(df[,.N]>0){
print(paste0("Filtering data for PE checkbox:", actual_tables$MEDICAL_OBSERVATIONS[y]))
pe_diag_checkbox_mo<-diag_checkbox_pe_mo[table=="MEDICAL_OBSERVATIONS"]
if(pe_diag_checkbox_mo[,.N]>0){
names_df<-names(df)
same_names<-intersect(names_df,names(pe_diag_checkbox_mo))
df<-merge.data.table(df,pe_diag_checkbox_mo,by=same_names,all.x=T)
if(df[!is.na(event_abbreviation),.N]>0){
for(cat_ind in 1:pe_diag_checkbox_mo[!duplicated(index),.N]){
cols_to_keep<-c(unique(pe_diag_checkbox_mo[cat_ind==index,checkbox_date]),unique(pe_diag_checkbox_mo[cat_ind==index,keep]))
#rename columns
setnames(df,unique(pe_diag_checkbox_mo[cat_ind==index,checkbox_date]), "event_date")
setnames(df,unique(pe_diag_checkbox_mo[cat_ind==index,keep]), "event_code")
setnames(df, "mo_meaning", "meaning")
setnames(df, "event_abbreviation", "condition")
#date variable
df[,event_date:=as.IDate(event_date, "%Y%m%d")]
df[,prior_gdm_pe:=ifelse(gdm_pe_start_study_date>event_date,1,0)]
df[,after_gdm_pe:=ifelse(gdm_pe_end_study_date<event_date,1,0)]
if(!"year" %in% names(df)){df[,year:=year(event_date)]}
df[prior_gdm_pe==0 & after_gdm_pe==0 & !is.na(condition),include:=1]
df[,prior_gdm_pe:=NULL][,after_gdm_pe:=NULL]
if(df[include==1 & index==cat_ind,.N]>0){
cols_to_keep<-c("event_date","event_code", "person_id","meaning","condition","year")
years_cat<-sort(df[include==1 & !is.na(condition) & index==cat_ind][!duplicated(year),year])
for(year_ind in 1:length(years_cat)){
saveRDS(df[include==1 & !is.na(condition)][year==years_cat[year_ind] & index==cat_ind, cols_to_keep, with=F], paste0(projectFolder,"/g_intermediate/tmp/", years_cat[year_ind],"_", "PE_diagnoses_checkbox_mo",cat_ind,".rds"))
}# new 01.06.2022
}
if("years_cat" %in% ls()){rm(years_cat)}
if("year_ind" %in% ls()){rm(year_ind)}
#rename columns
setnames(df, "event_date", unique(pe_diag_checkbox_mo[cat_ind==index,checkbox_date]))
setnames(df,"event_code", unique(pe_diag_checkbox_mo[cat_ind==index,keep]))
setnames(df, "meaning", "mo_meaning")
setnames(df, "condition", "event_abbreviation")
#remove columns
if("checkbox_date" %in% names(df)){df[,checkbox_date:=NULL]}
}
df[,table:=NULL][,event_abbreviation:=NULL][,keep:=NULL][,index:=NULL]
}
}
}
}
if(sum(codesheet_diagnoses_gdm[table=="SURVEY_OBSERVATIONS",.N],
codesheet_diagnoses_pe[table=="SURVEY_OBSERVATIONS",.N],
codesheet_diagnoses_migraine[table=="SURVEY_OBSERVATIONS",.N])>0){
if(codesheet_diagnoses_gdm[table=="SURVEY_OBSERVATIONS",.N]>0){
if("code" %in% codesheet_diagnoses_gdm[table=="SURVEY_OBSERVATIONS",val_1]){
code_var<-codesheet_diagnoses_gdm[table=="SURVEY_OBSERVATIONS",col_1]
voc_var<-codesheet_diagnoses_gdm[table=="SURVEY_OBSERVATIONS",col_2]
date_var<-codesheet_diagnoses_gdm[table=="SURVEY_OBSERVATIONS",date_column]
}else{
code_var<-codesheet_diagnoses_gdm[table=="SURVEY_OBSERVATIONS",col_2]
voc_var<-codesheet_diagnoses_gdm[table=="SURVEY_OBSERVATIONS",col_1]
date_var<-codesheet_diagnoses_gdm[table=="SURVEY_OBSERVATIONS",date_column]
}
}
if(codesheet_diagnoses_pe[table=="SURVEY_OBSERVATIONS",.N]>0){
if("code" %in% codesheet_diagnoses_pe[table=="SURVEY_OBSERVATIONS",val_1]){
code_var<-codesheet_diagnoses_pe[table=="SURVEY_OBSERVATIONS",col_1]
voc_var<-codesheet_diagnoses_pe[table=="SURVEY_OBSERVATIONS",col_2]
date_var<-codesheet_diagnoses_pe[table=="SURVEY_OBSERVATIONS",date_column]
}else{
code_var<-codesheet_diagnoses_pe[table=="SURVEY_OBSERVATIONS",col_2]
voc_var<-codesheet_diagnoses_pe[table=="SURVEY_OBSERVATIONS",col_1]
date_var<-codesheet_diagnoses_pe[table=="SURVEY_OBSERVATIONS",date_column]
}
}
if(codesheet_diagnoses_migraine[table=="SURVEY_OBSERVATIONS",.N]>0){
if("code" %in% codesheet_diagnoses_migraine[table=="SURVEY_OBSERVATIONS",val_1]){
code_var<-codesheet_diagnoses_migraine[table=="SURVEY_OBSERVATIONS",col_1]
voc_var<-codesheet_diagnoses_migraine[table=="SURVEY_OBSERVATIONS",col_2]
date_var<-codesheet_diagnoses_migraine[table=="SURVEY_OBSERVATIONS",date_column]
}else{
code_var<-codesheet_diagnoses_migraine[table=="SURVEY_OBSERVATIONS",col_2]
voc_var<-codesheet_diagnoses_migraine[table=="SURVEY_OBSERVATIONS",col_1]
date_var<-codesheet_diagnoses_migraine[table=="SURVEY_OBSERVATIONS",date_column]
}
}}else{
code_var<-"so_source_value"
voc_var<-"so_source_column"
date_var<-"so_date"
}
hint_fl<-list.files(paste0(projectFolder, "/g_intermediate/pregnancy_d3/"), "obs_period_hint")
#use this table first to remove all uneccessary subjects(not needed for any of the studies)
obs_hint_table<-readRDS(paste0(projectFolder, "/g_intermediate/pregnancy_d3/", hint_fl))
print("Analyse SURVEY_OBSERVATIONS table.")
####List for saving info####
print("Creating lists to save the information.")
original_rows_gdm_pe<-list() #number of table original rows
#original_rows_gdm_pe_cat<-list() #number of table original rows
original_rows_mig<-list() #number of table original rows
#original_rows_mig_cat<-list() #number of table original rows
empty_event_date_gdm_pe<-list() #number of records with missing event date
#empty_event_date_gdm_pe_cat<-list() #number of records with missing event date
empty_event_date_mig<-list() #number of records with missing event date
#empty_event_date_mig_cat<-list() #number of records with missing event date
empty_event_code_gdm_pe<-list() #numer of records with missing event code
#empty_event_code_gdm_pe_cat<-list() #numer of records with missing event code
empty_event_code_mig<-list() #numer of records with missing event code
#empty_event_code_mig_cat<-list() #numer of records with missing event code
empty_event_vocabulary_gdm_pe<-list() #numer of records with missing event vocabulary
#empty_event_vocabulary_gdm_pe_cat<-list() #numer of records with missing event vocabulary
empty_event_vocabulary_mig<-list() #numer of records with missing event vocabulary
#empty_event_vocabulary_mig_cat<-list() #numer of records with missing event vocabulary
empty_event_meaning_gdm_pe<-list() #numer of records with missing event meaning
#empty_event_meaning_gdm_pe_cat<-list() #numer of records with missing event meaning
empty_event_meaning_mig<-list() #numer of records with missing event meaning
#empty_event_meaning_mig_cat<-list() #numer of records with missing event meaning
any_study_no<-list() #number of records for subjects not needed in any of the SAPs
outside_obs<-list() #number of records outside obs min and obs max between SAPs for each subject
prior_diagnoses_rec_gdm_pe<-list() #number of records with date prior to start study date
#prior_diagnoses_rec_gdm_pe_cat<-list() #number of records with date prior to start study date
prior_diagnoses_rec_mig<-list() #number of records with date prior to start study date
#prior_diagnoses_rec_mig_cat<-list() #number of records with date prior to start study date
after_diagnoses_rec_gdm_pe<-list() #number of records with date after end study date
#after_diagnoses_rec_gdm_pe_cat<-list() #number of records with date after end study date
after_diagnoses_rec_mig<-list() #number of records with date after end study date
#after_diagnoses_rec_mig_cat<-list() #number of records with date after end study date
included_records_filtering_gdm_pe<-list()
#included_records_filtering_gdm_pe_cat<-list()
included_records_filtering_mig<-list()
#included_records_filtering_mig_cat<-list()
w<-1
print(paste0("Analyzing table ",actual_tables$SURVEY_OBSERVATIONS[y], "."))
#Load the table
df<-fread(paste(path_dir, actual_tables$SURVEY_OBSERVATIONS[y], sep=""), stringsAsFactors = FALSE, colClasses = "character")
df<-df[, lapply(.SD, FUN=function(x) gsub("^$|^ $", NA, x))]
df[,so_origin:=NULL][,survey_id:=NULL]
sum(codesheet_diagnoses_gdm[table=="SURVEY_OBSERVATIONS",.N],
codesheet_diagnoses_pe[table=="SURVEY_OBSERVATIONS",.N],
codesheet_diagnoses_migraine[table=="SURVEY_OBSERVATIONS",.N],
!is.null(diag_checkbox_gdm_so),!is.null(diag_checkbox_pe_so))>0
setnames(df, date_var,"event_date")
setnames(df, code_var,"event_code")
setnames(df, voc_var,"event_vocabulary")
setnames(df,"so_meaning","meaning")
original_rows_gdm_pe[[w]]<-df[,.N]
original_rows_mig[[w]]<-df[,.N]
#remove empty dates
empty_event_date_gdm_pe[[w]]<-df[is.na(event_date),.N]
empty_event_date_mig[[w]]<-df[is.na(event_date),.N]
df[is.na(event_date),remove:=1]
#remove empty codes
empty_event_code_gdm_pe[[w]]<-df[is.na(event_code) & is.na(remove),.N]
empty_event_code_mig[[w]]<-df[is.na(event_code)& is.na(remove),.N]
df[is.na(event_code) & is.na(remove),remove:=1]
#remove empty voacbularies
empty_event_vocabulary_gdm_pe[[w]]<-df[is.na(event_vocabulary) & is.na(remove),.N]
empty_event_vocabulary_mig[[w]]<-df[is.na(event_vocabulary) & is.na(remove),.N]
df[is.na(event_vocabulary) & is.na(remove), remove:=1]
#empty meaning
empty_event_meaning_gdm_pe[[w]]<-df[is.na(meaning) & is.na(remove),.N]
empty_event_meaning_mig[[w]]<-df[is.na(meaning) & is.na(remove),.N]
df[is.na(meaning) & is.na(remove), remove:=1]
#transform into date variables
df[,event_date:=as.IDate(event_date,"%Y%m%d")] #transform to date variables
#create year variable
df[,year:=year(event_date)]
#merge with the obs_hint table and remove subjects not present in the pregnancy d3 for any of teh studies
df<-merge.data.table(df, obs_hint_table, by="person_id", all.x = T)
any_study_no[[w]]<-df[is.na(obs_min), .N]
df<-df[!is.na(obs_min)]
df[event_date>=obs_min & event_date<=obs_max, keep:=1]
outside_obs[[w]]<-df[is.na(keep),.N]
df<-df[keep==1]
df[,obs_min:=NULL][,obs_max:=NULL][,keep:=NULL]
df[is.na(remove),prior_gdm_pe:=ifelse(gdm_pe_start_study_date>event_date,1,0)]
prior_diagnoses_rec_gdm_pe[[w]]<-df[prior_gdm_pe==1 & is.na(remove),.N]
#migraine
df[is.na(remove),prior_mig:=ifelse(mig_start_study_date>event_date,1,0)]
prior_diagnoses_rec_mig[[w]]<-df[prior_mig==1 & is.na(remove),.N]
#Check if the data needed for the drug utilization and safety study has a longer follow up
df[is.na(remove),prior_du:=ifelse(du_start_study_date>event_date,1,0)]
df[is.na(remove),prior_saf:=ifelse(saf_start_study_date>event_date,1,0)]
#clean up dataset:keep records when at least one is zero
#df<-df[is.na(remove)][prior_gdm_pe==0|prior_mig==0|prior_du==0|prior_saf==0]
#remove all records with dates after end study date
#gdm
df[is.na(remove),after_gdm_pe:=ifelse(gdm_pe_end_study_date<event_date,1,0)]
after_diagnoses_rec_gdm_pe[[w]]<-df[after_gdm_pe==1 & prior_gdm_pe==0 & is.na(remove),.N]
#migraine
df[is.na(remove),after_mig:=ifelse(mig_end_study_date<event_date,1,0)]
after_diagnoses_rec_mig[[w]]<-df[after_mig==1 & prior_mig==0 & is.na(remove),.N]
#Check if the data needed for the drug utilization and safety study has a longer follow up
df[is.na(remove),after_du:=ifelse(du_end_study_date<event_date,1,0)]
df[is.na(remove),after_saf:=ifelse(saf_end_study_date<event_date,1,0)]
#clean up dataset:keep records when at least one is zero
#df<-df[after_gdm_pe==0|after_mig==0|after_du==0|after_saf==0]
#create code with nodot
df[,code_no_dot:=as.character(gsub("\\.","",df[,event_code]))]
included_records_filtering_gdm_pe[[w]]<-df[prior_gdm_pe==0 & after_gdm_pe==0 & is.na(remove),.N]
included_records_filtering_mig[[w]]<-df[prior_mig==0 & after_mig==0 & is.na(remove),.N]
if(df[is.na(remove),.N]>0){
if(df[prior_gdm_pe==0 & after_gdm_pe==0 & is.na(remove),.N]>0){
#data filtering based on codelists
if(events_gdm_diagnoses>0){
print(paste0("Filtering data for GDM diagnoses:", actual_tables$SURVEY_OBSERVATIONS[y]))
years_study_events<-sort(df[prior_gdm_pe==0 & after_gdm_pe==0 & is.na(remove)][!duplicated(year), year])#years present in this table
if(sum(df[prior_gdm_pe==0 & after_gdm_pe==0 & is.na(remove)][!duplicated(event_vocabulary), event_vocabulary] %in% vocabularies_list_gdm)>0){
for (i in 1:length(conditions_gdm)){
for(j in 1:length(conditions_gdm[[i]])){
codes<-data.table(event_vocabulary=names(conditions_gdm[[i]])[j], truncated_code=conditions_gdm[[i]][[j]], filter=1)
for(codes_ind in 1:codes[,.N]){
length<-nchar(codes[codes_ind,truncated_code])
#create truncated code
df[,truncated_code:=substr(code_no_dot,1,length)]
df<-merge.data.table(df,codes[codes_ind,],by=c("event_vocabulary","truncated_code"),all.x = T,allow.cartesian = T)
if(df[prior_gdm_pe==0 & after_gdm_pe==0 & filter==1 & is.na(remove),.N]>0){
years_this_event<-sort(df[prior_gdm_pe==0 & after_gdm_pe==0 & filter==1 & is.na(remove)][!duplicated(year),year])
for(year_ind in 1:length(years_this_event)){
saveRDS(data.table(df[,cols, with=F][prior_gdm_pe==0 & after_gdm_pe==0 & is.na(remove) & filter==1 & year==years_this_event[year_ind]], condition=names(conditions_gdm[i])), paste0(tmp,years_this_event[year_ind],"_","GDM_", names(conditions_gdm[i]), "_",actual_tables$SURVEY_OBSERVATIONS[y],"_", codes_ind, ".rds"))
}
} else {
years_this_event<-NULL}# new 01.06.2022
rm(years_this_event)
rm(length)
if("filter" %in% names(df)){df[,filter:=NULL]}
if("truncated_code" %in% names(df)){df[,truncated_code:=NULL]}
}
rm(codes)
}
}
}
}
if(so_pe_diagnoses>0){
print(paste0("Filtering data for PE diagnoses:", actual_tables$SURVEY_OBSERVATIONS[y]))
years_study_events<-sort(df[prior_gdm_pe==0 & after_gdm_pe==0 & is.na(remove)][!duplicated(year), year])#years present in this table
if(sum(df[prior_gdm_pe==0 & after_gdm_pe==0 & is.na(remove)][!duplicated(event_vocabulary), event_vocabulary] %in% vocabularies_list_pe)>0){
for (i in 1:length(conditions_pe)){
for(j in 1:length(conditions_pe[[i]])){
codes<-data.table(event_vocabulary=names(conditions_pe[[i]])[j], truncated_code=conditions_pe[[i]][[j]], filter=1)
for(codes_ind in 1:codes[,.N]){
length<-nchar(codes[codes_ind,truncated_code])
#create truncated code
df[,truncated_code:=substr(code_no_dot,1,length)]
df<-merge.data.table(df,codes[codes_ind,],by=c("event_vocabulary","truncated_code"),all.x = T,allow.cartesian = T)
if(df[prior_gdm_pe==0 & after_gdm_pe==0 & filter==1 & is.na(remove),.N]>0){
years_this_event<-sort(df[prior_gdm_pe==0 & after_gdm_pe==0 & filter==1 & is.na(remove)][!duplicated(year),year])
for(year_ind in 1:length(years_this_event)){
saveRDS(data.table(df[,cols, with=F][prior_gdm_pe==0 & after_gdm_pe==0 & is.na(remove) & filter==1 & year==years_this_event[year_ind]], condition=names(conditions_pe[i])), paste0(tmp,years_this_event[year_ind],"_","PE_", names(conditions_pe[i]), "_",actual_tables$SURVEY_OBSERVATIONS[y],"_", codes_ind, ".rds"))
}
} else {
years_this_event<-NULL}# new 01.06.2022
rm(years_this_event)
rm(length)
if("filter" %in% names(df)){df[,filter:=NULL]}
if("truncated_code" %in% names(df)){df[,truncated_code:=NULL]}
}
rm(codes)
}
}
}
}
}
if(df[prior_mig==0 & after_mig==0 & is.na(remove),.N]>0){
if(so_migraine_diagnoses>0){
print(paste0("Filtering data for Migraine diagnoses:", actual_tables$SURVEY_OBSERVATIONS[y]))
years_study_events<-sort(df[prior_mig==0 & after_mig==0 & is.na(remove)][!duplicated(year), year])#years present in this table
#startWith for the event Migraine
if(sum(df[prior_mig==0 & after_mig==0 & is.na(remove)][!duplicated(event_vocabulary), event_vocabulary] %in% vocabularies_list_migraine_mg)>0){
for (i in 1:length(conditions_migraine[names(conditions_migraine)=="MG"])){
for(j in 1:length(conditions_migraine[names(conditions_migraine)=="MG"][[i]])){
codes<-data.table(event_vocabulary=names(conditions_migraine[names(conditions_migraine)=="MG"][[i]])[j], truncated_code=conditions_migraine[names(conditions_migraine)=="MG"][[i]][[j]], filter=1)
for(codes_ind in 1:codes[,.N]){
length<-nchar(codes[codes_ind,truncated_code])
#create truncated code
df[,truncated_code:=substr(code_no_dot,1,length)]
df<-merge.data.table(df,codes[codes_ind,],by=c("event_vocabulary","truncated_code"),all.x = T,allow.cartesian = T)
if(df[prior_mig==0 & after_mig==0 & filter==1 & is.na(remove),.N]>0){
years_this_event<-sort(df[prior_mig==0 & after_mig==0 & filter==1 & is.na(remove)][!duplicated(year),year])
for(year_ind in 1:length(years_this_event)){
saveRDS(data.table(df[,cols, with=F][prior_mig==0 & after_mig==0 & filter==1 & is.na(remove) & year==years_this_event[year_ind]], condition=names(conditions_migraine[names(conditions_migraine)=="MG"][i])), paste0(tmp,years_this_event[year_ind],"_","Migraine_", names(conditions_migraine[names(conditions_migraine)=="MG"][i]), "_",actual_tables$SURVEY_OBSERVATIONS[y],"_", codes_ind, ".rds"))
}
} else {
years_this_event<-NULL}# new 01.06.2022
rm(years_this_event)
rm(length)
if("filter" %in% names(df)){df[,filter:=NULL]}
if("truncated_code" %in% names(df)){df[,truncated_code:=NULL]}
}
rm(codes)
}
}
}
#exact match for the other events related to migraine
if(sum(df[prior_mig==0 & after_mig==0 & is.na(remove)][!duplicated(event_vocabulary), event_vocabulary] %in% vocabularies_list_migraine)>0){
for (i in 1:length(conditions_migraine[names(conditions_migraine)!="MG"])){
for(j in 1:length(conditions_migraine[names(conditions_migraine)!="MG"][[i]])){
codes<-data.table(event_vocabulary=names(conditions_migraine[names(conditions_migraine)!="MG"][[i]])[j], code_no_dot=conditions_migraine[names(conditions_migraine)!="MG"][[i]][[j]], filter=1)
for(codes_ind in 1:codes[,.N]){
#create truncated code
df<-merge.data.table(df,codes[codes_ind,],by=c("event_vocabulary","code_no_dot"),all.x = T,allow.cartesian = T)
if(df[prior_mig==0 & after_mig==0 & filter==1 & is.na(remove),.N]>0){
years_this_event<-sort(df[prior_mig==0 & after_mig==0 & filter==1 & is.na(remove)][!duplicated(year),year])
for(year_ind in 1:length(years_this_event)){
saveRDS(data.table(df[,cols, with=F][prior_mig==0 & after_mig==0 & filter==1 & is.na(remove) & year==years_this_event[year_ind]], condition=names(conditions_migraine[names(conditions_migraine)!="MG"][i])), paste0(tmp,years_this_event[year_ind],"_","Migraine_", names(conditions_migraine[names(conditions_migraine)!="MG"][i]), "_",actual_tables$SURVEY_OBSERVATIONS[y],"_", codes_ind, ".rds"))
}
} else {
years_this_event<-NULL}# new 01.06.2022
rm(years_this_event)
if("filter" %in% names(df)){df[,filter:=NULL]}
}
rm(codes)
}
}
}
}
}
}
####Clean pregnancies####
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source(paste0(projectFolder,"/p_steps/clean_folders.R"))
source("99_path.R")
setwd(projectFolder)
#Run pregnancy algorithm and save results in g_intermediate/pregnancy_algorithm
source(paste0(pre_dir,"Step_00_create_clean_pregnancy_D3.R"))
render(paste0(pre_dir,"Report_0_pregnancy_algorithm_flowchart.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_0_Pregnancy_algorithm_flowchart.html"))
source(paste0(pre_dir,"save_environment.R"))
####Create pregnancy study population####
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source("99_path.R")
setwd(projectFolder)
#Create study population(persons/observation_periods/pregnancies)
load(paste0(g_intermediate,"environment.RData"))
source(paste0(pre_dir,"Step_01_create_study_population.R"))
render(paste0(pre_dir,"Report_1_pregnancy_study_population.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_1_Pregnancy_study_population.html"))
source(paste0(pre_dir,"save_environment.R"))
####Run diagnostic filtering script####
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source("99_path.R")
setwd(projectFolder)
#Create diagnoses D3(GDM/PE/Migraine)
load(paste0(g_intermediate,"environment.RData"))
source(paste0(pre_dir,"Step_02_diagnoses_clean_up.R"))
source(paste0(pre_dir,"Step_02_diagnoses_clean_up_combine.R"))
render(paste0(pre_dir,"Report_2_diagnoses_clean_up.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_2_Diagnoses_clean_up.html"))
source(paste0(pre_dir,"save_environment.R"))
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source("99_path.R")
setwd(projectFolder)
#Create medicines D3(GDM/PE/Migraine)
load(paste0(g_intermediate,"environment.RData"))
source(paste0(pre_dir,"Step_03_medicines_clean_up.R"))
source(paste0(pre_dir,"Step_03_medicines_clean_up_combine.R"))
render(paste0(pre_dir,"Report_3_medicines_clean_up.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_3_Medicines_clean_up.html"))
source(paste0(pre_dir,"save_environment.R"))
####Create algorithms for GDM/PE/Migraine####
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source("99_path.R")
setwd(projectFolder)
load(paste0(g_intermediate,"environment.RData"))
source(paste0(pre_dir,"Step_04_algorithms.R"))
render(paste0(pre_dir,"Report_4_gdm_pe_algorithms.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_4_gdm_pe_algorithms.html"))
#render(paste0(pre_dir,"Report_4_migraine_algorithms.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_4_migraine_algorithms.html"))
source(paste0(pre_dir,"save_environment.R"))
if("Step_04_GDM_1_year_age.csv" %in% list.files(paste0(projectFolder,"/g_output/PE and GDM algorithm/"))){
alg_1<-fread(paste0(projectFolder,"/g_output/PE and GDM algorithm/Step_04_GDM_1_year_age.csv"))
}else{alg_1<-NULL}
if("Step_04_GDM_2_year_age.csv" %in% list.files(paste0(projectFolder,"/g_output/PE and GDM algorithm/"))){
alg_2<-fread(paste0(projectFolder,"/g_output/PE and GDM algorithm/Step_04_GDM_2_year_age.csv"))
}else{alg_2<-NULL}
if("Step_04_GDM_3_year_age.csv" %in% list.files(paste0(projectFolder,"/g_output/PE and GDM algorithm/"))){
alg_3<-fread(paste0(projectFolder,"/g_output/PE and GDM algorithm/Step_04_GDM_3_year_age.csv"))
}else{alg_3<-NULL}
if("Step_04_GDM_4_year_age.csv" %in% list.files(paste0(projectFolder,"/g_output/PE and GDM algorithm/"))){
alg_4<-fread(paste0(projectFolder,"/g_output/PE and GDM algorithm/Step_04_GDM_4_year_age.csv"))
}else{alg_4<-NULL}
if("Step_04_GDM_5_year_age.csv" %in% list.files(paste0(projectFolder,"/g_output/PE and GDM algorithm/"))){
alg_5<-fread(paste0(projectFolder,"/g_output/PE and GDM algorithm/Step_04_GDM_5_year_age.csv"))
}else{alg_5<-NULL}
if("Step_04_GDM_8_year_age.csv" %in% list.files(paste0(projectFolder,"/g_output/PE and GDM algorithm/"))){
alg_8<-fread(paste0(projectFolder,"/g_output/PE and GDM algorithm/Step_04_GDM_8_year_age.csv"))
}else{alg_8<-NULL}
alg<-rbind(alg_1,alg_2,alg_3,alg_4,alg_5,alg_8)
if(!is.null(alg)){
datatable(alg, options = list(scrollX=T))
}else{
print("This table is missing in the folder g_output/PE and GDM algorithm.")
}
years<-unique(alg[,year_group])
alg[,prevalence_100_pregnancies:=as.numeric(prevalence_100_pregnancies)]
years<-unique(alg[,year_group])
fig.1<-list()
for(i in 1:length(years)){
fig.1[[i]]<-ggplotly(ggplot(alg[year_group==years[i]], aes(x=maternal_age,y=prevalence_100_pregnancies, group=algorithm)) +
geom_line(aes(color=algorithm))+
geom_line(aes(x=maternal_age,y=lower_95_CI, color=algorithm))+
geom_point(aes(color=algorithm))+
#facet_wrap(~year_group, scales="fixed", ncol=1)+
theme(axis.text.x = element_text(size = 8,angle = 45),
axis.title.x = element_text(colour = "#76b82a"),
axis.title.y = element_text(colour = "#76b82a"),
plot.title = element_text(colour = "#76b82a"))+
ggtitle("GDM prevalence rates")+
xlab("Maternal age") +
ylab("Prevalence_per_100_pregnancies")+
theme(panel.background=element_rect(color="lightgreen", linewidth = 1)))
}
alg[,prevalence_100_pregnancies:=as.numeric(prevalence_100_pregnancies)]
years<-unique(alg[,year_group])
fig.1<-list()
for(i in 1:length(years)){
fig.1[[i]]<-ggplotly(ggplot(alg[year_group==years[i]], aes(x=maternal_age,y=prevalence_100_pregnancies, group=algorithm)) +
geom_line(aes(color=algorithm))+
geom_line(aes(x=maternal_age,y=lower_95_CI, color=algorithm))+
geom_point(aes(color=algorithm))+
#facet_wrap(~year_group, scales="fixed", ncol=1)+
theme(axis.text.x = element_text(size = 8,angle = 45),
axis.title.x = element_text(colour = "#76b82a"),
axis.title.y = element_text(colour = "#76b82a"),
plot.title = element_text(colour = "#76b82a"))+
ggtitle("GDM prevalence rates")+
xlab("Maternal age") +
ylab("Prevalence_per_100_pregnancies")+
theme(panel.background=element_rect(color="lightgreen", linewidth = 1)))
}
htmltools(tgList(list(fig.1)))
htmltools::tagList(list(fig.1)))
htmltools::tagList(list(fig.1))
alg[,prevalence_100_pregnancies:=as.numeric(prevalence_100_pregnancies)]
years<-unique(alg[,year_group])
fig.1<-list()
for(i in 1:length(years)){
fig.1[[i]]<-ggplotly(ggplot(alg[year_group==years[i]], aes(x=maternal_age,y=prevalence_100_pregnancies, group=algorithm)) +
geom_line(aes(color=algorithm))+
geom_line(aes(x=maternal_age,y=lower_95_CI, color=algorithm))+
geom_point(aes(color=algorithm))+
#facet_wrap(~year_group, scales="fixed", ncol=1)+
theme(axis.text.x = element_text(size = 8,angle = 45),
axis.title.x = element_text(colour = "#76b82a"),
axis.title.y = element_text(colour = "#76b82a"),
plot.title = element_text(colour = "#76b82a"))+
ggtitle(paste0("GDM prevalence rates: ", years[i]))+
xlab("Maternal age") +
ylab("Prevalence_per_100_pregnancies")+
theme(panel.background=element_rect(color="lightgreen", linewidth = 1)))
}
htmltools::tagList(list(fig.1))
render(paste0(pre_dir,"Report_4_gdm_pe_algorithms.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_4_gdm_pe_algorithms.html"))
