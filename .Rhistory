MIG_Rx_second_dt[lower_95_CI<0,lower_95_CI:=0]
fwrite(MIG_Rx_second_dt,paste0(projectFolder,"/g_output/Migraine algorithm/Step_04_MIG_Rx_second.csv"),row.names = F)
#by maternal age
pregnancy_d3_mig[,maternal_age:=as.character(maternal_age)]
records<-pregnancy_d3_mig[include==1 & !duplicated(pregnancy_id), .N, by=.(maternal_age)]
names(records)<-c("maternal_age","no_diagnosed_pregnancies")
total<-pregnancy_d3_mig[!duplicated(pregnancy_id) & trimester%in% c(2,3), by="maternal_age",.N]
names(total)<-c("maternal_age","no_pregnancies")
records<-merge.data.table(records,total,by="maternal_age",all=T)
MIG_Rx_second_1<-data.table(algorithm="MIG_Rx_second", records)
MIG_Rx_second_1[is.na(no_diagnosed_pregnancies),no_diagnosed_pregnancies:=0]
MIG_Rx_second_1<-MIG_Rx_second_1[order(maternal_age)]
rm(records,total)
MIG_Rx_second_1[,prevalence_100_pregnancies:=round((no_diagnosed_pregnancies/no_pregnancies)*100,1)]
MIG_Rx_second_1[,no_diagnosed_pregnancies:=as.numeric(no_diagnosed_pregnancies)][,no_pregnancies:=as.numeric(no_pregnancies)]
MIG_Rx_second_1[no_diagnosed_pregnancies != 0 & prevalence_100_pregnancies==0, prevalence_100_pregnancies:=0.0001]
#lower CI
MIG_Rx_second_1[,lower_95_CI:=lower_ci(no_diagnosed_pregnancies,no_pregnancies,prevalence_100_pregnancies)]
MIG_Rx_second_1[,upper_95_CI:=upper_ci(no_diagnosed_pregnancies,no_pregnancies,prevalence_100_pregnancies)]
MIG_Rx_second_1[lower_95_CI<0,lower_95_CI:=0]
fwrite(MIG_Rx_second_1,paste0(projectFolder,"/g_output/Migraine algorithm/Step_04_MIG_Rx_second_age.csv"),row.names = F)
rm(MIG_Rx_second_1)
#by year
records<-pregnancy_d3_mig[include==1 & !duplicated(pregnancy_id),by="year", .N]
names(records)<-c("year","no_diagnosed_pregnancies")
total<-pregnancy_d3_mig[!duplicated(pregnancy_id) & trimester%in% c(2,3),by="year",.N]
names(total)<-c("year","no_pregnancies")
records<-merge.data.table(records,total,by="year",all=T)
MIG_Rx_second_2<-data.table(algorithm="MIG_Rx_second", records)
MIG_Rx_second_2[is.na(no_diagnosed_pregnancies),no_diagnosed_pregnancies:=0]
MIG_Rx_second_2<-MIG_Rx_second_2[order(year)]
rm(records,total)
MIG_Rx_second_2[,prevalence_100_pregnancies:=round((no_diagnosed_pregnancies/no_pregnancies)*100,1)]
MIG_Rx_second_2[,no_diagnosed_pregnancies:=as.numeric(no_diagnosed_pregnancies)][,no_pregnancies:=as.numeric(no_pregnancies)]
MIG_Rx_second_2[no_diagnosed_pregnancies != 0 & prevalence_100_pregnancies==0, prevalence_100_pregnancies:=0.0001]
#lower CI
MIG_Rx_second_2[,lower_95_CI:=lower_ci(no_diagnosed_pregnancies,no_pregnancies,prevalence_100_pregnancies)]
MIG_Rx_second_2[,upper_95_CI:=upper_ci(no_diagnosed_pregnancies,no_pregnancies,prevalence_100_pregnancies)]
MIG_Rx_second_2[lower_95_CI<0,lower_95_CI:=0]
fwrite(MIG_Rx_second_2,paste0(projectFolder,"/g_output/Migraine algorithm/Step_04_MIG_Rx_second_year.csv"),row.names = F)
rm(MIG_Rx_second_2)
#by year group and maternal age
records<-pregnancy_d3_mig[include==1 & !duplicated(pregnancy_id),by=c("year_group","maternal_age"), .N]
names(records)<-c("year_group","maternal_age", "no_diagnosed_pregnancies")
total<-pregnancy_d3_mig[!duplicated(pregnancy_id) & trimester%in% c(2,3),by=c("year_group","maternal_age"),.N]
names(total)<-c("year_group","maternal_age","no_pregnancies")
records<-merge.data.table(records,total,by=c("year_group","maternal_age"), all=T)
MIG_Rx_second_3<-data.table(algorithm="MIG_Rx_second", records)
MIG_Rx_second_3[is.na(no_diagnosed_pregnancies),no_diagnosed_pregnancies:=0]
MIG_Rx_second_3<-MIG_Rx_second_3[order(year_group,maternal_age)]
rm(records,total)
MIG_Rx_second_3[,prevalence_100_pregnancies:=round((no_diagnosed_pregnancies/no_pregnancies)*100,1)]
MIG_Rx_second_3[,no_diagnosed_pregnancies:=as.numeric(no_diagnosed_pregnancies)][,no_pregnancies:=as.numeric(no_pregnancies)]
MIG_Rx_second_3[no_diagnosed_pregnancies != 0 & prevalence_100_pregnancies==0, prevalence_100_pregnancies:=0.0001]
#lower CI
MIG_Rx_second_3[,lower_95_CI:=lower_ci(no_diagnosed_pregnancies,no_pregnancies,prevalence_100_pregnancies)]
MIG_Rx_second_3[,upper_95_CI:=upper_ci(no_diagnosed_pregnancies,no_pregnancies,prevalence_100_pregnancies)]
MIG_Rx_second_3[lower_95_CI<0,lower_95_CI:=0]
pregnancy_d3_mig[,include:=NULL]
fwrite(MIG_Rx_second_3,paste0(projectFolder,"/g_output/Migraine algorithm/Step_04_MIG_Rx_second_year_age.csv"),row.names = F)
rm(MIG_Rx_second_3)
#### MIG_DxRx_second:Prevalence of migraine at baseline when lookback==12 months(3 months) ####
print("Create algorithm MIG_DxRx_second")
MIG_DxRx_second<-algorithm_template[NEW_STUDY_VARIABLES=="MIG_DxRx_second"]
alt_col<-MIG_DxRx_second[TYPE=="OR",STUDY_VARIABLES]
if(length(alt_col)>0){pregnancy_d3_mig[pregnancy_d3_mig[,Reduce("|" , lapply(.SD,`>=`, 1)),.SDcols=alt_col] & trimester%in% c(2,3),alternative:=1]}else{pregnancy_d3_mig[,alternative:=NA]}
saveRDS(pregnancy_d3_mig,paste0(projectFolder,"/g_intermediate/migraine_algorithm/final_d3/MIG_DxRx_second_D3.rds"))
#export MIG_Dx_a
MIG_DxRx_second_dt<-data.table(algorithm="MIG_DxRx_second", no_diagnosed_pregnancies=pregnancy_d3_mig[alternative==1 & !duplicated(pregnancy_id),.N], no_pregnancies=pregnancy_d3_mig[!duplicated(pregnancy_id) & trimester%in% c(2,3),.N])
MIG_DxRx_second_dt[,prevalence_100_pregnancies:=round((no_diagnosed_pregnancies/no_pregnancies)*100,1)]
MIG_DxRx_second_dt[,no_diagnosed_pregnancies:=as.numeric(no_diagnosed_pregnancies)][,no_pregnancies:=as.numeric(no_pregnancies)]
#lower CI
MIG_DxRx_second_dt[,lower_95_CI:=lower_ci(no_diagnosed_pregnancies,no_pregnancies,prevalence_100_pregnancies)]
MIG_DxRx_second_dt[,upper_95_CI:=upper_ci(no_diagnosed_pregnancies,no_pregnancies,prevalence_100_pregnancies)]
MIG_DxRx_second_dt[lower_95_CI<0,lower_95_CI:=0]
fwrite(MIG_DxRx_second_dt,paste0(projectFolder,"/g_output/Migraine algorithm/Step_04_MIG_DxRx_second.csv"),row.names = F)
#by maternal age
pregnancy_d3_mig[,maternal_age:=as.character(maternal_age)]
records<-pregnancy_d3_mig[alternative==1 & !duplicated(pregnancy_id), .N, by=.(maternal_age)]
names(records)<-c("maternal_age","no_diagnosed_pregnancies")
total<-pregnancy_d3_mig[!duplicated(pregnancy_id)& trimester%in% c(2,3), by="maternal_age",.N]
names(total)<-c("maternal_age","no_pregnancies")
records<-merge.data.table(records,total,by="maternal_age",all=T)
MIG_DxRx_second_1<-data.table(algorithm="MIG_DxRx_second", records)
MIG_DxRx_second_1[is.na(no_diagnosed_pregnancies),no_diagnosed_pregnancies:=0]
MIG_DxRx_second_1<-MIG_DxRx_second_1[order(maternal_age)]
rm(records,total)
MIG_DxRx_second_1[,prevalence_100_pregnancies:=round((no_diagnosed_pregnancies/no_pregnancies)*100,1)]
MIG_DxRx_second_1[,no_diagnosed_pregnancies:=as.numeric(no_diagnosed_pregnancies)][,no_pregnancies:=as.numeric(no_pregnancies)]
MIG_DxRx_second_1[no_diagnosed_pregnancies != 0 & prevalence_100_pregnancies==0, prevalence_100_pregnancies:=0.0001]
#lower CI
MIG_DxRx_second_1[,lower_95_CI:=lower_ci(no_diagnosed_pregnancies,no_pregnancies,prevalence_100_pregnancies)]
MIG_DxRx_second_1[,upper_95_CI:=upper_ci(no_diagnosed_pregnancies,no_pregnancies,prevalence_100_pregnancies)]
MIG_DxRx_second_1[lower_95_CI<0,lower_95_CI:=0]
fwrite(MIG_DxRx_second_1,paste0(projectFolder,"/g_output/Migraine algorithm/Step_04_MIG_DxRx_second_age.csv"),row.names = F)
rm(MIG_DxRx_second_1)
#by year
records<-pregnancy_d3_mig[alternative==1 & !duplicated(pregnancy_id),by="year", .N]
names(records)<-c("year","no_diagnosed_pregnancies")
total<-pregnancy_d3_mig[!duplicated(pregnancy_id)& trimester%in% c(2,3),by="year",.N]
names(total)<-c("year","no_pregnancies")
records<-merge.data.table(records,total,by="year",all=T)
MIG_DxRx_second_2<-data.table(algorithm="MIG_DxRx_second", records)
MIG_DxRx_second_2[is.na(no_diagnosed_pregnancies),no_diagnosed_pregnancies:=0]
MIG_DxRx_second_2<-MIG_DxRx_second_2[order(year)]
rm(records,total)
MIG_DxRx_second_2[,prevalence_100_pregnancies:=round((no_diagnosed_pregnancies/no_pregnancies)*100,1)]
MIG_DxRx_second_2[,no_diagnosed_pregnancies:=as.numeric(no_diagnosed_pregnancies)][,no_pregnancies:=as.numeric(no_pregnancies)]
MIG_DxRx_second_2[no_diagnosed_pregnancies != 0 & prevalence_100_pregnancies==0, prevalence_100_pregnancies:=0.0001]
#lower CI
MIG_DxRx_second_2[,lower_95_CI:=lower_ci(no_diagnosed_pregnancies,no_pregnancies,prevalence_100_pregnancies)]
MIG_DxRx_second_2[,upper_95_CI:=upper_ci(no_diagnosed_pregnancies,no_pregnancies,prevalence_100_pregnancies)]
MIG_DxRx_second_2[lower_95_CI<0,lower_95_CI:=0]
fwrite(MIG_DxRx_second_2,paste0(projectFolder,"/g_output/Migraine algorithm/Step_04_MIG_DxRx_second_year.csv"),row.names = F)
rm(MIG_DxRx_second_2)
#by year group and maternal age
records<-pregnancy_d3_mig[alternative==1 & !duplicated(pregnancy_id),by=c("year_group","maternal_age"), .N]
names(records)<-c("year_group","maternal_age", "no_diagnosed_pregnancies")
total<-pregnancy_d3_mig[!duplicated(pregnancy_id)& trimester%in% c(2,3),by=c("year_group","maternal_age"),.N]
names(total)<-c("year_group","maternal_age","no_pregnancies")
records<-merge.data.table(records,total,by=c("year_group","maternal_age"), all=T)
MIG_DxRx_second_3<-data.table(algorithm="MIG_DxRx_second", records)
MIG_DxRx_second_3[is.na(no_diagnosed_pregnancies),no_diagnosed_pregnancies:=0]
MIG_DxRx_second_3<-MIG_DxRx_second_3[order(year_group,maternal_age)]
rm(records,total)
MIG_DxRx_second_3[,prevalence_100_pregnancies:=round((no_diagnosed_pregnancies/no_pregnancies)*100,1)]
MIG_DxRx_second_3[,no_diagnosed_pregnancies:=as.numeric(no_diagnosed_pregnancies)][,no_pregnancies:=as.numeric(no_pregnancies)]
MIG_DxRx_second_3[no_diagnosed_pregnancies != 0 & prevalence_100_pregnancies==0, prevalence_100_pregnancies:=0.0001]
#lower CI
MIG_DxRx_second_3[,lower_95_CI:=lower_ci(no_diagnosed_pregnancies,no_pregnancies,prevalence_100_pregnancies)]
MIG_DxRx_second_3[,upper_95_CI:=upper_ci(no_diagnosed_pregnancies,no_pregnancies,prevalence_100_pregnancies)]
MIG_DxRx_second_3[lower_95_CI<0,lower_95_CI:=0]
pregnancy_d3_mig[,alternative:=NULL]
fwrite(MIG_DxRx_second_3,paste0(projectFolder,"/g_output/Migraine algorithm/Step_04_MIG_DxRx_second_year_age.csv"),row.names = F)
rm(MIG_DxRx_second_3)
#### MIG_Dx_third:Prevalence of migraine during pregnancy when lookback==12 months(3 months) ####
print("Create algorithm MIG_Dx_third")
MIG_Dx_third<-algorithm_template[NEW_STUDY_VARIABLES=="MIG_Dx_third"]
inc_col<-MIG_Dx_third[TYPE=="AND",STUDY_VARIABLES]
#set the pregnancy trimester for each pregnancy
if(length(inc_col)>0){pregnancy_d3_mig[pregnancy_d3_mig[,Reduce("&" , lapply(.SD,`>=`, 1)),.SDcols=inc_col] & trimester == 3,include:=1]}else{pregnancy_d3_mig[,include:=NA]}
saveRDS(pregnancy_d3_mig,paste0(projectFolder,"/g_intermediate/migraine_algorithm/final_d3/MIG_Dx_third_D3.rds"))
#export MIG_Dx_third
MIG_Dx_third_dt<-data.table(algorithm="MIG_Dx_third", no_diagnosed_pregnancies=pregnancy_d3_mig[include==1 & !duplicated(pregnancy_id),.N], no_pregnancies=pregnancy_d3_mig[!duplicated(pregnancy_id) & trimester == 3,.N])
MIG_Dx_third_dt[,prevalence_100_pregnancies:=round((no_diagnosed_pregnancies/no_pregnancies)*100,1)]
MIG_Dx_third_dt[,no_diagnosed_pregnancies:=as.numeric(no_diagnosed_pregnancies)][,no_pregnancies:=as.numeric(no_pregnancies)]
#lower CI
MIG_Dx_third_dt[,lower_95_CI:=lower_ci(no_diagnosed_pregnancies,no_pregnancies,prevalence_100_pregnancies)]
MIG_Dx_third_dt[,upper_95_CI:=upper_ci(no_diagnosed_pregnancies,no_pregnancies,prevalence_100_pregnancies)]
MIG_Dx_third_dt[lower_95_CI<0,lower_95_CI:=0]
fwrite(MIG_Dx_third_dt,paste0(projectFolder,"/g_output/Migraine algorithm/Step_04_MIG_Dx_third.csv"),row.names = F)
#by maternal age
pregnancy_d3_mig[,maternal_age:=as.character(maternal_age)]
records<-pregnancy_d3_mig[include==1 & !duplicated(pregnancy_id), .N, by=.(maternal_age)]
names(records)<-c("maternal_age","no_diagnosed_pregnancies")
total<-pregnancy_d3_mig[!duplicated(pregnancy_id) & trimester == 3, by="maternal_age",.N]
names(total)<-c("maternal_age","no_pregnancies")
records<-merge.data.table(records,total,by="maternal_age",all=T)
MIG_Dx_third_1<-data.table(algorithm="MIG_Dx_third", records)
MIG_Dx_third_1[is.na(no_diagnosed_pregnancies),no_diagnosed_pregnancies:=0]
MIG_Dx_third_1<-MIG_Dx_third_1[order(maternal_age)]
rm(records,total)
MIG_Dx_third_1[,prevalence_100_pregnancies:=round((no_diagnosed_pregnancies/no_pregnancies)*100,1)]
MIG_Dx_third_1[,no_diagnosed_pregnancies:=as.numeric(no_diagnosed_pregnancies)][,no_pregnancies:=as.numeric(no_pregnancies)]
MIG_Dx_third_1[no_diagnosed_pregnancies != 0 & prevalence_100_pregnancies==0, prevalence_100_pregnancies:=0.0001]
#lower CI
MIG_Dx_third_1[,lower_95_CI:=lower_ci(no_diagnosed_pregnancies,no_pregnancies,prevalence_100_pregnancies)]
MIG_Dx_third_1[,upper_95_CI:=upper_ci(no_diagnosed_pregnancies,no_pregnancies,prevalence_100_pregnancies)]
MIG_Dx_third_1[lower_95_CI<0,lower_95_CI:=0]
fwrite(MIG_Dx_third_1,paste0(projectFolder,"/g_output/Migraine algorithm/Step_04_MIG_Dx_third_age.csv"),row.names = F)
rm(MIG_Dx_third_1)
#by year
records<-pregnancy_d3_mig[include==1 & !duplicated(pregnancy_id),by="year", .N]
names(records)<-c("year","no_diagnosed_pregnancies")
total<-pregnancy_d3_mig[!duplicated(pregnancy_id) & trimester == 3,by="year",.N]
names(total)<-c("year","no_pregnancies")
records<-merge.data.table(records,total,by="year",all=T)
MIG_Dx_third_2<-data.table(algorithm="MIG_Dx_third", records)
MIG_Dx_third_2[is.na(no_diagnosed_pregnancies),no_diagnosed_pregnancies:=0]
MIG_Dx_third_2<-MIG_Dx_third_2[order(year)]
rm(records,total)
MIG_Dx_third_2[,prevalence_100_pregnancies:=round((no_diagnosed_pregnancies/no_pregnancies)*100,1)]
MIG_Dx_third_2[,no_diagnosed_pregnancies:=as.numeric(no_diagnosed_pregnancies)][,no_pregnancies:=as.numeric(no_pregnancies)]
MIG_Dx_third_2[no_diagnosed_pregnancies != 0 & prevalence_100_pregnancies==0, prevalence_100_pregnancies:=0.0001]
#lower CI
MIG_Dx_third_2[,lower_95_CI:=lower_ci(no_diagnosed_pregnancies,no_pregnancies,prevalence_100_pregnancies)]
MIG_Dx_third_2[,upper_95_CI:=upper_ci(no_diagnosed_pregnancies,no_pregnancies,prevalence_100_pregnancies)]
MIG_Dx_third_2[lower_95_CI<0,lower_95_CI:=0]
fwrite(MIG_Dx_third_2,paste0(projectFolder,"/g_output/Migraine algorithm/Step_04_MIG_Dx_third_year.csv"),row.names = F)
rm(MIG_Dx_third_2)
#by year group and maternal age
records<-pregnancy_d3_mig[include==1 & !duplicated(pregnancy_id),by=c("year_group","maternal_age"), .N]
names(records)<-c("year_group","maternal_age", "no_diagnosed_pregnancies")
total<-pregnancy_d3_mig[!duplicated(pregnancy_id) & trimester == 3,by=c("year_group","maternal_age"),.N]
names(total)<-c("year_group","maternal_age","no_pregnancies")
records<-merge.data.table(records,total,by=c("year_group","maternal_age"), all=T)
MIG_Dx_third_3<-data.table(algorithm="MIG_Dx_third", records)
MIG_Dx_third_3[is.na(no_diagnosed_pregnancies),no_diagnosed_pregnancies:=0]
MIG_Dx_third_3<-MIG_Dx_third_3[order(year_group,maternal_age)]
rm(records,total)
MIG_Dx_third_3[,prevalence_100_pregnancies:=round((no_diagnosed_pregnancies/no_pregnancies)*100,1)]
MIG_Dx_third_3[,no_diagnosed_pregnancies:=as.numeric(no_diagnosed_pregnancies)][,no_pregnancies:=as.numeric(no_pregnancies)]
MIG_Dx_third_3[no_diagnosed_pregnancies != 0 & prevalence_100_pregnancies==0, prevalence_100_pregnancies:=0.0001]
#lower CI
MIG_Dx_third_3[,lower_95_CI:=lower_ci(no_diagnosed_pregnancies,no_pregnancies,prevalence_100_pregnancies)]
MIG_Dx_third_3[,upper_95_CI:=upper_ci(no_diagnosed_pregnancies,no_pregnancies,prevalence_100_pregnancies)]
MIG_Dx_third_3[lower_95_CI<0,lower_95_CI:=0]
pregnancy_d3_mig[,include:=NULL]
rm(MIG_Dx_third)
fwrite(MIG_Dx_third_3,paste0(projectFolder,"/g_output/Migraine algorithm/Step_04_MIG_Dx_third_year_age.csv"),row.names = F)
rm(MIG_Dx_third_3)
#### MIG_Rx_third:Prevalence of migraine during pregnancy when lookback==12 months(3 months) ####
print("Create algorithm MIG_Rx_third")
MIG_Rx_third<-algorithm_template[NEW_STUDY_VARIABLES=="MIG_Rx_third"]
inc_col<-MIG_Rx_third[TYPE=="AND",STUDY_VARIABLES]
if(length(inc_col)>0){pregnancy_d3_mig[pregnancy_d3_mig[,Reduce("&" , lapply(.SD,`>=`, 1)),.SDcols=inc_col] & trimester == 3,include:=1]}else{pregnancy_d3_mig[,include:=NA]}
saveRDS(pregnancy_d3_mig,paste0(projectFolder,"/g_intermediate/migraine_algorithm/final_d3/MIG_Rx_third_D3.rds"))
#export MIG_Rx_third
MIG_Rx_third_dt<-data.table(algorithm="MIG_Rx_third", no_diagnosed_pregnancies=pregnancy_d3_mig[include==1 & !duplicated(pregnancy_id),.N], no_pregnancies=pregnancy_d3_mig[!duplicated(pregnancy_id) & trimester== 3,.N])
MIG_Rx_third_dt[,prevalence_100_pregnancies:=round((no_diagnosed_pregnancies/no_pregnancies)*100,1)]
MIG_Rx_third_dt[,no_diagnosed_pregnancies:=as.numeric(no_diagnosed_pregnancies)][,no_pregnancies:=as.numeric(no_pregnancies)]
#lower CI
MIG_Rx_third_dt[,lower_95_CI:=lower_ci(no_diagnosed_pregnancies,no_pregnancies,prevalence_100_pregnancies)]
MIG_Rx_third_dt[,upper_95_CI:=upper_ci(no_diagnosed_pregnancies,no_pregnancies,prevalence_100_pregnancies)]
MIG_Rx_third_dt[lower_95_CI<0,lower_95_CI:=0]
fwrite(MIG_Rx_third_dt,paste0(projectFolder,"/g_output/Migraine algorithm/Step_04_MIG_Rx_third.csv"),row.names = F)
#by maternal age
pregnancy_d3_mig[,maternal_age:=as.character(maternal_age)]
records<-pregnancy_d3_mig[include==1 & !duplicated(pregnancy_id), .N, by=.(maternal_age)]
names(records)<-c("maternal_age","no_diagnosed_pregnancies")
total<-pregnancy_d3_mig[!duplicated(pregnancy_id) & trimester== 3, by="maternal_age",.N]
names(total)<-c("maternal_age","no_pregnancies")
records<-merge.data.table(records,total,by="maternal_age",all=T)
MIG_Rx_third_1<-data.table(algorithm="MIG_Rx_third", records)
MIG_Rx_third_1[is.na(no_diagnosed_pregnancies),no_diagnosed_pregnancies:=0]
MIG_Rx_third_1<-MIG_Rx_third_1[order(maternal_age)]
rm(records,total)
MIG_Rx_third_1[,prevalence_100_pregnancies:=round((no_diagnosed_pregnancies/no_pregnancies)*100,1)]
MIG_Rx_third_1[,no_diagnosed_pregnancies:=as.numeric(no_diagnosed_pregnancies)][,no_pregnancies:=as.numeric(no_pregnancies)]
MIG_Rx_third_1[no_diagnosed_pregnancies != 0 & prevalence_100_pregnancies==0, prevalence_100_pregnancies:=0.0001]
#lower CI
MIG_Rx_third_1[,lower_95_CI:=lower_ci(no_diagnosed_pregnancies,no_pregnancies,prevalence_100_pregnancies)]
MIG_Rx_third_1[,upper_95_CI:=upper_ci(no_diagnosed_pregnancies,no_pregnancies,prevalence_100_pregnancies)]
MIG_Rx_third_1[lower_95_CI<0,lower_95_CI:=0]
fwrite(MIG_Rx_third_1,paste0(projectFolder,"/g_output/Migraine algorithm/Step_04_MIG_Rx_third_age.csv"),row.names = F)
rm(MIG_Rx_third_1)
#by year
records<-pregnancy_d3_mig[include==1 & !duplicated(pregnancy_id),by="year", .N]
names(records)<-c("year","no_diagnosed_pregnancies")
total<-pregnancy_d3_mig[!duplicated(pregnancy_id) & trimester== 3,by="year",.N]
names(total)<-c("year","no_pregnancies")
records<-merge.data.table(records,total,by="year",all=T)
MIG_Rx_third_2<-data.table(algorithm="MIG_Rx_third", records)
MIG_Rx_third_2[is.na(no_diagnosed_pregnancies),no_diagnosed_pregnancies:=0]
MIG_Rx_third_2<-MIG_Rx_third_2[order(year)]
rm(records,total)
MIG_Rx_third_2[,prevalence_100_pregnancies:=round((no_diagnosed_pregnancies/no_pregnancies)*100,1)]
MIG_Rx_third_2[,no_diagnosed_pregnancies:=as.numeric(no_diagnosed_pregnancies)][,no_pregnancies:=as.numeric(no_pregnancies)]
MIG_Rx_third_2[no_diagnosed_pregnancies != 0 & prevalence_100_pregnancies==0, prevalence_100_pregnancies:=0.0001]
#lower CI
MIG_Rx_third_2[,lower_95_CI:=lower_ci(no_diagnosed_pregnancies,no_pregnancies,prevalence_100_pregnancies)]
MIG_Rx_third_2[,upper_95_CI:=upper_ci(no_diagnosed_pregnancies,no_pregnancies,prevalence_100_pregnancies)]
MIG_Rx_third_2[lower_95_CI<0,lower_95_CI:=0]
fwrite(MIG_Rx_third_2,paste0(projectFolder,"/g_output/Migraine algorithm/Step_04_MIG_Rx_third_year.csv"),row.names = F)
rm(MIG_Rx_third_2)
#by year group and maternal age
records<-pregnancy_d3_mig[include==1 & !duplicated(pregnancy_id),by=c("year_group","maternal_age"), .N]
names(records)<-c("year_group","maternal_age", "no_diagnosed_pregnancies")
total<-pregnancy_d3_mig[!duplicated(pregnancy_id) & trimester== 3,by=c("year_group","maternal_age"),.N]
names(total)<-c("year_group","maternal_age","no_pregnancies")
records<-merge.data.table(records,total,by=c("year_group","maternal_age"), all=T)
MIG_Rx_third_3<-data.table(algorithm="MIG_Rx_third", records)
MIG_Rx_third_3[is.na(no_diagnosed_pregnancies),no_diagnosed_pregnancies:=0]
MIG_Rx_third_3<-MIG_Rx_third_3[order(year_group,maternal_age)]
rm(records,total)
MIG_Rx_third_3[,prevalence_100_pregnancies:=round((no_diagnosed_pregnancies/no_pregnancies)*100,1)]
MIG_Rx_third_3[,no_diagnosed_pregnancies:=as.numeric(no_diagnosed_pregnancies)][,no_pregnancies:=as.numeric(no_pregnancies)]
MIG_Rx_third_3[no_diagnosed_pregnancies != 0 & prevalence_100_pregnancies==0, prevalence_100_pregnancies:=0.0001]
#lower CI
MIG_Rx_third_3[,lower_95_CI:=lower_ci(no_diagnosed_pregnancies,no_pregnancies,prevalence_100_pregnancies)]
MIG_Rx_third_3[,upper_95_CI:=upper_ci(no_diagnosed_pregnancies,no_pregnancies,prevalence_100_pregnancies)]
MIG_Rx_third_3[lower_95_CI<0,lower_95_CI:=0]
pregnancy_d3_mig[,include:=NULL]
fwrite(MIG_Rx_third_3,paste0(projectFolder,"/g_output/Migraine algorithm/Step_04_MIG_Rx_third_year_age.csv"),row.names = F)
rm(MIG_Rx_third_3)
#### MIG_DxRx_third:Prevalence of migraine at baseline when lookback==12 months(3 months) ####
print("Create algorithm MIG_DxRx_third")
MIG_DxRx_third<-algorithm_template[NEW_STUDY_VARIABLES=="MIG_DxRx_third"]
alt_col<-MIG_DxRx_third[TYPE=="OR",STUDY_VARIABLES]
if(length(alt_col)>0){pregnancy_d3_mig[pregnancy_d3_mig[,Reduce("|" , lapply(.SD,`>=`, 1)),.SDcols=alt_col] & trimester==3,alternative:=1]}else{pregnancy_d3_mig[,alternative:=NA]}
saveRDS(pregnancy_d3_mig,paste0(projectFolder,"/g_intermediate/migraine_algorithm/final_d3/MIG_DxRx_third_D3.rds"))
#export MIG_Dx_a
MIG_DxRx_third_dt<-data.table(algorithm="MIG_DxRx_third", no_diagnosed_pregnancies=pregnancy_d3_mig[alternative==1 & !duplicated(pregnancy_id),.N], no_pregnancies=pregnancy_d3_mig[!duplicated(pregnancy_id) & trimester==3,.N])
MIG_DxRx_third_dt[,prevalence_100_pregnancies:=round((no_diagnosed_pregnancies/no_pregnancies)*100,1)]
MIG_DxRx_third_dt[,no_diagnosed_pregnancies:=as.numeric(no_diagnosed_pregnancies)][,no_pregnancies:=as.numeric(no_pregnancies)]
#lower CI
MIG_DxRx_third_dt[,lower_95_CI:=lower_ci(no_diagnosed_pregnancies,no_pregnancies,prevalence_100_pregnancies)]
MIG_DxRx_third_dt[,upper_95_CI:=upper_ci(no_diagnosed_pregnancies,no_pregnancies,prevalence_100_pregnancies)]
MIG_DxRx_third_dt[lower_95_CI<0,lower_95_CI:=0]
fwrite(MIG_DxRx_third_dt,paste0(projectFolder,"/g_output/Migraine algorithm/Step_04_MIG_DxRx_third.csv"),row.names = F)
#by maternal age
pregnancy_d3_mig[,maternal_age:=as.character(maternal_age)]
records<-pregnancy_d3_mig[alternative==1 & !duplicated(pregnancy_id), .N, by=.(maternal_age)]
names(records)<-c("maternal_age","no_diagnosed_pregnancies")
total<-pregnancy_d3_mig[!duplicated(pregnancy_id)& trimester==3, by="maternal_age",.N]
names(total)<-c("maternal_age","no_pregnancies")
records<-merge.data.table(records,total,by="maternal_age",all=T)
MIG_DxRx_third_1<-data.table(algorithm="MIG_DxRx_third", records)
MIG_DxRx_third_1[is.na(no_diagnosed_pregnancies),no_diagnosed_pregnancies:=0]
MIG_DxRx_third_1<-MIG_DxRx_third_1[order(maternal_age)]
rm(records,total)
MIG_DxRx_third_1[,prevalence_100_pregnancies:=round((no_diagnosed_pregnancies/no_pregnancies)*100,1)]
MIG_DxRx_third_1[,no_diagnosed_pregnancies:=as.numeric(no_diagnosed_pregnancies)][,no_pregnancies:=as.numeric(no_pregnancies)]
MIG_DxRx_third_1[no_diagnosed_pregnancies != 0 & prevalence_100_pregnancies==0, prevalence_100_pregnancies:=0.0001]
#lower CI
MIG_DxRx_third_1[,lower_95_CI:=lower_ci(no_diagnosed_pregnancies,no_pregnancies,prevalence_100_pregnancies)]
MIG_DxRx_third_1[,upper_95_CI:=upper_ci(no_diagnosed_pregnancies,no_pregnancies,prevalence_100_pregnancies)]
MIG_DxRx_third_1[lower_95_CI<0,lower_95_CI:=0]
fwrite(MIG_DxRx_third_1,paste0(projectFolder,"/g_output/Migraine algorithm/Step_04_MIG_DxRx_third_age.csv"),row.names = F)
rm(MIG_DxRx_third_1)
#by year
records<-pregnancy_d3_mig[alternative==1 & !duplicated(pregnancy_id),by="year", .N]
names(records)<-c("year","no_diagnosed_pregnancies")
total<-pregnancy_d3_mig[!duplicated(pregnancy_id)& trimester==3,by="year",.N]
names(total)<-c("year","no_pregnancies")
records<-merge.data.table(records,total,by="year",all=T)
MIG_DxRx_third_2<-data.table(algorithm="MIG_DxRx_third", records)
MIG_DxRx_third_2[is.na(no_diagnosed_pregnancies),no_diagnosed_pregnancies:=0]
MIG_DxRx_third_2<-MIG_DxRx_third_2[order(year)]
rm(records,total)
MIG_DxRx_third_2[,prevalence_100_pregnancies:=round((no_diagnosed_pregnancies/no_pregnancies)*100,1)]
MIG_DxRx_third_2[,no_diagnosed_pregnancies:=as.numeric(no_diagnosed_pregnancies)][,no_pregnancies:=as.numeric(no_pregnancies)]
MIG_DxRx_third_2[no_diagnosed_pregnancies != 0 & prevalence_100_pregnancies==0, prevalence_100_pregnancies:=0.0001]
#lower CI
MIG_DxRx_third_2[,lower_95_CI:=lower_ci(no_diagnosed_pregnancies,no_pregnancies,prevalence_100_pregnancies)]
MIG_DxRx_third_2[,upper_95_CI:=upper_ci(no_diagnosed_pregnancies,no_pregnancies,prevalence_100_pregnancies)]
MIG_DxRx_third_2[lower_95_CI<0,lower_95_CI:=0]
fwrite(MIG_DxRx_third_2,paste0(projectFolder,"/g_output/Migraine algorithm/Step_04_MIG_DxRx_third_year.csv"),row.names = F)
rm(MIG_DxRx_third_2)
#by year group and maternal age
records<-pregnancy_d3_mig[alternative==1 & !duplicated(pregnancy_id),by=c("year_group","maternal_age"), .N]
names(records)<-c("year_group","maternal_age", "no_diagnosed_pregnancies")
total<-pregnancy_d3_mig[!duplicated(pregnancy_id)& trimester==3,by=c("year_group","maternal_age"),.N]
names(total)<-c("year_group","maternal_age","no_pregnancies")
records<-merge.data.table(records,total,by=c("year_group","maternal_age"), all=T)
MIG_DxRx_third_3<-data.table(algorithm="MIG_DxRx_third", records)
MIG_DxRx_third_3[is.na(no_diagnosed_pregnancies),no_diagnosed_pregnancies:=0]
MIG_DxRx_third_3<-MIG_DxRx_third_3[order(year_group,maternal_age)]
rm(records,total)
MIG_DxRx_third_3[,prevalence_100_pregnancies:=round((no_diagnosed_pregnancies/no_pregnancies)*100,1)]
MIG_DxRx_third_3[,no_diagnosed_pregnancies:=as.numeric(no_diagnosed_pregnancies)][,no_pregnancies:=as.numeric(no_pregnancies)]
MIG_DxRx_third_3[no_diagnosed_pregnancies != 0 & prevalence_100_pregnancies==0, prevalence_100_pregnancies:=0.0001]
#lower CI
MIG_DxRx_third_3[,lower_95_CI:=lower_ci(no_diagnosed_pregnancies,no_pregnancies,prevalence_100_pregnancies)]
MIG_DxRx_third_3[,upper_95_CI:=upper_ci(no_diagnosed_pregnancies,no_pregnancies,prevalence_100_pregnancies)]
MIG_DxRx_third_3[lower_95_CI<0,lower_95_CI:=0]
pregnancy_d3_mig[,alternative:=NULL]
fwrite(MIG_DxRx_third_3,paste0(projectFolder,"/g_output/Migraine algorithm/Step_04_MIG_DxRx_third_year_age.csv"),row.names = F)
rm(MIG_DxRx_third_3)
date_running_end_04_c<-Sys.Date()
end_time_04_c<-Sys.time()
time_log_04_c<-data.table(DAP=data_access_provider_name,
Script="Step_04_c_migraine_algorithms.R",
Start_date=date_running_start_04_c,
End_date=date_running_end_04_c,
Time_elaspsed=format(end_time_04_c-initial_time_04_c, digits=2))
fwrite(time_log_04_c,paste0(output_dir,"/Time log/Step_04_c_time_log.csv"),row.names = F)
rm(time_log_04_c)
####Clean pregnancies####
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source(paste0(projectFolder,"/p_steps/clean_folders.R"))
source("99_path.R")
setwd(projectFolder)
#Run pregnancy algorithm and save results in g_intermediate/pregnancy_algorithm
source(paste0(pre_dir,"Step_00_create_clean_pregnancy_D3.R"))
render(paste0(pre_dir,"Report_0_pregnancy_algorithm_flowchart.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_0_Pregnancy_algorithm_flowchart.html"))
source(paste0(pre_dir,"save_environment.R"))
####Create pregnancy study population####
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source("99_path.R")
setwd(projectFolder)
#Create study population(persons/observation_periods/pregnancies)
load(paste0(g_intermediate,"environment.RData"))
source(paste0(pre_dir,"Step_01_create_study_population.R"))
render(paste0(pre_dir,"Report_1_pregnancy_study_population.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_1_Pregnancy_study_population.html"))
source(paste0(pre_dir,"save_environment.R"))
####Run diagnostic filtering script####
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source("99_path.R")
setwd(projectFolder)
#Create diagnoses D3(GDM/PE/Migraine)
load(paste0(g_intermediate,"environment.RData"))
source(paste0(pre_dir,"Step_02_diagnoses_clean_up.R"))
source(paste0(pre_dir,"Step_02_diagnoses_clean_up_combine.R"))
render(paste0(pre_dir,"Report_2_diagnoses_clean_up.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_2_Diagnoses_clean_up.html"))
source(paste0(pre_dir,"save_environment.R"))
####Run medicines filtering script####
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source("99_path.R")
setwd(projectFolder)
#Create medicines D3(GDM/PE/Migraine)
load(paste0(g_intermediate,"environment.RData"))
source(paste0(pre_dir,"Step_03_medicines_clean_up.R"))
source(paste0(pre_dir,"Step_03_medicines_clean_up_combine.R"))
render(paste0(pre_dir,"Report_3_medicines_clean_up.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_3_Medicines_clean_up.html"))
source(paste0(pre_dir,"save_environment.R"))
####Create algorithms for GDM/PE/Migraine####
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source("99_path.R")
setwd(projectFolder)
load(paste0(projectFolder,"/g_intermediate/environment.RData"))
source(paste0(pre_dir,"Step_04_algorithms.R"))
render(paste0(pre_dir,"Report_4_gdm_pe_algorithms.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_4_gdm_pe_algorithms.html"))
render(paste0(pre_dir,"Report_4_migraine_algorithms.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_4_migraine_algorithms.html"))
source(paste0(pre_dir,"save_environment.R"))
####Clean pregnancies####
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source(paste0(projectFolder,"/p_steps/clean_folders.R"))
source("99_path.R")
setwd(projectFolder)
#Run pregnancy algorithm and save results in g_intermediate/pregnancy_algorithm
source(paste0(pre_dir,"Step_00_create_clean_pregnancy_D3.R"))
render(paste0(pre_dir,"Report_0_pregnancy_algorithm_flowchart.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_0_Pregnancy_algorithm_flowchart.html"))
source(paste0(pre_dir,"save_environment.R"))
####Create pregnancy study population####
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source("99_path.R")
setwd(projectFolder)
#Create study population(persons/observation_periods/pregnancies)
load(paste0(g_intermediate,"environment.RData"))
source(paste0(pre_dir,"Step_01_create_study_population.R"))
render(paste0(pre_dir,"Report_1_pregnancy_study_population.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_1_Pregnancy_study_population.html"))
source(paste0(pre_dir,"save_environment.R"))
####Run diagnostic filtering script####
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source("99_path.R")
setwd(projectFolder)
#Create diagnoses D3(GDM/PE/Migraine)
load(paste0(g_intermediate,"environment.RData"))
source(paste0(pre_dir,"Step_02_diagnoses_clean_up.R"))
source(paste0(pre_dir,"Step_02_diagnoses_clean_up_combine.R"))
render(paste0(pre_dir,"Report_2_diagnoses_clean_up.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_2_Diagnoses_clean_up.html"))
source(paste0(pre_dir,"save_environment.R"))
####Run medicines filtering script####
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source("99_path.R")
setwd(projectFolder)
#Create medicines D3(GDM/PE/Migraine)
load(paste0(g_intermediate,"environment.RData"))
source(paste0(pre_dir,"Step_03_medicines_clean_up.R"))
source(paste0(pre_dir,"Step_03_medicines_clean_up_combine.R"))
render(paste0(pre_dir,"Report_3_medicines_clean_up.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_3_Medicines_clean_up.html"))
source(paste0(pre_dir,"save_environment.R"))
####Create algorithms for GDM/PE/Migraine####
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source("99_path.R")
setwd(projectFolder)
load(paste0(projectFolder,"/g_intermediate/environment.RData"))
source(paste0(pre_dir,"Step_04_algorithms.R"))
render(paste0(pre_dir,"Report_4_gdm_pe_algorithms.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_4_gdm_pe_algorithms.html"))
render(paste0(pre_dir,"Report_4_migraine_algorithms.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_4_migraine_algorithms.html"))
source(paste0(pre_dir,"save_environment.R"))
