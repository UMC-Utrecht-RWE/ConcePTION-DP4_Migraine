OBS_PER[,op_end_date_max:=as.character()]
op_end_date_max<-max(gdm_pe_end_study_date,mig_end_study_date,du_end_study_date,saf_end_study_date)
end_date_max <- paste0(year(op_end_date_max),sprintf("%02d",month(op_end_date_max)),sprintf("%02d",day(op_end_date_max)))
OBS_PER[, op_end_date_max:= as.character(op_end_date)]
OBS_PER[is.na(op_end_date), op_end_date_max:= as.character(end_date_max)]
print('Set start and end date to date format')
lapply(c("op_start_date","op_end_date","op_end_date_max"), function (x) OBS_PER <- OBS_PER[,eval(x) := as.IDate(as.character(get(x)),"%Y%m%d")])
####Run create spells####
OBS_PER1 <- CreateSpells(
dataset=OBS_PER,
id="person_id" ,
start_date = "op_start_date",
end_date = "op_end_date_max",
overlap = FALSE,
only_overlaps = F
)
original_rows<-OBS_PER[,.N]
#identif duplicated person id
OBS_PER[duplicated(person_id), dup:=1]
OBS_PER<-merge.data.table(OBS_PER[,-dup,with=F], OBS_PER[dup==1,c("person_id","dup")], by="person_id", all.x=T, allow.cartesian = T)
initial_time<-Sys.time()
date_running_start<-Sys.Date()
#Clean folders
unlink(paste0(projectFolder,"/g_intermediate/tmp"), recursive = T)#delete folder
dir.create(paste0(projectFolder, "/g_intermediate/tmp"))
unlink(paste0(projectFolder,"/g_intermediate/pregnancy_d3"), recursive = T)#delete folder
dir.create(paste0(projectFolder, "/g_intermediate/pregnancy_d3"))
unlink(paste0(projectFolder,"/g_output/Pregnancy study population"), recursive = T)#delete folder
dir.create(paste0(projectFolder, "/g_output/Pregnancy study population"))
#Load the Observation periods table
####load info, parameters, conceptsets####
source(paste0(pre_dir,"info/directory_info.R"))
source(paste0(pre_dir,"functions/CreateSpells_v15.R"))
print('Import and append observation periods files')
obs_table_files<-actual_tables$OBSERVATION_PERIODS
OBS_PER<-lapply(paste0(path_dir,obs_table_files),function(x) fread(x, colClasses = "character"))
OBS_PER<-as.data.table(rbindlist(OBS_PER))
OBS_PER[,op_origin:=NULL]
OBS_PER<-OBS_PER[, lapply(.SD, FUN=function(x) gsub("^$|^ $", NA, x))] #make sure missing data is read appropriately
#create an op_end_date_max with the maximum between gdm_pe_end_study_date, mig_end_study_date, du_end_study_date, saf_end_study_date
#create an op_end_date_min with the minimum between gdm_pe_start_study_date, mig_start_study_date, du_start_study_date, saf_start_study_date
#Allows to run the CreateSpells once
OBS_PER[,op_end_date_max:=as.character()]
op_end_date_max<-max(gdm_pe_end_study_date,mig_end_study_date,du_end_study_date,saf_end_study_date)
end_date_max <- paste0(year(op_end_date_max),sprintf("%02d",month(op_end_date_max)),sprintf("%02d",day(op_end_date_max)))
OBS_PER[, op_end_date_max:= as.character(op_end_date)]
OBS_PER[is.na(op_end_date), op_end_date_max:= as.character(end_date_max)]
print('Set start and end date to date format')
lapply(c("op_start_date","op_end_date","op_end_date_max"), function (x) OBS_PER <- OBS_PER[,eval(x) := as.IDate(as.character(get(x)),"%Y%m%d")])
####Run create spells####
OBS_PER1 <- CreateSpells(
dataset=OBS_PER,
id="person_id" ,
start_date = "op_start_date",
end_date = "op_end_date_max",
overlap = FALSE,
only_overlaps = F
)
original_rows<-OBS_PER[,.N]
#identif duplicated person id
OBS_PER[duplicated(person_id), dup:=1]
OBS_PER<-merge.data.table(OBS_PER[,-dup,with=F], OBS_PER[dup==1,c("person_id","dup")], by="person_id", all.x=T, allow.cartesian = T)
initial_time<-Sys.time()
date_running_start<-Sys.Date()
#Clean folders
unlink(paste0(projectFolder,"/g_intermediate/tmp"), recursive = T)#delete folder
dir.create(paste0(projectFolder, "/g_intermediate/tmp"))
unlink(paste0(projectFolder,"/g_intermediate/pregnancy_d3"), recursive = T)#delete folder
dir.create(paste0(projectFolder, "/g_intermediate/pregnancy_d3"))
unlink(paste0(projectFolder,"/g_output/Pregnancy study population"), recursive = T)#delete folder
dir.create(paste0(projectFolder, "/g_output/Pregnancy study population"))
#Load the Observation periods table
####load info, parameters, conceptsets####
source(paste0(pre_dir,"info/directory_info.R"))
source(paste0(pre_dir,"functions/CreateSpells_v15.R"))
print('Import and append observation periods files')
obs_table_files<-actual_tables$OBSERVATION_PERIODS
OBS_PER<-lapply(paste0(path_dir,obs_table_files),function(x) fread(x, colClasses = "character"))
OBS_PER<-as.data.table(rbindlist(OBS_PER))
OBS_PER[,op_origin:=NULL]
OBS_PER<-OBS_PER[, lapply(.SD, FUN=function(x) gsub("^$|^ $", NA, x))] #make sure missing data is read appropriately
#create an op_end_date_max with the maximum between gdm_pe_end_study_date, mig_end_study_date, du_end_study_date, saf_end_study_date
#create an op_end_date_min with the minimum between gdm_pe_start_study_date, mig_start_study_date, du_start_study_date, saf_start_study_date
#Allows to run the CreateSpells once
OBS_PER[,op_end_date_max:=as.character()]
op_end_date_max<-max(gdm_pe_end_study_date,mig_end_study_date,du_end_study_date,saf_end_study_date)
end_date_max <- paste0(year(op_end_date_max),sprintf("%02d",month(op_end_date_max)),sprintf("%02d",day(op_end_date_max)))
OBS_PER[, op_end_date_max:= as.character(op_end_date)]
OBS_PER[is.na(op_end_date), op_end_date_max:= as.character(end_date_max)]
print('Set start and end date to date format')
lapply(c("op_start_date","op_end_date","op_end_date_max"), function (x) OBS_PER <- OBS_PER[,eval(x) := as.IDate(as.character(get(x)),"%Y%m%d")])
####Run create spells####
OBS_PER1 <- CreateSpells(
dataset=OBS_PER,
id="person_id" ,
start_date = "op_start_date",
end_date = "op_end_date_max",
overlap = FALSE,
only_overlaps = F
)
original_rows<-OBS_PER[,.N]
#identif duplicated person id
OBS_PER[duplicated(person_id), dup:=1]
OBS_PER<-merge.data.table(OBS_PER, OBS_PER[dup==1,c("person_id","dup")], by="person_id", all.x=T, allow.cartesian = T)
View(OBS_PER)
OBS_PER[,dup.x:=NULL]
#no_of_subjects with 1 spell
one_spell<-OBS_PER[is.na(dup.y),.N]
one_spell
one_spell_org<-OBS_PER[is.na(dup.y),.N]
more_than_one_org<-OBS_PER[!is.na(dup.y) & !duplicated(person_id),.N]
rm(OBS_PER)
more_than_one_org
one_spell_org
after_run_create_spell<-OBS_PER1[,.N]
after_run_create_spell
OBS_PER1[duplicated(person_id), dup:=1]
OBS_PER1<-merge.data.table(OBS_PER1, OBS_PER1[dup==1,c("person_id","dup")], by="person_id", all.x=T, allow.cartesian = T)
OBS_PER1[,dup.x:=NULL]
one_spell_1<-OBS_PER1[is.na(dup.y),.N]
one_spell_1
more_than_one_1<-OBS_PER1[!is.na(dup.y) & !duplicated(person_id),.N]
more_than_one_1
OBS_PER1[,dup.y:=NULL]
OBS_PER1 <- OBS_PER1[,temp := lapply(.SD, max), by = c("person_id"), .SDcols = "num_spell"][temp == num_spell,][,temp := NULL]
setnames(OBS_PER1, "entry_spell_category", "op_start_date")
setnames(OBS_PER1, "exit_spell_category", "op_end_date")
included_spells<-OBS_PER1[,.N]
OBS_PER1[duplicated(person_id), dup:=1]
OBS_PER1<-merge.data.table(OBS_PER1, OBS_PER1[dup==1,c("person_id","dup")], by="person_id", all.x=T, allow.cartesian = T)
OBS_PER1[,dup.x:=NULL]
one_spell_1a<-OBS_PER1[is.na(dup.y),.N]
more_than_one_1a<-OBS_PER1[!is.na(dup.y) & !duplicated(person_id),.N]
OBS_PER1[,dup.y:=NULL]
one_spell_1a
more_than_one_1a
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source("99_path.R")
setwd(projectFolder)
#Create study population(persons/observation_periods/pregnancies)
load(paste0(g_intermediate,"environment.RData"))
source(paste0(pre_dir,"Step_01_create_study_population.R"))
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source("99_path.R")
setwd(projectFolder)
#Create study population(persons/observation_periods/pregnancies)
load(paste0(g_intermediate,"environment.RData"))
source(paste0(pre_dir,"Step_01_create_study_population.R"))
####Clean pregnancies####
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source(paste0(projectFolder,"/p_steps/clean_folders.R"))
source("99_path.R")
setwd(projectFolder)
#Run pregnancy algorithm and save results in g_intermediate/pregnancy_algorithm
source(paste0(pre_dir,"Step_00_create_clean_pregnancy_D3.R"))
render(paste0(pre_dir,"Report_0_pregnancy_algorithm_flowchart.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_0_Pregnancy_algorithm_flowchart.html"))
source(paste0(pre_dir,"save_environment.R"))
####Create pregnancy study population####
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source("99_path.R")
setwd(projectFolder)
#Create study population(persons/observation_periods/pregnancies)
load(paste0(g_intermediate,"environment.RData"))
source(paste0(pre_dir,"Step_01_create_study_population.R"))
render(paste0(pre_dir,"Report_1_pregnancy_study_population.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_1_Pregnancy_study_population.html"))
render(paste0(pre_dir,"Report_1_pregnancy_study_population.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_1_Pregnancy_study_population.html"))
source(paste0(pre_dir,"save_environment.R"))
####Clean pregnancies####
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source(paste0(projectFolder,"/p_steps/clean_folders.R"))
source("99_path.R")
setwd(projectFolder)
#Run pregnancy algorithm and save results in g_intermediate/pregnancy_algorithm
source(paste0(pre_dir,"Step_00_create_clean_pregnancy_D3.R"))
render(paste0(pre_dir,"Report_0_pregnancy_algorithm_flowchart.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_0_Pregnancy_algorithm_flowchart.html"))
source(paste0(pre_dir,"save_environment.R"))
####Create pregnancy study population####
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source("99_path.R")
setwd(projectFolder)
#Create study population(persons/observation_periods/pregnancies)
load(paste0(g_intermediate,"environment.RData"))
source(paste0(pre_dir,"Step_01_create_study_population.R"))
render(paste0(pre_dir,"Report_1_pregnancy_study_population.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_1_Pregnancy_study_population.html"))
source(paste0(pre_dir,"save_environment.R"))
####Run diagnostic filtering script####
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source("99_path.R")
setwd(projectFolder)
#Create diagnoses D3(GDM/PE/Migraine)
load(paste0(g_intermediate,"environment.RData"))
source(paste0(pre_dir,"Step_02_diagnoses_clean_up.R"))
source(paste0(pre_dir,"Step_02_diagnoses_clean_up_combine.R"))
render(paste0(pre_dir,"Report_2_diagnoses_clean_up.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_2_Diagnoses_clean_up.html"))
source(paste0(pre_dir,"save_environment.R"))
####Run medicines filtering script####
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source("99_path.R")
setwd(projectFolder)
#Create medicines D3(GDM/PE/Migraine)
load(paste0(g_intermediate,"environment.RData"))
source(paste0(pre_dir,"Step_03_medicines_clean_up.R"))
source(paste0(pre_dir,"Step_03_medicines_clean_up_combine.R"))
render(paste0(pre_dir,"Report_3_medicines_clean_up.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_3_Medicines_clean_up.html"))
source(paste0(pre_dir,"save_environment.R"))
####Create algorithms for GDM/PE/Migraine####
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source("99_path.R")
setwd(projectFolder)
load(paste0(g_intermediate,"environment.RData"))
source(paste0(pre_dir,"Step_04_algorithms.R"))
render(paste0(pre_dir,"Report_4_gdm_pe_algorithms.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_4_gdm_pe_algorithms.html"))
#render(paste0(pre_dir,"Report_4_migraine_algorithms.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_4_migraine_algorithms.html"))
source(paste0(pre_dir,"save_environment.R"))
codesheet_diagnoses_gdm
events_gdm_diagnoses
####Clean pregnancies####
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source(paste0(projectFolder,"/p_steps/clean_folders.R"))
source("99_path.R")
setwd(projectFolder)
#Run pregnancy algorithm and save results in g_intermediate/pregnancy_algorithm
source(paste0(pre_dir,"Step_00_create_clean_pregnancy_D3.R"))
render(paste0(pre_dir,"Report_0_pregnancy_algorithm_flowchart.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_0_Pregnancy_algorithm_flowchart.html"))
source(paste0(pre_dir,"save_environment.R"))
####Create pregnancy study population####
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source("99_path.R")
setwd(projectFolder)
#Create study population(persons/observation_periods/pregnancies)
load(paste0(g_intermediate,"environment.RData"))
source(paste0(pre_dir,"Step_01_create_study_population.R"))
render(paste0(pre_dir,"Report_1_pregnancy_study_population.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_1_Pregnancy_study_population.html"))
source(paste0(pre_dir,"save_environment.R"))
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source("99_path.R")
setwd(projectFolder)
#Create diagnoses D3(GDM/PE/Migraine)
load(paste0(g_intermediate,"environment.RData"))
initial_time<-Sys.time()
date_running_start<-Sys.Date()
#Clean folders
unlink(paste0(projectFolder,"/g_intermediate/tmp"), recursive = T)#delete folder
dir.create(paste0(projectFolder, "/g_intermediate/tmp"))
unlink(paste0(projectFolder,"/g_intermediate/gdm_algorithm"), recursive = T)#delete folder
dir.create(paste0(projectFolder, "/g_intermediate/gdm_algorithm"))
unlink(paste0(projectFolder,"/g_intermediate/pe_algorithm"), recursive = T)#delete folder
dir.create(paste0(projectFolder, "/g_intermediate/pe_algorithm"))
unlink(paste0(projectFolder,"/g_intermediate/migraine_algorithm"), recursive = T)#delete folder
dir.create(paste0(projectFolder, "/g_intermediate/migraine_algorithm"))
unlink(paste0(projectFolder,"/g_output/PE and GDM algorithm"), recursive = T)#delete folder
dir.create(paste0(projectFolder, "/g_output/PE and GDM algorithm"))
unlink(paste0(projectFolder,"/g_output/Migraine algorithm"), recursive = T)#delete folder
dir.create(paste0(projectFolder, "/g_output/Migraine algorithm"))
#Load EVENTS table and apply filter to select PE diagoses/GDM diagnoses/Migraine diagnoses
####load info, parameters, conceptsets####
source(paste0(pre_dir,"info/directory_info.R"))
source(paste0(pre_dir,"info/DAP_info.R"))
source(paste0(pre_dir,"codelists/create_conceptsets.R"))
source(paste0(pre_dir,"parameters/parameters_metadata.R"))
source(paste0(pre_dir,"parameters/study_parameters.R"))
Indication<-c("start_coverage", "end_coverage", "minimum_start_pregnancy_date", "maxiumum_start_pregnancy_date","minimum_start_pregnancy_date_5_years")
GDM_and_PE<-c(gdm_pe_start_study_date,gdm_pe_end_study_date,min_preg_date_gdm_pe,max_preg_date_gdm_pe, ifelse(!is.null(gdm_pe_start_preg_lookback),gdm_pe_start_preg_lookback,NA))
Migraine<-c(mig_start_study_date,mig_end_study_date,min_preg_date_mig,max_preg_date_mig, ifelse(!is.null(mig_start_preg_lookback),mig_start_preg_lookback,NA))
Drug_utilisation<-c(du_start_study_date,du_end_study_date,min_preg_date_du,max_preg_date_du, ifelse(!is.null(du_start_preg_lookback),du_start_preg_lookback,NA))
Safety<-c(saf_start_study_date,saf_end_study_date,min_preg_date_saf,max_preg_date_saf, ifelse(!is.null(saf_start_preg_lookback),saf_start_preg_lookback,NA))
dates_flowchart<-data.table(Indication,GDM_and_PE,Migraine,Drug_utilisation,Safety)
fwrite(dates_flowchart,paste0(output_dir, "PE and GDM algorithm/inclusion_dates_flowchart.csv"), row.names = F)
fwrite(dates_flowchart,paste0(output_dir, "Migraine algorithm/inclusion_dates_flowchart.csv"), row.names = F)
events_gdm_diagnoses<-ifelse("EVENTS" %in% codesheet_diagnoses_gdm[,table],1,0)
mo_gdm_diagnoses<-ifelse("MEDICAL_OBSERVATIONS" %in% c(codesheet_diagnoses_gdm[,table],codesheet_diagnoses_gdm_cat[,table]),1,0)
so_gdm_diagnoses<-ifelse("SURVEY_OBSERVATIONS" %in% c(codesheet_diagnoses_gdm[,table],codesheet_diagnoses_gdm_cat[,table]),1,0)
events_pe_diagnoses<-ifelse("EVENTS" %in% codesheet_diagnoses_pe[,table],1,0)
mo_pe_diagnoses<-ifelse("MEDICAL_OBSERVATIONS" %in% c(codesheet_diagnoses_pe[,table],codesheet_diagnoses_pe_cat[,table]),1,0)
so_pe_diagnoses<-ifelse("SURVEY_OBSERVATIONS" %in% c(codesheet_diagnoses_pe[,table],codesheet_diagnoses_pe_cat[,table]),1,0)
events_migraine_diagnoses<-ifelse("EVENTS" %in% codesheet_diagnoses_migraine[,table],1,0)
mo_migraine_diagnoses<-ifelse("MEDICAL_OBSERVATIONS" %in% c(codesheet_diagnoses_migraine[,table],codesheet_diagnoses_migraine_cat[,table]),1,0)
so_migraine_diagnoses<-ifelse("SURVEY_OBSERVATIONS" %in% c(codesheet_diagnoses_migraine[,table],codesheet_diagnoses_migraine_cat[,table]),1,0)
if("code" %in% codesheet_diagnoses_gdm[table=="EVENTS",val_1]){
code_var<-codesheet_diagnoses_gdm[table=="EVENTS",col_1]
voc_var<-codesheet_diagnoses_gdm[table=="EVENTS",col_2]
date_var<-codesheet_diagnoses_gdm[table=="EVENTS",date_column]
}else{
code_var<-codesheet_diagnoses_gdm[table=="EVENTS",col_2]
voc_var<-codesheet_diagnoses_gdm[table=="EVENTS",col_1]
date_var<-codesheet_diagnoses_gdm[table=="EVENTS",date_column]
}
if("code" %in% codesheet_diagnoses_pe[table=="EVENTS",val_1]){
code_var<-codesheet_diagnoses_pe[table=="EVENTS",col_1]
voc_var<-codesheet_diagnoses_pe[table=="EVENTS",col_2]
date_var<-codesheet_diagnoses_pe[table=="EVENTS",date_column]
}else{
code_var<-codesheet_diagnoses_pe[table=="EVENTS",col_2]
voc_var<-codesheet_diagnoses_pe[table=="EVENTS",col_1]
date_var<-codesheet_diagnoses_pe[table=="EVENTS",date_column]
}
if("code" %in% codesheet_diagnoses_migraine[table=="EVENTS",val_1]){
code_var<-codesheet_diagnoses_migraine[table=="EVENTS",col_1]
voc_var<-codesheet_diagnoses_migraine[table=="EVENTS",col_2]
date_var<-codesheet_diagnoses_migraine[table=="EVENTS",date_column]
}else{
code_var<-codesheet_diagnoses_migraine[table=="EVENTS",col_2]
voc_var<-codesheet_diagnoses_migraine[table=="EVENTS",col_1]
date_var<-codesheet_diagnoses_migraine[table=="EVENTS",date_column]
}
original_rows_gdm_pe<-list() #number of table original rows
original_rows_mig<-list() #number of table original rows
empty_event_date_gdm_pe<-list() #number of records with missing event date
empty_event_date_mig<-list() #number of records with missing event date
empty_event_code_gdm_pe<-list() #numer of records with missing event code
empty_event_code_mig<-list() #numer of records with missing event code
empty_event_vocabulary_gdm_pe<-list() #numer of records with missing event vocabulary
empty_event_vocabulary_mig<-list() #numer of records with missing event vocabulary
empty_event_meaning_gdm_pe<-list() #numer of records with missing event meaning
empty_event_meaning_mig<-list() #numer of records with missing event meaning
prior_diagnoses_rec_gdm_pe<-list() #number of records with date prior to start study date - 365 days
prior_diagnoses_rec_mig<-list() #number of records with date prior to start study date - 365 days
after_diagnoses_rec_gdm_pe<-list() #number of records with date after end study date
after_diagnoses_rec_mig<-list() #number of records with date after end study date
included_records_filtering_gdm_pe<-list()
included_records_filtering_mig<-list()
w<-1
y<-1
print(paste0("Analyzing table ",actual_tables$EVENTS[y], "."))
#Load the table
df<-fread(paste(path_dir, actual_tables$EVENTS[y], sep=""), stringsAsFactors = FALSE, colClasses = "character")
cols<-c("person_id", "meaning_of_event", code_var, voc_var, date_var)
df<-df[,cols, with=F]
df<-df[, lapply(.SD, FUN=function(x) gsub("^$|^ $", NA, x))] #make sure missing data is read appropriately
setnames(df,"meaning_of_event","meaning")
setnames(df, date_var,"event_date")
setnames(df, code_var,"event_code")
setnames(df, voc_var,"event_vocabulary")
original_rows_gdm_pe[[w]]<-df[,.N]
original_rows_mig[[w]]<-df[,.N]
empty_event_date_gdm_pe[[w]]<-df[is.na(event_date),.N]
empty_event_date_mig[[w]]<-df[is.na(event_date),.N]
df<-df[!is.na(event_date)]
#remove empty codes
empty_event_code_gdm_pe[[w]]<-df[is.na(event_code),.N]
empty_event_code_mig[[w]]<-df[is.na(event_code),.N]
df<-df[!is.na(event_code)]
empty_event_vocabulary_gdm_pe[[w]]<-df[is.na(event_vocabulary),.N]
empty_event_vocabulary_mig[[w]]<-df[is.na(event_vocabulary),.N]
df<-df[!is.na(event_vocabulary)]
#empty meaning
empty_event_meaning_gdm_pe[[w]]<-df[is.na(meaning),.N]
empty_event_meaning_mig[[w]]<-df[is.na(meaning),.N]
df<-df[!is.na(meaning)]
df[,event_date:=as.IDate(event_date,"%Y%m%d")] #transform to date variables
#create year variable
df[,year:=year(event_date)]
#remove all records with dates prior to start study date or start study date plus lookback if any
df[,prior_gdm_pe:=ifelse(gdm_pe_start_study_date>event_date,1,0)]
prior_diagnoses_rec_gdm_pe[[w]]<-df[prior_gdm_pe==1,.N]
gdm_pe_start_study_date
df[,prior_mig:=ifelse(mig_start_study_date>event_date,1,0)]
prior_diagnoses_rec_mig[[w]]<-df[prior_mig==1,.N]
mig_start_study_date
du_start_study_date
saf_start_study_date
df[,prior_du:=ifelse(du_start_study_date>event_date,1,0)]
df[,prior_saf:=ifelse(saf_start_study_date>event_date,1,0)]
df<-df[prior_gdm_pe==0|prior_mig==0|prior_du==0|prior_saf==0]
df[,after_gdm_pe:=ifelse(gdm_pe_end_study_date<event_date,1,0)]
after_diagnoses_rec_gdm_pe[[w]]<-df[after_gdm_pe==1 & prior_gdm_pe==0,.N]
#migraine
df[,after_mig:=ifelse(mig_end_study_date<event_date,1,0)]
after_diagnoses_rec_mig[[w]]<-df[after_mig==1 & prior_mig==0,.N]
#Check if the data needed for the drug utilization and safety study has a longer follow up
df[,after_du:=ifelse(du_end_study_date<event_date,1,0)]
df[,after_saf:=ifelse(saf_end_study_date<event_date,1,0)]
#clean up dataset:keep records when at least one is zero
df<-df[after_gdm_pe==0|after_mig==0|after_du==0|after_saf==0]
df[,code_no_dot:=as.character(gsub("\\.","",df[,event_code]))]
included_records_filtering_gdm_pe[[w]]<-df[prior_gdm_pe==0 & after_gdm_pe==0,.N]
included_records_filtering_mig[[w]]<-df[prior_mig==0 & after_mig==0,.N]
years_study_events<-sort(df[prior_gdm_pe==0 & after_gdm_pe==0][!duplicated(year), year])#years present in this table
years_study_events
vocabularies_list_gdm
i<-1
j<-1
codes<-data.table(event_vocabulary=names(conditions_gdm[[i]])[j], truncated_code=conditions_gdm[[i]][[j]], filter=1)
codes
####Run diagnostic filtering script####
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source("99_path.R")
setwd(projectFolder)
#Create diagnoses D3(GDM/PE/Migraine)
load(paste0(g_intermediate,"environment.RData"))
source(paste0(pre_dir,"Step_02_diagnoses_clean_up.R"))
source(paste0(pre_dir,"Step_02_diagnoses_clean_up_combine.R"))
render(paste0(pre_dir,"Report_2_diagnoses_clean_up.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_2_Diagnoses_clean_up.html"))
source(paste0(pre_dir,"save_environment.R"))
####Run medicines filtering script####
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source("99_path.R")
setwd(projectFolder)
#Create medicines D3(GDM/PE/Migraine)
load(paste0(g_intermediate,"environment.RData"))
source(paste0(pre_dir,"Step_03_medicines_clean_up.R"))
source(paste0(pre_dir,"Step_03_medicines_clean_up_combine.R"))
render(paste0(pre_dir,"Report_3_medicines_clean_up.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_3_Medicines_clean_up.html"))
source(paste0(pre_dir,"save_environment.R"))
rm(list=ls())
if(!require(rstudioapi)){install.packages("rstudioapi")}
library(rstudioapi)
projectFolder<-dirname(rstudioapi::getSourceEditorContext()$path)
setwd(projectFolder)
source("packages.R")
source("99_path.R")
setwd(projectFolder)
load(paste0(g_intermediate,"environment.RData"))
source(paste0(pre_dir,"Step_04_algorithms.R"))
render(paste0(pre_dir,"Report_4_gdm_pe_algorithms.Rmd"), output_dir = output_dir, output_file = paste0(format(Sys.Date(), "%Y"),format(Sys.Date(), "%m"),format(Sys.Date(), "%d"),"_",data_access_provider_name,"_", "Report_4_gdm_pe_algorithms.html"))
obs_period<-data.table(StudyVar=c("MG","MG_NO_AURA","MG_AURA","MG_STATUS","OTHER_MG","UNSP_MG","COMP_MG"),
lookback=c(0,0,0,0,0,0,0),
start_date=c(0,0,0,0,0,0,0),
end_date=c(7*40,7*40,7*40,7*40,7*40,7*40,7*40),
after=c(0,0,0,0,0,0,0))
mig_files<-list.files(paste0(projectFolder,"/g_intermediate/migraine_algorithm/"))
mig_files
mig_files<-mig_files[!mig_files %in% "Migraine_medicines.rds"]
names_events<-list()
for(i in 1:length(mig_files)){
names_events[[i]]<-unlist(str_split(mig_files[i],"[.]"))[1]
}
names_events<-as.vector(do.call(rbind,names_events))
original<-list()
before<-list()
after<-list()
sum<-list()
dir.create(paste0(projectFolder,"/g_intermediate/migraine_algorithm/final_d3"))
#Load all migraine_algorithm file and combine with the pregnancy D3
pregnancy_d3_migraine<-readRDS(paste0(projectFolder,"/g_intermediate/pregnancy_d3/Migraine_Pregnancy_D3.rds"))
pregnancy_d3_mig<-readRDS(paste0(projectFolder,"/g_intermediate/pregnancy_d3/MIG_Pregnancy_D3.rds"))
pregnancy_d3_mig[,pregnancy_start_date:=as.IDate(pregnancy_start_date)][,pregnancy_end_date:=as.IDate(pregnancy_end_date)][,birth_date:=as.IDate(birth_date)][,death_date:=as.IDate(death_date)][,op_start_date_gdm_pe:=as.IDate(op_start_date_gdm_pe)][,op_end_date_gdm_pe:=as.IDate(op_end_date_gdm_pe)]
pregnancy_d3_mig[,age:=floor((pregnancy_start_date-birth_date)/365.25)]
pregnancy_d3_mig[,maternal_age:=as.character(lapply(age, age_band_creation))]
pregnancy_d3_mig[,year:=year(pregnancy_start_date)]
pregnancy_d3_mig[,year_group:=as.character(lapply(year, year_group_creation))]
View(pregnancy_d3_mig)
